/*1336720334,176833974*/

if (window.CavalryLogger) { CavalryLogger.start_js(["pz9Q8"]); }

function AsyncLayout(){}AsyncLayout.prototype={init:function(b,a,c,d){this.canvas_id=b.id;if(a)this.auxiliary_id=a.id;if(c)this.header_id=c.id;if(d)this.toolbar_id=d.id;this.auxEndpoints={};this.waitingForAux=false;PageTransitions.registerHandler(this.catchPageTransition.bind(this));this.subscription=Arbiter.subscribe(NavigationMessage.NAVIGATION_BEGIN,this.onNavigate.bind(this));this.auxSubscription=Arbiter.subscribe(NavigationMessage.REFRESH_RIGHT_COLUMN,this.refreshRightColumn.bind(this));return this;},catchPageTransition:function(a){Arbiter.unsubscribe(this.subscription);Arbiter.unsubscribe(this.auxSubscription);return false;},setAuxiliaryEndpoints:function(b){for(var a in b)this.auxEndpoints[a]=b[a];},getCanvasID:function(a){return this.customCanvasID?this.customCanvasID:(a.sidecol?'contentCol':'contentArea');},onNavigate:function(d,a){var e=a.useAjaxPipe&&AjaxPipeRequest.isActiveOnPage(a.params.endpoint);a=a.params;if(a.endpoint){if(this.request){this.request.setFinallyHandler(bagofholding);this.request.abort();}if(this.sideRequest)this.sideRequest.abort();if(e){this.request=new AjaxPipeRequest().setURI(a.endpoint).setData(a).setCanvasId(this.getCanvasID(a)).setFinallyHandler(this.finallyHandler.bind(this)).setErrorHandler(this.errorHandler.bind(this)).send();}else{a.handled=true;var b=false;if(a.prefetch){b=true;delete a.prefetch;}this.waitingForAux=a.sidecol;if(a.sidecol&&!b)this.refreshRightColumn(d,a);var f=!!a.iframe;var c=new AsyncRequest().setOption('useIframeTransport',f).setURI(new URI(a.endpoint)).setReadOnly(true).setMethod('GET').setData(a).setPrefetch(b).setHandler(this.onResponse.bind(this)).setFinallyHandler(this.finallyHandler.bind(this));if(!b){c.setErrorHandler(this.errorHandler.bind(this));this.request=c;}c.send();}}},refreshRightColumn:function(b,a){if(a.key&&this.auxEndpoints[a.endpoint]){this.sideRequest=new AsyncRequest(this.auxEndpoints[a.endpoint]).setData({key:a.key}).setHandler(this.onSideResponse.bind(this));this.sideRequest.send();}},onSideResponse:function(b){var a=b.getPayload();if(a&&this.auxiliary_id)this.receivedAux(a);},receivedAux:function(a){!this.waitingForAux;this.waitingForAux=false;DOM.setContent($(this.auxiliary_id),HTML(a));},onResponse:function(e){var d=e.getPayload();if(d.redirect){goURI(d.redirect);}else{var c=d.html||d;DOM.setContent($(this.canvas_id),HTML(c));if(d.side_html&&this.auxiliary_id)this.receivedAux(d.side_html);if(this.header_id&&!d.keep_header){var b=$(this.header_id);DOM.setContent(b,HTML(d.header_html||''));CSS.conditionShow(b,d.header_html);}if(d.toolbar_html&&this.toolbar_id)DOM.setContent($(this.toolbar_id),HTML(d.toolbar_html));if(d.js)(new Function(d.js))();CSS.conditionClass('contentCol','hasRightCol',this.auxiliary_id&&!d.noRightSide);var f=ge('rightCol');if(f&&d.noRightSide)DOM.empty(f);}var a=e.getRequest().getData();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED,a.key);},errorHandler:function(a){AsyncResponse.verboseErrorHandler(a);Arbiter.inform(NavigationMessage.NAVIGATION_FAILED);this.request=null;},finallyHandler:function(a){this.request=null;PageTransitions.transitionComplete();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}};
function SideNav(){SideNav.instance=this;}SideNav.instance=null;SideNav.getInstance=function(){if(SideNav.instance===null)return new SideNav();return SideNav.instance;};SideNav.prototype={init:function(c,a,b,d,e){this.selectedKey=d;this.loadingKey=null;this.loadingNode=null;this.editNav={};this.path=URI.getRequestURI().getPath();this.domain=URI.getRequestURI().getDomain();this.navData={};this.root=c;this.defaultKey=a;this.endpoints=b;this.keyParam='sk';this.useAjaxPipe=e;PageTransitions.registerHandler(this.catchPageTransition.bind(this));Arbiter.subscribe(NavigationMessage.NAVIGATION_COMPLETED,this.navigationComplete.bind(this));Arbiter.subscribe(NavigationMessage.NAVIGATION_FAILED,this.navigationFailed.bind(this));Arbiter.subscribe(NavigationMessage.NAVIGATION_COUNT_UPDATE,this.navigationCountUpdate.bind(this));Arbiter.subscribe(NavigationMessage.NAVIGATION_SELECT,this.navigationSelect.bind(this));if(this.selectedKey){Arbiter.inform('SideNav.selectedKey',this.selectedKey,Arbiter.BEHAVIOR_STATE);}else{selected=Arbiter.query('SideNav.selectedKey');if(selected){data={asLoading:false};data[this.keyParam]=selected;this.navigationSelect(null,data);}}Event.listen(this.root,'click',(function(event){var f=event.getTarget();if(CSS.hasClass(f,'uiCloseButton')&&f.parentNode.tagName=='LI'){CSS.hide(Parent.byTag(f,'li'));return;}if(!(CSS.hasClass(f,'navMoreLess')||CSS.hasClass(f,'navEditDone')))f=Parent.byTag(f,'a');if(f&&CSS.hasClass(f,'navEditDone'))this.toggleSortMode(DOM.find(Parent.byClass(f,'expandedMode'),'ul.uiSideNav'),f.getAttribute('data-endpoint'));}).bind(this));},addEndpoints:function(a){this.endpoints=merge(this.endpoints,a);},updateCloseButtons:function(b,a){DOM.scry(b,'span.buttonWrap').each((function(c){Event.listen(c,'click',(function(event){var d=Parent.byClass(event.getTarget(),'uiCloseButton');if(d){d=DOM.find(d,'input');Form.bootstrap(d.form,d);if(a)CSS.hide(Parent.byTag(d,'li'));}Event.kill(event);}).bind(this));CSS.show(c);}).bind(this));},getEndpoint:function(a){return this.endpoints?this.endpoints[a]||this.endpoints:'';},catchPageTransition:function(c){var b=c.getQueryData(),a=this.resolveKey(b[this.keyParam],c);if(a===false)return false;if(a===undefined)a=this.defaultKey;this.loadKey(a);return this.handlePageTransition(b,a);},resolveKey:function(a,b){if(this.path!=b.getPath()||this.domain!=b.getDomain())return false;return a;},loadKey:function(b,c){var a=DOM.scry(this.root,'li.key-'+b);this.loadingNode&&!c&&CSS.removeClass(this.loadingNode,'loading');this.loadingKey=b;if(a.length){this.loadingNode=a[0];!c&&CSS.addClass(this.loadingNode,'loading');}else this.loadingNode=null;this.refreshRightColumn=this.shouldRefreshRightColumn(this.loadingNode,b);},shouldRefreshRightColumn:function(b,a){return b&&this.isTopLevelNode(b);},handlePageTransition:function(c,b){var a=this.getEndpoint(b);if(!(typeof a=='string'))return false;copy_properties(c,{key:b,endpoint:a,sidecol:this.refreshRightColumn});c={params:c};c.useAjaxPipe=this.useAjaxPipe||c.params.ap;Arbiter.inform(NavigationMessage.NAVIGATION_BEGIN,c);return true;},isTopLevelNode:function(a){return (a&&a.firstChild&&(CSS.hasClass(a.firstChild,'item')||CSS.hasClass(a.firstChild,'inputsearch')));},navigationSelect:function(c,a){var b=a[this.keyParam];if(b!==undefined){this.loadKey(b);if(!a.asLoading)this.navigationComplete();}},navigationFailed:function(){CSS.removeClass(this.loadingNode,'loading');this.loadingNode=null;},navigationComplete:function(){if(this.loadingKey)DOM.scry(this.root,'li.selectedItem').each(function(c){CSS.removeClass(c,'selectedItem');});if(this.loadingNode){CSS.removeClass(this.loadingNode,'loading');var b=null;if(this.isTopLevelNode(this.loadingNode)){b=this.loadingNode;}else b=this.loadingNode.parentNode.parentNode;if(!CSS.hasClass(b,'open')){DOM.scry(this.root,'li.open').each(function(c){CSS.removeClass(c,'open');});CSS.addClass(b,'open');}CSS.addClass(this.loadingNode,'selectedItem');var a=CSS.hasClass(this.loadingNode,'hider');DOM.scry(this.root,'div.navFold').forEach(function(c){CSS.conditionClass(c,'hideContent',a);});if(CSS.hasClass(this.loadingNode,'expander'))CSS.addClass(Parent.byClass(this.loadingNode,'expandableSideNav'),'expandedMode');this.selectedKey=this.loadingKey;Arbiter.inform('SideNav.selectedKey',this.selectedKey,Arbiter.BEHAVIOR_STATE);this.loadingNode=null;this.loadingKey=null;}},navigationCountUpdate:function(f,d){if(!d||!d['key']||d.count===undefined)return;var e=DOM.find(this.root,'li.key-'+d.key);var b=DOM.scry(e,'span.count');if(b){var a=b[0];var c=DOM.find(e,'span.countValue');if(c){if(d.count<0){d.count+=parseInt(DOM.getText(c),10);d.count=Math.max(d.count,0);}DOM.setContent(c,d.count);}CSS.conditionClass(a,'hidden_elem',!d['count']);}},toggleSortMode:function(c,a){if(!this.editNav[c]){Bootloader.loadComponents('sortable-side-nav-js',this.initializeSortable.bind(this,c,a));}else{var d=c.parentNode,b=this.editNav[c].inEditMode();CSS.conditionClass($('sideNav'),'editMode',!b);this.editNav[c][(b?'endEdit':'beginEdit')]();}return false;},initializeSortable:function(b,a){this.editNav[b]=new SortableSideNav(b,a);this.toggleSortMode(b);}};
function ProfileSideNav(){this.parent.construct(this);}ProfileSideNav.extend('SideNav');ProfileSideNav.prototype={keyParam:'sk',altKeyParam:'v',init:function(c,a,b,d){this.parent.init(c,a,b,d,true);this.queryData=URI.getRequestURI().getQueryData();if(b&&this.ajaxLoadKey)onloadRegister(this.handlePageTransition.bind(this,this.queryData,this.ajaxLoadKey));},setTabsAndKey:function(b,a){this.FBTabs=b;this.ajaxLoadKey=a;},isFBTab:function(a){return this.FBTabs&&this.FBTabs.contains(a);},handlePageTransition:function(e,d){var b=this.getEndpoint(d)[0];if(typeof b!='string')return false;var c=!this.isFBTab(d);if(c){if(!CSS.hasClass(document.body,'thirdParty'))return false;}else if(CSS.hasClass(document.body,'thirdParty'))return false;copy_properties(e,{endpoint:b,sidecol:false});e[this.keyParam]=d;var a={params:e,useAjaxPipe:true};Arbiter.inform(NavigationMessage.NAVIGATION_BEGIN,a);return true;},resolveKey:function(a,c){if(a==undefined){var b=c.getQueryData();a=b[this.altKeyParam];}return this.parent.resolveKey(a,c);},catchPageTransition:function(c){var d=c.getQueryData();if(this.queryData&&d&&this.queryData.id!=d.id)return false;var b=this.queryData&&this.queryData.viewas;var a=d&&d.viewas;if(b!=a)return false;return this.parent.catchPageTransition(c);}};
function OnVisible(b,c,f,a,d){d=d||{};this.targetY=Vector2.getElementPosition(b).y;this.buffer=coalesce(a,300);this.lastY=Vector2.getScrollPosition().y;this.lastTime=(+new Date());var e=function(){var l=Vector2.getScrollPosition().y;var j=Vector2.getViewportDimensions().y;var k=l+j+this.buffer;var i=!f||(Vector2.getScrollPosition().y-this.buffer<(this.targetY+Vector2.getElementDimensions(b).y));if(i&&(k>this.targetY)){this.remove();if(d.detect_speed){var g=(l-this.lastY);var h=g/((+new Date())-this.lastTime+1);if((h>j/100)||(k>=Vector2.getDocumentDimensions().y&&g>1000))return true;}c();}if(d.detect_speed){this.lastY=l;this.lastTime=(+new Date());}return true;}.bind(this);this.scrollListener=Event.listen(window,'scroll',e);this.resizeListener=Event.listen(window,'resize',e);e();onleaveRegister(this.remove.bind(this));}copy_properties(OnVisible.prototype,{remove:function(){if(this.scrollListener){this.scrollListener.remove();this.resizeListener.remove();this.scrollListener=this.resizeListener=null;}}});
var PhotoInlineCaptionEditor=function(a){this.instanceId=a;PhotoInlineCaptionEditor.instances[a]=this;};copy_properties(PhotoInlineCaptionEditor,{instances:{},getInstance:function(a){return this.instances[a];}});PhotoInlineCaptionEditor.prototype={init:function(a){this.element=a;Event.listen(a,'click',this.handleClick.bind(this));var b=DOM.scry(a,'input[name="caption_id"]');if(b.length)b[0].value=this.instanceId;},handleClick:function(event){var a=event.getTarget();if(Parent.byClass(a,'editIcon')||Parent.byClass(a,'noCaption')){this.toggleEditDescription(true);}else if(Parent.byClass(a,'cancelEdit')){Input.setValue(DOM.find(this.element,'textarea.fbPhotoCaptionInput'),this.getCaption());this.toggleEditDescription(false);}},setCaption:function(a){DOM.setContent(DOM.find(this.element,'.fbPhotoCaption'),a);this.toggleEditDescription(false);},getCaption:function(){return DOM.getText(DOM.find(this.element,'.fbPhotoCaption'));},toggleEditDescription:function(c){if(!c)DOM.find(this.element,'textarea.fbPhotoCaptionInput').blur();CSS.conditionClass(this.element,'fbPhotoInlineCaptionEditorEditMode',!!c);if(c){var b=DOM.find(this.element,'textarea.fbPhotoCaptionInput');var a=DOMControl.getInstance(b);a&&a.update();b.focus();}else CSS.conditionClass(DOM.find(this.element,'.noCaption'),'hidden_elem',this.getCaption().length);}};
function PhotoTheaterLog(){}copy_properties(PhotoTheaterLog,{UNKNOWN:0,ESC:1,X:2,OUTSIDE:3,UNLOAD:4,NAVIGATE:5,AGGREGATE:6,AGGREGATION_COUNT:20,set:null,time:null,views:0,fbidList:[],width:0,height:0,first:false,last:false,logIds:false,initLogging:function(){this.set=null;this.time=new Date();this.views=1;this.first=true;this.last=false;this.logIds=false;var a=Vector2.getViewportDimensions();this.width=a.x;this.height=a.y;},setLogFbids:function(a){this.logIds=a;},setPhotoSet:function(a){this.set=a;},addPhotoView:function(a){if(this.logIds&&this.views>=this.AGGREGATION_COUNT)this.logPhotoViews(this.AGGREGATE);this.views++;this.addPhotoFbid(a);},addPhotoFbid:function(a){if(this.logIds&&a)this.fbidList.push(a);},logPhotoViews:function(a){if(this.views){var c=Vector2.getViewportDimensions();if(a!=this.AGGREGATE)this.last=true;var b={set:this.set,time:new Date()-this.time,views:this.views,fbids:this.fbidList,width:c.x||this.width,height:c.y||this.height,first:this.first,last:this.last,close:a?a:this.UNKNOWN};new AsyncRequest().setURI('/ajax/photos/theater/session_logging.php').setAllowCrossPageTransition(true).setOption('asynchronous',false).setOption('suppressCacheInvalidation',true).setOption('suppressErrorHandlerWarning',true).setData(b).send();this.views=0;this.fbidList=[];this.first=false;if(this.last){this.set=null;this.logIds=false;}}}});onunloadRegister(function(){PhotoTheaterLog.logPhotoViews(PhotoTheaterLog.UNLOAD);});
var PhotoTheater={OPEN:'PhotoTheater.OPEN',CLOSE:'PhotoTheater.CLOSE',PAGE:'PhotoTheater.PAGE',RESET_HELP:'PhotoTheater.RESET_HELP',GO:'PhotoTheater.GO',DATA_CHANGE:'PhotoTheater.DATA_CHANGE',BUCKET_SIZE:15,BUFFER_PERCENT:1/3,PRELOAD_BUFFER:5,ADS_REFRESH_RATE:30000,LOADING_IMAGE:'/images/loaders/indicator_black.gif',LOADING_TIMEOUT:500,SIZES:{NORMAL:'n'},IMG_MAX_HEIGHT:720,IMG_MIN_HEIGHT:500,STAGE_CHROME:150,STAGE_CHROME_NARROWER:100,STAGE_CHROME_NARROWEST:88,stageChrome:0,bootstrap:function(b,a){this.loading&&CSS.removeClass(this.loading,'loading');CSS.addClass((this.loading=a),'loading');Arbiter.inform(PhotoTheater.GO,b,Arbiter.BEHAVIOR_STATE);this.loadIfUninitialized();Bootloader.loadComponents(['TagTokenizer','TagToken','PhotoTag','PhotoTagger']);},loadImageOnMouseDown:function(event){var a=Parent.byTag(event.getTarget(),'a');if(a&&a.getAttribute('rel')=='theater'){var c=URI(a.getAttribute('ajaxify')).getQueryData();if(c.src){var b=new Image();b.src=c.src;}}},loadIfUninitialized:function(){if(this.root)return;new AsyncRequest().setURI('/ajax/photos/theater/init.php').setMethod('GET').setAllowCrossPageTransition(true).setReadOnly(true).send();},init:function(a){var b=ge('fbPhotoTheater');if(!b){b=DOM.appendContent(document.body,a)[0];this.initialLoad=false;}if(this.root==b)return;this.initializeNodes(b);if(!this.subscription){LinkController.registerHandler(this.handleNavigateAway.bind(this),LinkController.TARGETS|LinkController.MODIFIERS);Event.listen(document.documentElement,'mousedown',this.loadImageOnMouseDown.bind(this));this.subscription=Arbiter.subscribe(PhotoTheater.GO,function(c,d){CSS.removeClass(this.loading,'loading');this.open(d);}.bind(this));}PageTransitions.registerHandler(this.openHandler.bind(this));},initializeNodes:function(a){this.root=a;this.container=DOM.find(a,'div.container');this.positioner=DOM.find(a,'div.positioner');this.infoWrapper=DOM.find(a,'div.photoInfoWrapper');this.stageWrapper=DOM.find(a,'div.stageWrapper');this.videoStage=DOM.find(this.stageWrapper,'div.videoStage');this.stage=DOM.find(this.stageWrapper,'div.stage');this.errorBox=DOM.find(this.stageWrapper,'div.stageError');this.stageActions=DOM.find(a,'div.stageActions');this.prevPager=DOM.find(this.stageActions,'a.prev');this.nextPager=DOM.find(this.stageActions,'a.next');this.buttonActions=DOM.find(this.stageActions,'div.fbPhotoTheaterButtons');this.stageChrome=this.STAGE_CHROME;if(CSS.hasClass(a,'narrowerWhiteBar')){this.stageChrome=this.STAGE_CHROME_NARROWER;}else if(CSS.hasClass(a,'narrowestWhiteBar'))this.stageChrome=this.STAGE_CHROME_NARROWEST;Event.listen(this.root,'click',this.closeListener.bind(this));},getRoot:function(){return this.root;},openHandler:function(a){if(this.isOpen||a.getPath()!='/photo.php'||a.getQueryData().closeTheater)return false;this.open(a);PageTransitions.transitionComplete();return true;},open:function(a){Bootloader.loadComponents('fb-photos-theater-css',function(){this._open(a);}.bind(this));},_open:function(d){var a=URI(d).getQueryData();var c=a.src;this.urlEntryCount=1;this.hasSrc=!!c;if(c)delete a.src;if(!this.initialLoad){a.firstLoad=true;this.initialLoad=true;}this.isOpen=true;this.refreshOnClose=false;this.createLoader(c,a);this.stageHandlers=[Event.listen(window,'resize',this.adjustForResize.bind(this)),Event.listen(this.buttonActions,'click',this.buttonListener.bind(this))];var b=$('fbPhotoTheaterUfi');if(b)this.stageHandlers.push(Event.listen(b,'click',function(event){if(Parent.byClass(event.getTarget(),'like_link'))CSS.toggleClass(DOM.find(this.buttonActions,'a.likeButton'),'viewerLikesThis');}.bind(this)));PageTransitions.registerHandler(function(e){if(this.isOpen&&this.urlEntryCount==1&&!e.getQueryData().makeprofile){this.close();return true;}return false;}.bind(this));this.startingURI=URI.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI();KeyEventController.registerKey('ESCAPE',this.closeListener.bind(this));this.initLoader();PhotoTheaterLog.initLogging();if(ua.firefox())(function(){$$('embed').each(function(e){e.setAttribute('autostart','false');var f=e.getAttribute('flashvars');if(f){f=f.replace('autoplay=1','autoplay=0');e.setAttribute('flashvars',f);}var g=URI(e.src);g.addQueryData({autoplay:'0'});g.setPath(g.getPath().replace('autoplay=1','autoplay=0'));e.src=g.toString();});}).bind(this).defer();CSS.addClass(document.body,'theaterMode');Arbiter.inform('new_layer');Arbiter.inform(PhotoTheater.OPEN);(function(){this.adjustForResize();this.adjustForChromeBug(true);if(ua.ie()){this.container.focus();}else this.root.focus();}).bind(this).defer();},closeHandler:function(){if(!this.isOpen)return;if(URI.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI().toString()==this.startingURI.toString()){this.close();return;}this.close();this.returnToStartingURI(this.refreshOnClose);},returnToStartingURI:function(b,a){if(!b)if(a){this.squashNextTransition(goURI.curry(a));}else this.squashNextTransition();if(this.urlEntryCount<window.history.length){window.history.go(-1*this.urlEntryCount);}else goURI(PhotoTheater.startingURI);},squashNextTransition:function(a){this.squashNext=true;PageTransitions.registerHandler(function(b){if(PhotoTheater.squashNext){PhotoTheater.squashNext=false;if(a)a.defer();PageTransitions.transitionComplete();return true;}return false;});},handleNavigateAway:function(b){var a=_computeRelativeURI(window.PageTransitions._most_recent_uri.getQualifiedURI(),b.getAttribute('href'));if(this.isOpen&&(a instanceof URI)&&a.getUnqualifiedURI().toString()!=this.startingURI.toString()&&a.getPath()!='/photo.php'){if(!this.closingAction)this.closingAction=PhotoTheaterLog.NAVIGATE;this.close();this.returnToStartingURI(false,a);return false;}return true;},closeListener:function(event){if(this.isOpen&&!(window.Dialog&&Dialog.getCurrent())){var b=event.getTarget();var a=Parent.byClass(b,'closeTheater');if(b==this.root||b==this.container||b==this.positioner||b==this.infoWrapper||a){if(a){this.closingAction=PhotoTheaterLog.X;}else this.closingAction=PhotoTheaterLog.OUTSIDE;this.closeHandler();Event.kill(event);}else if(Event.getKeyCode(event)==KEYS.ESC){this.closingAction=PhotoTheaterLog.ESC;Event.kill(event);this.closeHandler();}}},close:function(){if(this.isOpen){this.isOpen=false;CSS.hide(this.errorBox);KeyEventController.getInstance().resetHandlers();this.destroy();CSS.removeClass(document.body,'theaterMode');this.switchImage(this.LOADING_IMAGE,false);CSS.removeClass(this.stageWrapper,'showVideo');DOM.empty(this.videoStage);this.recacheData();PhotoTheaterLog.logPhotoViews(this.closingAction);this.closingAction=null;DOM.empty(DOM.find(this.root,'div.fbPhotoTheaterEgo'));PageTransitions.registerHandler(this.openHandler.bind(this));Arbiter.inform(PhotoTheater.CLOSE);this.root.setAttribute('aria-busy','true');}},createLoader:function(a,b){this.image=DOM.find(this.root,'img.spotlight');this.loadQuery=b;if(a)(function(){this.switchImage(a,false);}).bind(this).defer();CSS.hide(this.stageActions);},initLoader:function(){this.loaded=false;this.cache={image:[],data:[],error:[]};this.permalinkMap={};this.lastAdsLoad=0;this.dataLoadTimer=null;this.imageLoadingTimer=null;this.loadingStates={image:false,data:false};this.uncachedCount=null;this.loadingRange={start:null,end:null};this.fetchInitialData();this.adjustMagicStageLineHeight();this.setLoadingState('data',true);PageTransitions.registerHandler(this.transitionHandler.bind(this));},fetchInitialData:function(){new AsyncRequest().setURI('/ajax/photos/theater/load.php').setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true).setData(this.loadQuery).setHandler(this.storeFromResponse.bind(this)).send();},initialLoadResponse:function(a){if(this.loaded)return;this.loaded=true;this.total=a.total;this.canPage=this.total>1;this.position=a.position;this.photoSetQuery=a.query;this.loadingRange={start:this.position,end:this.position};PhotoTheaterLog.setPhotoSet(this.photoSetQuery.set);PhotoTheaterLog.setLogFbids(a.logids);PhotoTheaterLog.addPhotoFbid(a.fbid);this.uncachedCount=this.total-1;if(this.canPage){if(!this.pageHandlers){var c={mouseout:this.mouseOutListener.bind(this),mousemove:this.mouseMoveListener.bind(this),click:this.pageListener.bind(this)};this.pageHandlers=values(Event.listen(this.stageActions,c)).concat(values(Event.listen(this.stageWrapper,c)));KeyEventController.registerKey('LEFT',this.pageListener.bind(this));KeyEventController.registerKey('RIGHT',this.pageListener.bind(this));}var b=5;this.calculateNewRangeAndFetchIfNeccessary(b);}else{if(this.pageHandlers)this.pageHandlers.each(function(d){d.remove();});this.pageHandlers=[Event.listen(this.stageWrapper,'click',this.whoamiListener.bind(this))];}this.adjustForChromeBug.bind(this).defer();CSS.conditionClass(this.stageActions,'hidePagers',!this.canPage);CSS.show(this.stageActions);this.root.setAttribute('aria-busy','false');},adjustMagicStageLineHeight:function(){var a=Math.min(this.IMG_MAX_HEIGHT,Math.max(this.IMG_MIN_HEIGHT,Vector2.getViewportDimensions().y-this.stageChrome));if(ua.ie()==7)this.stageWrapper.style.height=a+'px';this.stage.style.lineHeight=a+'px';this.videoStage.style.lineHeight=a+'px';if(this.image.offsetHeight){var b=Vector2.getElementPosition;var c=Math.floor((b(this.image).y-b(this.stage).y-1)-((this.stage.offsetHeight-this.image.offsetHeight)/2));if(c)this.stage.style.marginTop="-"+c+"px";}},adjustForResize:function(){var a=Vector2.getViewportDimensions();CSS.conditionClass(document.body,'tinyScreen',a.x<=981);if(ua.ie()<9)CSS.conditionClass(this.stageWrapper,'stageWrapperIEFix',a.y-this.stageChrome<this.IMG_MIN_HEIGHT);this.revertChromeBugFix();this.adjustMagicStageLineHeight();this.adjustForNewData();},adjustForNewData:function(){if(ua.firefox()||ua.ie()){var c=DOM.scry(this.root,'div.tagsWrapper')[0];var a=Vector2.getElementDimensions(this.image);if(c){c.style.width=a.x+"px";if(ua.ie()<=7){var b=DOM.scry(this.root,'div.tagContainer')[0];if(b)CSS.conditionClass(c,'ie7VerticalFix',Vector2.getElementDimensions(b).y>a.y);}}}},adjustForChromeBug:function(a){if(ua.chrome())if(a){this.stage.style.width='960px';}else{var b=Vector2.getElementDimensions(this.image).x;this.stage.style.width=b?b+'px':'auto';}},revertChromeBugFix:function(){if(ua.chrome())this.stage.style.width='auto';},checkToLoadAds:function(){if(this.noAds)return;var a=(+new Date());if(a-this.lastAdsLoad>this.ADS_REFRESH_RATE){UIPagelet.loadFromEndpoint('WebEgoPane','fbPhotoTheaterEgo',{is_ajax:true,pid:13,data:[]},{crossPage:true});this.lastAdsLoad=a;}},setLoadingState:function(b,a){this.loadingStates[b]=a;if(b=='image'){if(this.imageLoadingTimer){clearTimeout(this.imageLoadingTimer);this.imageLoadingTimer=null;}if(a)this.imageLoadingTimer=setTimeout(this.imageLoadingTimeout.bind(this),this.LOADING_TIMEOUT);CSS.conditionClass(this.root,'imageLoading',a);}else{CSS.conditionClass(this.root,'dataLoading',a);this.infoWrapper.setAttribute('aria-busy',a?'true':'false');}},destroy:function(){this.stageHandlers.each(function(a){a.remove();});if(this.pageHandlers){this.pageHandlers.each(function(a){a.remove();});this.pageHandlers=null;}},checkState:function(a){if(a!='error'&&!this.loadingStates[a])return;if(a=='image'){if(this.cache.image[this.position]){if(this.cache.image[this.position].url){this.switchImage(this.cache.image[this.position].url,true);}else if(this.cache.image[this.position].video)this.switchVideo(this.cache.image[this.position].video,true);this.setLoadingState(a,false);}}else if(a=='data'){if(this.cache.data[this.position]){this.swapData();this.setLoadingState(a,false);}}else if(this.cache.error[this.position]){CSS.hide(this.image);CSS.show(this.errorBox);}},buttonListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'likeButton')){DOM.find($('fbPhotoTheaterUfi'),'button.like_link').click();}else if(Parent.byClass(a,'commentButton')){DOM.find(this.root,'div.commentBox textarea').focus();this.root.scrollTop=this.root.scrollHeight;}else if(Parent.byClass(a,'rotateRight')){this.rotate('right');}else if(Parent.byClass(a,'rotateLeft'))this.rotate('left');},rotate:function(b){var c=this.cache.image[this.position];var a={fbid:c.info.fbid,position:this.position};a[b]=1;this.setLoadingState('image',true);var d=c.url;c.url=this.LOADING_IMAGE;var e=this.position;new AsyncRequest('/ajax/photos/photo/rotate/').setMethod('POST').setAllowCrossPageTransition(true).setReadOnly(false).setData(a).setHandler(this.rotationComplete.bind(this,e)).setErrorHandler(this.rotationError.bind(this,e,d)).send();},rotationComplete:function(b,c){this.storeFromResponse(c);var a=this.cache.image[b];a.url=c.getPayload().new_urls[this.SIZES.NORMAL];if(b==this.position){this.setLoadingState('image',false);this.swapData();this.switchImage(a.url);}this.refreshOnClose=true;},rotationError:function(b,c,d){var a=this.cache.image[b];a.url=c;if(b==this.position){this.switchImage(a.url);this.setLoadingState('image',false);AsyncResponse.defaultErrorHandler(d);}},mouseOutListener:function(event){var d=event.getTarget();var a=event.getRelatedTarget();var b=Parent.byClass(d,'stageActions');var c=Parent.byClass(d,'stageWrapper');var e=Parent.byClass(a,'stageActions');var f=Parent.byClass(a,'stageWrapper');if((c&&!e)||(b&&!f)){CSS.removeClass(this.prevPager,'hover');CSS.removeClass(this.nextPager,'hover');}},mouseMoveListener:function(event){var a=event.getTarget()==this.prevPager;CSS.conditionClass(this.prevPager,'hover',a);CSS.conditionClass(this.nextPager,'hover',!a);},whoamiListener:function(event){var b=Parent.byClass(event.getTarget(),'whoami');if(!b)return false;var c={pos:Vector2.getElementPosition(b),size:Vector2.getElementDimensions(b)};var d=DOM.scry(this.tagsWrapper,'div.whoami');for(var a=0;a<d.length;a++)DOM.remove(d[a]);PhotoTagger.activateTagging();PhotoTagger.addTag(event,c);return true;},getVideoOnStage:function(){return this.position&&this.cache.image[this.position]&&this.cache.image[this.position].video;},pageListener:function(event){if(!Event.getKeyCode(event)&&this.whoamiListener(event))return;var a=Event.getKeyCode(event)||event.getTarget();var c=a==this.nextPager||a==KEYS.RIGHT||(!CSS.hasClass(this.root,'taggingMode')&&a==this.stageActions)||(!this.getVideoOnStage()&&DOM.isNode(a)&&Parent.byClass(a,'stageWrapper'));var b=(a==this.prevPager)||(a==KEYS.LEFT);if(c){this.page(1);user_action(event.getTarget(),'a',event);}else if(b){this.page(-1);user_action(event.getTarget(),'a',event);}},page:function(d,c){if(!d||!this.canPage||!this.loaded)return;var e=this.getVideoOnStage();if(e)this.switchVideo(e,false);Arbiter.inform(PhotoTheater.PAGE);this.recacheData();this.position=this.calculatePosition(d);if(this.checkErrorAt(this.position)){CSS.hide(this.image);CSS.show(this.errorBox);}else{var b=this.cache.image[this.position];if(b){if(b.url){this.switchImage(b.url,true);}else if(b.video)this.switchVideo(b.video,true);if(!c){this.replaceUrl=true;this.urlEntryCount++;goURI(b.info.permalink);}}else this.setLoadingState('image',true);var a=this.cache.data[this.position];if(a){this.swapData();}else this.setLoadingState('data',true);}this.revertChromeBugFix();this.loadMoreIfNeccessary(d>0);this.checkToLoadAds();},checkErrorAt:function(a){if(this.cache.error[a]&&!(this.cache.image[a]&&this.cache.data[a])){return true;}else if(this.cache.image[a]&&this.cache.data[a])this.cache.error[a]=false;return false;},goToPosition:function(c){if(c>this.total||c<1)c=this.total;var b=0;var a=0;if(c>this.position){b=c-this.position;a=this.position+this.total-c;}else{b=this.total-this.position+c;a=this.position-c;}this.page(b<a?b:a*-1,true);},transitionHandler:function(b){if(b.getQueryData().closeTheater)return false;if(this.replaceUrl){this.replaceUrl=false;PageTransitions.transitionComplete();return true;}if(b.getQueryData().makeprofile)return false;var a=this.permalinkMap[b.getUnqualifiedURI().toString()];if(a){this.goToPosition(a);PageTransitions.transitionComplete();return true;}return false;},recacheData:function(){if(!this.loadingStates.data){var a=this.cache.data[this.position];for(var b in a){a[b]=$A($(b).childNodes);DOM.empty($(b));}}},switchImage:function(d,c){CSS.hide(this.errorBox);clearTimeout(this.imageRefreshTimer);if(this.imageLoadingTimer){clearTimeout(this.imageLoadingTimer);this.imageLoadingTimer=null;}var a=this.cache&&this.cache.image[this.position];if(a&&d!=this.LOADING_IMAGE)PhotoTheaterLog.addPhotoView(a.info.fbid);var b=$N('img',{className:'spotlight',alt:''});b.setAttribute('aria-describedby','fbPhotoTheaterCaption');b.setAttribute('aria-busy','true');if(d!=this.LOADING_IMAGE){this.imageRefreshTimer=setTimeout(this.reloadIfTimeOut.bind(this),2000);b.onload=async_callback(function(){clearTimeout(this.imageRefreshTimer);this.image.setAttribute('aria-busy','false');}.bind(this),'photo_theater');window.ArbiterMonitor&&ArbiterMonitor.customReport('phtld',['theater']);}b.src=d;this.useImage(b,false);if(c)this.preloadImages();},switchVideo:function(c,a){var b='swf_'+c;if(a){CSS.addClass(this.stageWrapper,'showVideo');this.videoStage.id=c;if(window[b]&&!ge(b))window[b].write(c);}else{this.videoStage.id='fbVideoStage';window[b].addVariable('video_autoplay',0);DOM.empty(this.videoStage);CSS.removeClass(this.stageWrapper,'showVideo');}},useImage:function(b,a){if(a&&image_has_loaded(this.image))return;DOM.replace(this.image,b);this.image=b;},setErrorBoxContent:function(a){DOM.setContent(this.errorBox,a);},reloadIfTimeOut:function(){if(!image_has_loaded(this.image)){var a=$N('img',{className:'spotlight'});a.src=this.image.src;Event.listen(a,'load',this.useImage.bind(this,a,true));}},imageLoadingTimeout:function(){if(this.loadingStates.image)this.switchImage(this.LOADING_IMAGE,false);},preloadImages:function(){var d,c;var e=this.total;var b=this.cache.image;var a=this.PRELOAD_BUFFER;if(e>a*2){d=this.calculatePosition(a*-1);c=this.calculatePosition(a);}else{d=1;c=e;}while(d!=c){if(b[d]&&!b[d].resource&&b[d].url){b[d].resource=new Image();b[d].resource.src=b[d].url;}d=(d%e)+1;}},calculatePosition:function(a,b){var c=this.total;b=b||this.position;while(a<0)a+=c;return ((b+a)%c)||c;},swapData:function(){if(this.dataLoadTimer){this.setLoadingState('data',true);clearTimeout(this.dataLoadTimer);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,true),100);return;}var b,a=this.cache.data[this.position];if(a){for(var c in a){b=ge(c);b&&DOM.setContent(b,a[c]);}new PhotoInlineCaptionEditor('center_stage').init(DOM.find($('fbPhotoTheaterCaption'),'div.fbPhotoInlineCaptionEditor'));Arbiter.inform(PhotoTheater.DATA_CHANGE,this.cache.image[this.position].info,Arbiter.BEHAVIOR_STATE);this.setLoadingState('data',false);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,false),100);}this.adjustForNewData();},clearTimer:function(a){this.dataLoadTimer=false;a&&this.swapData();},loadMoreIfNeccessary:function(c){var d=c?1:-1;var b=this.BUFFER_PERCENT;var a=this.BUCKET_SIZE;var f=Math.ceil(a*b);var e=this.calculatePosition(Math.min(f,this.uncachedCount)*d);if(!this.isInLoadingRange(e)||!this.isInLoadingRange(this.position))this.calculateNewRangeAndFetchIfNeccessary(a*d);},isInLoadingRange:function(a){rangeStart=this.loadingRange.start;rangeEnd=this.loadingRange.end;if(rangeStart<=rangeEnd){return rangeStart<=a&&a<=rangeEnd;}else return a<=rangeEnd||rangeStart<=a;},calculateNewRangeAndFetchIfNeccessary:function(a){if(this.uncachedCount===0||a===0)return;var b,c,d=this.loadingRange;a=a>0?Math.min(this.uncachedCount,a):Math.max(-1*this.uncachedCount,a);if(a>0){b=this.calculatePosition(1,d.end);c=this.calculatePosition(a,d.end);}else{b=this.calculatePosition(a,d.start);c=this.calculatePosition(-1,d.start);}if(this.isInLoadingRange(b))return;if(a>0){d.end=c;}else d.start=b;this.fetch(b,c);},fetch:function(b,c){if(!this.canPage)return;this.uncachedCount-=b>c?this.total-b+c+1:c-b+1;var a=copy_properties({start:b,end:c,total:this.total},this.photoSetQuery);UIPagelet.loadFromEndpoint('PhotoTheaterPagelet',null,a,{usePipe:true,jsNonblock:true,crossPage:true});},storeFromResponse:function(b){if(!this.isOpen)return;var a=b.getPayload();this.storeFromData(a);},storeFromData:function(h){var b=h.error;if(b){this.processErrorResult(b);this.checkState('error');return;}var f=h.init;var e=h.image;var a=h.data;if(f){this.initialLoadResponse(f);this.replaceUrl=true;goURI(e[this.position].info.permalink);this.noAds=f.noads;}this.checkToLoadAds();if(e){for(var d in e){this.cache.image[d]=e[d];this.permalinkMap[URI(e[d].info.permalink).getUnqualifiedURI().toString()]=d;}this.checkState('image');if(!this.hasSrc){if(this.cache.image[this.position].url){this.switchImage(this.cache.image[this.position].url);}else if(this.cache.image[this.position].video)this.switchVideo(this.cache.image[this.position].video,true);this.hasSrc=true;}}if(a){for(var g in a){if(!this.cache.data[g])this.cache.data[g]={};for(var c in a[g])this.cache.data[g][c]=HTML(a[g][c]).getNodes();}this.checkState('data');}},processErrorResult:function(a){if(!(a.start||a.end)){CSS.hide(this.image);CSS.show(this.errorBox);}else{var b=a.start;var e=a.end;if(b<e){for(var c=b;c<=e;c++)this.setErrorAt(c);}else{for(var c=1;c<=e;c++)this.setErrorAt(c);for(var d=b;d<=a.total;d++)this.setErrorAt(d);}}},setErrorAt:function(a){if(!(this.cache.image[a]&&this.cache.data[a]))this.cache.error[a]=true;},deletePhoto:function(a){this.refreshOnClose=true;this.closeHandler();}};
function StreamProfileComposer(){}StreamProfileComposer.prototype={init:function(a){var b=$(a);Arbiter.subscribe('composer/publish',function(event,c){animation.prependInsert(b,c);});}};
function Composer(){}(function(){var b=1,a=2;var f={};var e=function(){var j=DOM.scry(this.root,'span.linkAttachment')[0];if(!j)return;var i=Parent.byTag(j,'form');this.scraper=new URLScraper(this.input);this.scraper.subscribe('match',function(k,l){i.action='/ajax/composer/attachment/link/scraper.php?scrape_url='+encodeURIComponent(l.url);i.xhpc.value=j.id;i.xhpc.click();}.bind(this));};var g=function(event,i){i=i||{};i.evt=event;i.flowID=this.flowID;i.context=this.form.xhpc_context.value;i.target=this.form.action.split('/').pop();i={data:JSON.stringify(i)};new AsyncSignal('/ajax/composer/logging.php',i).send();};var d=function(i){this.flowID=new Date().getTime().toString()+(rand32()+1);this._logged_short=this._logged_long=false;if(i)return;Event.listen(this.input,'keypress',function(){var j=Input.getValue(this.input).length;if(!this._logged_short&&j>=2){g.call(this,'typing',{extra:'short'});this._logged_short=true;return;}if(!this._logged_long&&j>=15){g.call(this,'typing',{extra:'long'});this._logged_long=true;}}.bind(this));};var c=function(i){if(this.inform('submit')===false){i.kill();return false;}g.call(this,'publish');if(this.submitHandler)return (new Function(this.submitHandler)).apply(this.form);};var h=function(){var i=this.privacyCallout;if(!i)return;if(this.privacy.offsetWidth){i.setDestroyOnHide(true);i.show();}else{i.setDestroyOnHide(false);i.hide();}};Composer.mixin('Arbiter',{init:function(k,i,j){f[k.id]=this;this.root=k;this.resetCfg=j;this.focus=DOM.find(k,'div.focus_target');this.form=DOM.find(k,'form.attachmentForm');this.content=DOM.find(k,'div.attachmentContent');this.blurb=DOM.find(k,'div.uiComposerMessageBox div.textBlurb');this.input=DOM.find(k,'div.uiComposerMessageBox textarea.input');this.button=DOM.find(k,'div.uiComposerMessageBox label.submitBtn');this.privacy=DOM.find(k,'div.uiComposerMessageBox li.privacyWidget');if(i)i.subscribe('init',function(){this.mentionsInput=i;var l=i.getTypeahead().getView();l.subscribe(['reset','render'],function(m){CSS.conditionClass(k,'uiComposerMention',(m=='render'));});}.bind(this));Event.listen(this.form,'submit',c.bind(this));e.call(this);d.call(this);Arbiter.inform('xhpc/init/'+k.id,this,Arbiter.BEHAVIOR_STATE);},initPrivacyEducation:function(k,p,i,j){if(i){this.privacyCallout=i;if(!CSS.hasClass(this.focus,'child_was_focused'))var n=Event.listen(this.input,'focus',function(){n.remove();h.call(this);}.bind(this));var o=p.subscribe('menuActivated',function(){p.unsubscribe(o);Button.getInputElement(j).click();});i.subscribe('submit',function(){this.privacyCallout=null;}.bind(this));h.call(this);}if(k.warnChange)var l=p.subscribe('privacyChanged',function(r,q){p.unsubscribe(l);Bootloader.loadComponents('dialog',function(){Dialog.bootstrap('/ajax/privacy/change_default_dialog.php',{privacy_data:q,autosave:true});});});if(k.warnEveryone)var m=this.subscribe('submit',function(){if(p.isEveryonePrivacy()){var q='/ajax/privacy/confirm_everyone_dialog.php';Bootloader.loadComponents(['async','dialog'],function(){new Dialog().setAsync(new AsyncRequest(q)).setHandler(function(){this.unsubscribe(m);new AsyncRequest('/ajax/privacy/save_composer_data.php').setData({seen_everyone:true}).send();Button.getInputElement(this.button).click();}.bind(this)).show();}.bind(this));return false;}}.bind(this));},setBlurb:function(i){DOM.setContent(this.blurb,i);},setEnabled:function(i){Button.setEnabled(this.button,i);},setLoading:function(i){CSS.conditionClass(this.root,'async_saving',!!i);},setContentVisible:function(i){CSS.conditionClass(this.root,'uiComposerHideContent',!i);},setMessageBoxVisible:function(i){CSS.conditionClass(this.root,'uiComposerHideMessageBox',!i);},setInputVisible:function(i){CSS.conditionClass(this.root,'uiComposerHideInput',!i);},reset:function(){Input.reset(this.input);this.mentionsInput&&this.mentionsInput.reset();if(this.resetCfg){this.mutate(this.resetCfg);}else{var i=DOM.scry(this.root,'.uiComposerAttachmentSelected')[0];if(i)CSS.removeClass(i,'uiComposerAttachmentSelected');}CSS.removeClass(this.root,'uiComposerInteracted');CSS.setClass(this.focus,'focus_target');this.setLoading(false);d.call(this,true);},mutate:function(j){CSS.addClass(this.root,'uiComposerOpen');CSS.addClass(this.root,'uiComposerInteracted');var i=ge(j.xhpc);if(i){var k=DOM.scry(this.root,'.uiComposerAttachmentSelected')[0];if(k)CSS.removeClass(k,'uiComposerAttachmentSelected');CSS.addClass(i,'uiComposerAttachmentSelected');if(!j.disableCache)Event.listen(i,'click',function(l){$E(l).stop();this.mutate(j);}.bind(this));}if(j.content){DOM.setContent(this.content,HTML(j.content));this.setContentVisible(true);}else{this.setContentVisible(false);DOM.empty(this.content);}this.setMessageBoxVisible(!j.messageBoxHidden);CSS.conditionClass(this.root,'uiComposerWhiteMessageBox',!j.messageBoxHidden&&!j.inputHidden&&!j.content);this.setInputVisible(!j.inputHidden);CSS.conditionShow(this.privacy,!j.privacyWidgetHidden);Input.setPlaceholder(this.input,j.placeholder);Button.setLabel(this.button,j.buttonLabel);this.setBlurb(HTML(j.blurb));CSS.conditionClass(DOM.scry(this.form,'.uiComposerMessageBox')[0],'uiCheckinComposer',j.placeVisible);if(j.autoscrape){this.scraper&&this.scraper.enable();}else this.scraper&&this.scraper.disable();this.setEnabled(!j.disabled);this.form.setAttribute('action',j.endpoint);if(j.formType==b){this.form.setAttribute('rel','async');}else this.form.removeAttribute('rel');if(j.formType==a){this.form.target=j.iframeName;this.form.enctype=this.form.encoding='multipart/form-data';}else{this.form.removeAttribute('target');this.form.removeAttribute('enctype');this.form.removeAttribute('encoding');}this.submitHandler=j.submitHandler;h.call(this);if(j.messageBoxFocused)this.focusInput();},focusInput:function(){this.input.focus();},getInput:function(){return this.input;}});copy_properties(Composer,{publish:function(j,i){Composer.getInstance($(j)).reset();Arbiter.inform('composer/publish',HTML(i).getRootNode());},getInstance:function(i){var j=Parent.byClass($(i),'uiComposer');return j?f[j.id]:null;}});})();