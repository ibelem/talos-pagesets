var PBScriptPreloaddisableder=Class.create({pbType:"PBScriptPreloaddisableder",initialize:function(A){this.delay=2000;this.fetchedScripts=new Array();for(var B in A){this[B]=A[B]}this.onLoaded=this.onLoadHandler.bindAsEventListener(this);Event.observe(window,"loaddisabled",this.onLoaded);this.currentScriptIndex=-1},onLoadHandler:function(D){try{var A=this;var B=this.fetch;if(!B&&D.request.options.custom){A=D.request.options.custom;B=A.fetch}setTimeout(B.bind(A),A.delay)}catch(C){}},add:function(B,A){A=A||this.evalJSON;this.fetchedScripts[this.fetchedScripts.length]=B},fetch:function(){if(++this.currentScriptIndex<this.fetchedScripts.length){this.loaddisabledScript(this.fetchedScripts[this.currentScriptIndex])}},loaddisabledScript:function(A){new Ajax.Request(A,{method:"get",evalJSON:false,evalJS:false,onSuccess:this.onLoadHandler,custom:this})}});var KodakImage=Class.create();KodakImage.prototype={url:"",prints:null,print_options:null,initialize:function(B,A,C){this.url=B;if(typeof (A)=="array"&&A){this.prints=A}if(typeof (C)&C){this.print_options=C}},getXML:function(){var B="",A;B="<image>";B+="<url>"+this.url+"</url>";if(this.prints&&this.prints.length>0){B+="<print_sizes>";for(A=0;A<this.prints.length;A++){B+=this.prints[A].getXML()}B+="</print_sizes>"}if(this.print_options){B+=this.print_options.getXML()}B+="</image>";return B}};var KodakPrint=Object.extend(Class.create(),{SIZES:{SZ_4X6:"4X6",SZ_Wallet:"Wallet",SZ_5X7:"5X7",SZ_8X10:"8X10",SZ_16X20:"16X20",SZ_20X30:"20X30"}});KodakPrint.prototype={size:"",quantity:0,initialize:function(A,B){this.size=A;this.quantity=B},getXML:function(){var A="";A="<print_size>";A+="<size>"+this.size+"</size>";A+="<quantity>"+this.quantity+"</quantity>";A+="</print_size>";return A}};var KodakPrintOptions=Object.extend(Class.create(),{FINISH:{GLOSSY:"glossy",MATTE:"matte"}});KodakPrintOptions.prototype={kpt:false,zte:false,finish:"",initialize:function(C,B,A){this.kpt=C;this.zte=B;this.finish=A},getXML:function(){var B="";var A="zoom_trim";B="<print_options>";B+="<kpt>"+this.kpt+"</kpt>";B+="<zoom_trim>"+this.zte+"</zoom_trim>";B+="<finish>"+this.finish+"</finish>";B+="</print_options>";return B}};var KodakPartnerPurchase=Object.extend(Class.create(),{PRODUCT_TYPES:{PHOTOMUG:"photomug",PRINTS:"prints",TSHIRT:"tshirt",COASTERS:"coasters",MOUSEPAD:"mousepad",PUZZLES:"puzzles",PLAYINGCARDS:"playingcards"},LOCALE:{EN_US:"en_US",EN_GB:"en_GB",EN_GB_EURO:"en_GB_EURO",FR_FR:"fr_FR",IT_IT:"it_IT",DE_DE:"de_DE",DE_IT:"de_IT",NL_NL:"nl_NL",EN_CA:"en_CA",FR_CA:"fr_CA"}});KodakPartnerPurchase.prototype={locale:"",product_type:"",print_options:null,listImages:[],source_id:"",initialize:function(C,A,B){this.source_id=C;this.locale=A;this.product_type=B},addPrintOptions:function(A){this.print_options=A},addImage:function(A){if(this.product_type==KodakPartnerPurchase.PRODUCT_TYPES.PRINTS){this.listImages.push(A)}else{this.listImages[0]=A}},getXML:function(){var C="",B;C="<partner_purchase>";C+="<sourceid>"+this.source_id+"</sourceid>";C+="<locale>"+this.locale+"</locale>";C+="<product_type>"+this.product_type+"</product_type>";if(this.print_options){C+=this.print_options.getXML()}if(this.listImages&&this.listImages.length>0){var A=(this.product_type==KodakPartnerPurchase.PRODUCT_TYPES.PRINTS?this.listImages.length:1);C+="<images>";for(B=0;B<A;B++){C+=this.listImages[B].getXML()}C+="</images>"}C+="</partner_purchase>";return C}};var ReportAbuseLightboxController;(function(){var B={ERROR_MSSG:{NO_VIOLATION_TYPE:{TITLE:"Error: No Violation Type Selected",DETAIL:"Please enter the type of violation you are reporting."},NO_EMAIL:{TITLE:"Error: No Email Address",DETAIL:"Your email address is required."},INVALID_EMAIL:{TITLE:"Error: Invalid Email Address",DETAIL:"You must enter your valid email address."},NO_COMMENT:{TITLE:"No Comment",DETAIL:"Your must enter a comment describing how this content violates our policies."}}};var A={listHiddenPanels:[],hashCfgs:{},defaultBttnText:"",handleToNewPageHandler:null,initialize:function(){},bindHandlers:function(){var E;if((E=$("lightboxcontent"))!=null){this.listHiddenPanels=E.select(".hiddenPanel")}if((E=$("bttnAbuseSubmit"))!=null){this.defaultBttnText=E.innerHTML;Event.observe(E,"click",this.handleSubmit.bindAsEventListener(this,C),false)}var F;for(F=0;F<arguments.length;F++){var D=arguments[F];if(typeof (D)=="object"){if(typeof (D.id)=="string"&&D.id&&(E=$(D.id))!=null){this.hashCfgs[D.id]=D;var C=D.panel?D.panel:null;Event.observe(E,"click",this.handleDisplayPanel.bindAsEventListener(this,C),false)}}}},handleDisplayPanel:function(G,F){var D=Event.element(G),E;if(D&&D.id&&typeof (this.hashCfgs[D.id])!="undefined"){var C=this.hashCfgs[D.id];D=$("bttnAbuseSubmit");if(C.altBttnText){D.innerHTML=C.altBttnText}else{D.innerHTML=this.defaultBttnText}}for(E=0;E<this.listHiddenPanels.length;E++){Element.hide(this.listHiddenPanels[E])}if(F&&(D=$(F))!=null){Element.show(D)}},handleSubmit:function(I){var G={},F,D;var H=$("formAbuse");var G=H.serialize(true);if(!G.abuseType){D={type:PBMessage.MESSAGE_TYPE.ERROR,title:ReportAbuseLightboxController.ERROR_MSSG.NO_VIOLATION_TYPE.TITLE,details:ReportAbuseLightboxController.ERROR_MSSG.NO_VIOLATION_TYPE.DETAIL};document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage(D)});return }var C=this.hashCfgs[G.abuseType];if(C&&C.checkcomment){if(!G.abuseComments){D={type:PBMessage.MESSAGE_TYPE.ERROR,title:ReportAbuseLightboxController.ERROR_MSSG.NO_COMMENT.TITLE,details:ReportAbuseLightboxController.ERROR_MSSG.NO_COMMENT.DETAIL};document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage(D)});return }}G.reporterEmail=G.reporterEmail.strip();if(C&&C.checkemail){if(!G.reporterEmail){D={type:PBMessage.MESSAGE_TYPE.ERROR,title:ReportAbuseLightboxController.ERROR_MSSG.NO_EMAIL.TITLE,details:ReportAbuseLightboxController.ERROR_MSSG.NO_EMAIL.DETAIL};document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage(D)});return }if(!G.reporterEmail.match(/^[A-Za-z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/)){D={type:PBMessage.MESSAGE_TYPE.ERROR,title:ReportAbuseLightboxController.ERROR_MSSG.INVALID_EMAIL.TITLE,details:ReportAbuseLightboxController.ERROR_MSSG.INVALID_EMAIL.DETAIL};document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage(D)});return }}if(C&&C.newPageUrl){this.handleToNewPageHandler=this.handleNewPageOpen.bindAsEventListener(this,C.newPageUrl);Event.observe(document,PBLightbox.EVENT.DEACTIVATED,this.handleToNewPageHandler)}G=$H(G).toQueryString();try{new Ajax.Request("/reportabuse/report/",{method:"post",parameters:G,onSuccess:this.handleAbuseSubmitSuccess.bind(this)})}catch(E){}},handleNewPageOpen:function(D,C){Event.stopObserving(document,PBLightbox.EVENT.DEACTIVATED,this.handleToNewPageHandler);void(C,"abuseSubWindow","")},handleAbuseSubmitSuccess:function(E){E=translateAjaxResponse(E);var D={type:PBMessage.MESSAGE_TYPE.ERROR,title:"Unknown Error",details:"An unknown error occured while sending your report."};var C=PBMessage.EVENT.NOTIFY;if(typeof (E)!="undefined"&&typeof (E.stat)=="string"){if(E.stat=="ok"){D.type=PBMessage.MESSAGE_TYPE.SUCCESS;D.title=E.title;if(E.detail){D.details=E.detail}else{delete D.details}}else{if(E.messageInLB){C=PBLightbox.PBMessage.EVENT.NOTIFY}D.type=PBMessage.MESSAGE_TYPE.ERROR;if(E.title){D.title=E.title}if(E.detail){D.details=E.detail}}}if(D.title){if(jq("#fullviewMessagePanel").length>0){var F="fullviewMessagePanel"}else{var F="MessagePanel"}document.fire(C,{id:F,message:new PBMessage(D)});if(!E.messageInLB){$("widthPage").scrollTo()}}if(!E.messageInLB){document.fire(PBLightbox.EVENT.DEACTIVATE)}},handleAbuseSubmitComplete:function(C){}};Controller.create("ReportAbuseLightboxController",A,B)})();(function(A){A.fn.pbImageInfo=function(D){var I=this;_pb.imageinfo=this;var C={url:null,cached:false};if(D){A.extend(C,D)}var F=A(document);var J=F.find("#columnLeft_image_info");var H=J.find(".collapseAjaxTarget");var B=F.find("#columnLeft_image_info .progress");var E=F.find("#containerEXIF");var G=J.find(".collapseBody");H.live("click",function(L){var N=J.attr("class");if(N=="moduleItem collapsed"){J.removeClass("collapsed");var M="297px";if(G&&!C.cached){var K=G.get(0).offsetHeight+"px";B.css("width",M);B.css("height",K);B.css("display","block")}if(C.url&&!C.cached){A.getJSON(C.url+"&fetchExif=true",{},function(O){E.css("height","auto");E.html(O.response.exif);B.css("display","none");C.cached=true})}}else{I.close()}});this.setUrl=function(K){C.url=K};this.setCached=function(K){C.cached=K;if(!K){E.html("");E.css("height","60px")}};this.close=function(){J.addClass("collapsed");B.css("display","none")};this.onPagination=function(L){var K=L.memo;I.setUrl(K.browseUrl);I.close();I.setCached(false)};if(typeof (FullViewPaginatorController)!="undefined"){jq(document).bind(FullViewPaginatorController.EVENT.PRIMARY_UPDATE,I.onPagination)}return this}})(jQuery);var CommentsController;(function(){var A={initialize:function(){Event.observe(document,CommentsController.EVENT.CAPTUREEXTERNALCOMMENT,this.captureExternalComment.bindAsEventListener(this));Event.observe(document,CommentsController.EVENT.FACEBOOKLOADED,this.handleFacebookLoaded.bindAsEventListener(this))},captureExternalComment:function(F){var G=F.memo;var I="";var E=$("externalCommentKeys");var D=$("mediaURL");if(D){var C=D.value}else{var C=$("mediaURL_0").value}I+="mediaUrl="+encodeURIComponent(C);for(var J in G){I+="&"+J+"="+encodeURIComponent(G[J])}var H=E.serialize();I+="&"+H;new Ajax.Request("/comment/saveExternalComment",{method:"POST",parameters:I,evalJSON:"force",onSuccess:this.handleCaptureExternalComment.bindAsEventListener(this)})},handleCaptureExternalComment:function(D){var C=D.responseJSON;if(C.response.stat=="ok"){tr("external_comment_saved")}else{tr("external_comment_save_failed")}},handleFacebookLoaded:function(C){var D=this;FB.Event.subscribe("comment.create",function(K){var F=K.post;var J=K.user;var I=jq("#fbContent").children().first();if(I){var H=I.attr("xid")}FB.getLoginStatus(function(M){if(M.session){FB.api("/me",function(O){if(O){var N={extId:O.id,extName:O.name,extLink:O.link,extXid:H,sitename:"Facebook"};if(O.email){N.extEmail=O.email}document.fire(CommentsController.EVENT.CAPTUREEXTERNALCOMMENT,N)}else{var N={extXid:H,sitename:"Facebook"};document.fire(CommentsController.EVENT.CAPTUREEXTERNALCOMMENT,N)}})}else{var L={extXid:H,sitename:"Facebook"};document.fire(CommentsController.EVENT.CAPTUREEXTERNALCOMMENT,L)}});if(D.isMediaDetail){var G="facebook_media_detail_comment";var E=(D.isLoggedInReadWrite)?"_logged_in":"_logged_out"}else{var G="facebook_fullview_comment";var E=(D.isLoggedInReadWrite)?"_logged_in":"_logged_out"}tr(G);tr(G+E);tr("facebook_comment")})},mixInFacebook:function(C){for(var D in C){this[D]=C[D]}}};var B={EVENT:{CAPTUREEXTERNALCOMMENT:"CommentsController:captureexternalcomment",FACEBOOKLOADED:"CommentsController:facebookloaddisableded"}};Controller.create("CommentsController",A,B)})();var NotifyController;(function(){var publicMembers={form:null,idPrefix:null,deleteNotifyLI:null,deleteNotifyUL:null,noSubscriptionTextId:"containerUserSubscriptions",listPanelId:null,listPanelDivId:null,listPanelHeightMargin:"30",progress:null,warnInvalidEmail:false,viewerAlbumUrl:null,type:null,toggleButton:false,toggleButtonId:null,initialize:function(){Event.observe(document,NotifyController.EVENT.ADD,this.addSubscription.bindAsEventListener(this));Event.observe(document,NotifyController.EVENT.EDIT,this.editSubscription.bindAsEventListener(this));Event.observe(document,NotifyController.EVENT.SUBMIT,this.handleSubmitClick.bindAsEventListener(this));Event.observe(document,NotifyController.EVENT.DELETE,this.handleDeleteNotification.bindAsEventListener(this));Event.observe(document,NotifyController.EVENT.REGISTERBUTTON,this.registerButton.bindAsEventListener(this))},mixIn:function(cfg){for(var n in cfg){this[n]=cfg[n]}if(this.id){this.form=$(this.id);this.progress=new PBProgress({parentId:this.id,themed:true})}if(this.warnInvalidEmail){this.fireErrorMessage('WARNING: Our records show that your current email address is invalid.  You can change your email by going to your <a href="'+this.viewerAlbumUrl+'?action=accountoptions">account options</a>.')}},addSubscription:function(evt){if(!evt.memo.email){evt.memo.edit=0;evt.memo.returnUrl=document.location.href;this.fireLightboxByEditType(evt.memo)}else{this.forceSubscription(evt)}},forceSubscription:function(evt){this.type=evt.memo.type;var params="notify[comments]=true&notify[uploaddisableds]=true";params+="&notify[email]="+evt.memo.email;if(evt.memo.isRec){params+="&notify[isRec]=true"}if(evt.memo.type=="search"){params+="&notify[term]="+escape(evt.memo.term.replace(/['"]/g,""));params+="&notify[subname]="+escape(evt.memo.term.replace(/['"]/g,""))}else{if(evt.memo.type=="user"){params+="&notify[ownername]="+evt.memo.title;params+="&notify[subname]="+escape(evt.memo.title.replace(/['"]/g,""))}else{if(evt.memo.type=="group"){params+="&notify[ownername]="+evt.memo.ownername;params+="&notify[subname]="+escape(evt.memo.title.replace(/['"]/g,""))}}}new Ajax.Request("/subscribe/"+this.type,{method:"POST",parameters:params,evalJSON:"force",onSuccess:this.handleSubmit.bindAsEventListener(this)})},editSubscription:function(evt){evt.memo.edit=1;this.fireLightboxByEditType(evt.memo)},fireLightboxByEditType:function(memo){if(PBLightbox.getInstance().panel.active){document.fire(PBLightbox.EVENT.DEACTIVATE)}this.type=memo.type;var contentVars="/subscriptionpanel/";contentVars+=(this.type==NotifyController.TYPE.SEARCH)?"search":"album";contentVars+="?"+Object.toQueryString(memo);document.fire(PBLightbox.EVENT.ACTIVATE,{contentUrl:contentVars,cache:false})},handleSubmitClick:function(evt){document.fire(PBLightbox.PBMessage.EVENT.CLOSE);if(!this.getFormValue("email")){this.fireErrorMessage("Please enter a valid email address.");return }if(this.isLoggedIn){if(!this.getFormValue("subname").replace(/^\s+/,"")){this.fireErrorMessage("Please enter a name.");return }if(this.getFormValue("subname").search(/[^\w- ]+/)>=0){this.fireErrorMessage("Names can only contain a-z, A-Z, 0-9, dashes, underscores, and spaces.");return }}else{if(!this.getFormValue("secret")){this.fireErrorMessage("Please try typing the code below again");return }}document.fire(PBLightbox.PBProgress.EVENT.ACTIVATE);new Ajax.Request("/subscribe/"+this.type,{method:"POST",parameters:Form.serialize(this.form),evalJSON:"force",onSuccess:this.handleSubmit.bindAsEventListener(this)})},handleSubmit:function(resp){var responseText=resp.responseText;var ro=resp.responseJSON;if(ro){if(ro.response.stat=="ok"){if(ro.response.reloaddisabled){document.location=document.location.href.replace(document.location.hash,"")}else{document.fire(PBLightbox.PBProgress.EVENT.DEACTIVATE);document.fire(PBLightbox.EVENT.DEACTIVATE);if(jq("#fullviewMessagePanel").length>0){var mpId="fullviewMessagePanel"}else{var mpId="MessagePanel"}document.fire(PBMessage.EVENT.NOTIFY,{id:mpId,message:new PBMessage({type:PBMessage.MESSAGE_TYPE.SUCCESS,title:ro.response.message.title,details:ro.response.message.details})});$(mpId).scrollTo();this.flipButtonState()}}else{document.fire(PBLightbox.PBProgress.EVENT.DEACTIVATE);if(ro.response.captchaKey){var key=ro.response.captchaKey;this.getFormElt("captcha").src="/captcha.php?session="+key;this.getFormElt("captchaKey").value=key;this.getFormElt("secret").value=""}document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:this.getMessage(ro)})}}else{document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage({type:PBMessage.MESSAGE_TYPE.ERROR,title:"Fatal Error",details:"No JSON response."})})}},handleDeleteNotification:function(evt){if(confirm("Are you sure you want to stop following this album? You will no longer receive notifications.")){var showProcessing=false;var obj=$(evt.memo.liObj);if(obj){this.deleteNotifyLI=evt.memo.liObj;this.listPanelDivId=evt.memo.listPanelDivId;this.listPanelId=evt.memo.listPanelId;this.listPanelOn=evt.memo.listPanelOn;this.deleteNotifyUL=$(this.deleteNotifyLI).up("ul");showProcessing=true}this.sendDeleteNotificationRequest(evt.memo.unsubscribeLink,showProcessing)}},sendDeleteNotificationRequest:function(unsubscribeLink,showProcessing){unsubscribeLink=unsubscribeLink.replace(/http:\/\/photobucket.com/i,"");var cacheBuster=Math.floor(Math.random()*10001);var params="type=edit&cb="+cacheBuster;if(showProcessing){Element.show("deleteNotificationProcessing")}new Ajax.Request(unsubscribeLink,{method:"GET",parameters:params,onSuccess:this.handleDeleteNotificationRequestSuccess.bindAsEventListener(this),onFailure:this.handleDeleteNotificationRequestFailure.bindAsEventListener(this)})},handleDeleteNotificationRequestSuccess:function(request){var responseText=request.responseText;var json=eval("("+responseText+")");if(json.response.stat=="ok"){document.location=document.location.href.replace(document.location.hash,"")}else{this.showDeleteNotifyErrorMessage()}},handleDeleteNotificationRequestFailure:function(request){Element.hide("deletedNotificationProcessing");this.showBlockErrorMessage()},showDeleteNotifyErrorMessage:function(){document.fire(PBMessage.EVENT.NOTIFY,{id:"MessagePanel",message:new PBMessage({details:"There was a problem deleting the subscription.",type:PBMessage.MESSAGE_TYPE.ERROR})});$("MessagePanel").scrollTo()},getFormValue:function(suffix){return $F(this.getFormId(suffix))},getFormElt:function(suffix){return $(this.getFormId(suffix))},getFormId:function(suffix){if(this.idPrefix){return this.idPrefix+"_"+suffix}else{return suffix}},isFieldChecked:function(suffix){var elt=this.getFormElt(suffix);if(!elt){return false}else{return elt.checked}},getMessage:function(ro){var m;if(ro.response.stat=="ok"){m=new PBMessage(ro.response.message);m.type=PBMessage.MESSAGE_TYPE.SUCCESS}else{m=new PBMessage(ro.response.message);m.type=PBMessage.MESSAGE_TYPE.ERROR}return m},toggleSubscriptionBoxOff:function(){$(this.listPanelId).remove();this.listPanelOn=false;return },setPanelSize:function(size){$(this.listPanelId).setStyle({height:size});return },fireErrorMessage:function(detailsStr){document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage({title:"Attention",details:detailsStr,type:PBMessage.MESSAGE_TYPE.ERROR})});return },registerButton:function(evt){this.toggleButton=true;this.toggleButtonId=evt.memo.inputId},flipButtonState:function(){if(this.toggleButton){var aBttn=$(this.toggleButtonId);aBttn.onclick="";aBttn.innerHTML="Following";aBttn.addClassName("disabled")}else{jq(".notifyContainer."+this.type).children().each(function(i){var obj=jq(this);if(obj.hasClass("followPlus")||obj.hasClass("add")){obj.hide()}else{obj.show()}});jq(".notifyContainer.secondarysearch").children().each(function(i){var obj=jq(this);if(obj.hasClass("followPlus")||obj.hasClass("add")){obj.hide()}else{obj.show()}})}}};var staticMembers={EVENT:{ADD:"NotifyController:add",EDIT:"NotifyController:edit",SUBMIT:"NotifyController:submit",DELETE:"NotifyController:delete",REGISTERBUTTON:"NotifyController:registerbutton"},TYPE:{USER:"user",GROUP:"group",SEARCH:"search"}};Controller.create("NotifyController",publicMembers,staticMembers)})();var BlockUserController=Class.create();BlockUserController.prototype={isGroup:false,ownerId:null,allUsersBlocked:false,staticBlockLink:null,albumURL:null,unBlockUL:null,unBlockSingleLI:null,blockUL:null,blockSingleLI:null,confirmText:null,blockText:null,listPanelOn:false,listPanelDivId:null,listPanelId:null,blockedHeaderTextId:"blockedHeaderText",blockedLinkTextId:"staticBlockLink",noSubscriberTextId:"containerUserSubscribers",fromEditSubscription:false,listPanelHeightMargin:"30",somethingChangedOnGroupOptionForm:false,initialize:function(A){for(var B in A){this[B]=A[B]}if(this.isGroup==0){this.confirmText="albums.";this.blockText=" my albums"}else{this.confirmText="group album.";this.blockText=" this group album"}this.staticBlockLink=$("staticBlockLink")},handleSingleUnblock:function(C,B,A,E,D){if(confirm("Are you sure you want to unblock this user?  If you do, the user will be able to follow your "+this.confirmText)){this.unBlockSingleLI=C;this.unBlockUL=$(this.unBlockSingleLI).up("ul");this.sendUnblockSingleRequest(B,A,E,D)}},sendUnblockSingleRequest:function(B,A,E,C){var D="action=singleunblock&blockingId="+B+"&blockedId="+A+"&userType="+E+"&albumType="+C;new Ajax.Request(this.albumURL,{method:"GET",parameters:D,onSuccess:this.handleSendUnblockSingleRequestSuccess.bind(this),onFailure:this.handleSendUnblockSingleRequestFailure.bind(this)})},handleSendUnblockSingleRequestSuccess:function(request){var responseText=request.responseText;var json=eval("("+responseText+")");if(json.response.stat=="ok"&&json.response.msg=="user unblocked"){document.location.reloaddisabled(true)}else{this.showBlockErrorMessage()}},handleSendUnblockSingleRequestFailure:function(A){this.showBlockErrorMessage()},handleSingleBlock:function(){if(confirm("Are you sure you want to block this user?  If you do, the user will no longer be able to follow your "+this.confirmText)){if(arguments.length>1){this.blockSingleLI=arguments[0];this.blockUL=$(this.blockSingleLI).up("ul");this.sendBlockSingleRequest(arguments[1],arguments[2],arguments[3])}else{var A=arguments[0];this.sendBlockSingleRequest(A.v,A.b,A.type)}}},sendBlockSingleRequest:function(C,B,A){var E="id="+C;if(A=="nonuser"){E+="&s_id="+B}else{E+="&b_id="+B}E+="&isGroup="+this.isGroup;var D=$("blockedSubscribersProcessing");if(D){Element.show("blockedSubscribersProcessing")}new Ajax.Request("/singleblock",{method:"GET",parameters:E,onSuccess:this.handleSendBlockSingleRequestSuccess.bind(this),onFailure:this.handleSendBlockSingleRequestFailure.bind(this)})},handleSendBlockSingleRequestSuccess:function(request){var responseText=request.responseText;var json=eval("("+responseText+")");var obj=$("blockedSubscribersProcessing");if(obj){Element.hide("blockedSubscribersProcessing")}if(json.response.stat=="ok"){document.location.reloaddisabled(true)}else{this.showBlockErrorMessage()}},handleSendBlockSingleRequestFailure:function(A){this.showBlockErrorMessage()},loaddisabledLBText:function(){var C=$("blockConfirmHeader");var B=$("blockConfirmText");if(this.isGroup==1){this.somethingChangedOnGroupOptionForm=(somethingChanged)}var A=(this.somethingChangedOnGroupOptionForm)?" and save your group album options?":"?";if(!this.allUsersBlocked){C.innerHTML="Block all users";B.innerHTML="Are you sure you want to block ALL users"+A+"  Users will NOT be able to follow your albums, and all followers will be removed from your "+this.confirmText}else{C.innerHTML="Unblock all users";B.innerHTML="Are you sure you want to unblock ALL users"+A+"  Users will be able to follow your "+this.confirmText}return },handleBlockLinkToggle:function(A){this.sendBlockToggleAjaxRequest()},sendBlockToggleAjaxRequest:function(){var B=Math.floor(Math.random()*10001);var A=(this.allUsersBlocked)?"/unblockall/":"/blockall/";A+=this.ownerId;var C="isGroup="+this.isGroup+"&cb="+B;new Ajax.Request(A,{method:"GET",parameters:C,onSuccess:this.handleToggleBlockSuccess.bind(this),onFailure:this.handleToggleBlockFailure.bind(this)})},handleToggleBlockSuccess:function(request){var responseText=request.responseText;var json=eval("("+responseText+")");if(json.response.stat=="ok"&&json.response.msg=="save success"){this.allUsersBlocked=json.response.blocked;document.fire(PBLightbox.EVENT.DEACTIVATE);if(this.somethingChangedOnGroupOptionForm){$("createalbumform").submit()}else{window.location.reloaddisabled(true)}}else{this.showBlockErrorMessage()}},handleToggleBlockFailure:function(A){this.showBlockErrorMessage()},toggleBlockLinkText:function(){if(this.allUsersBlocked&&this.listPanelOn){this.toggleBlockBoxOff()}if(!this.fromEditSubscription){var C=(this.allUsersBlocked)?"NO other users can subscribe to":"ALL users CAN subscribe to";$(this.blockedHeaderTextId).innerHTML=C+this.blockText;var A=(this.allUsersBlocked)?"Unblock all users":"Block all users"}else{var B=(this.allUsersBlocked)?"<p>No other users can subscribe to your albums.</p>":"<p>No one is subscribed to your albums.</p>";$(this.listPanelDivId).innerHTML=B;var A=(this.allUsersBlocked)?"Unblock all users":"Block all users from subscribing to my albums"}this.staticBlockLink.innerHTML=A;return },toggleBlockBoxOff:function(){$(this.listPanelId).remove();this.listPanelOn=false;$(this.listPanelDivId).addClassName("noBlockedUsers");return },toggleSubscribeBoxOff:function(){$(this.listPanelId).remove();this.listPanelOn=false;return },setPanelSize:function(A){$(this.listPanelId).setStyle({height:A});return },showBlockErrorMessage:function(){controllerMessagePanel.printMessage({message:"Attention",details:"There was a problem saving your settings.  Please try again later.",type:"error"});Element.scrollTo("MessagePanel")}};var PageEvent={CHANGE_PAGE:"pageEvent:changePage",NEXT:"pageEvent:nextPage",PREVIOUS:"pageEvent:prevPage"};var ControlEvent={SELECT:"controlEvent:select"};var MouseUtil;(function(){var A={initialize:function(){this.X=null;this.Y=null;this.isActive=false;this.mouseMove=this.onMouseMove.bindAsEventListener(this);this.observers=new Hash()},observe:function(C,D){if(this.observers.keys().length==0){this.startWatching()}this.observers.set(C,D)},stopObserving:function(C){this.observers.unset(C);if(this.observers.keys().length==0){this.stopWatching()}},isOver:function(G,F){if(G==null||typeof G=="undefined"){return false}if(this.X==null||this.Y==null){return false}var D=F||{T:0,R:0,B:0,L:0};var I=Element.cumulativeOffset(G);var H=Element.getDimensions(G);var E=((I.left-D.L<this.X)&&(this.X<(I.left+H.width+D.R)));var C=((I.top-D.T<this.Y)&&(this.Y<(I.top+H.height+D.B)));return(E&&C)},onMouseMove:function(C){this.X=Event.pointerX(C);this.Y=Event.pointerY(C);this.isActive=true;var E=this.observers.values();for(var D=0;D<E.length;D++){var F=E[D];if(typeof F=="function"){F(C)}}},startWatching:function(){Event.observe(document.body,"mousemove",this.mouseMove)},stopWatching:function(){Event.stopObserving(document.body,"mousemove",this.mouseMove);this.reset()},reset:function(){this.X=null;this.Y=null;this.isActive=false}};var B={};Controller.create("MouseUtil",A,B)})();(function(){var A={initialize:function(B){this.setDefaults();this.mixIn(B);this.keepOpenElem[this.keepOpenElem.length]=this.trigger;this.keepOpenElem[this.keepOpenElem.length]=this.panel;if(this.trigger&&this.panel){Event.observe(this.trigger,"mouseover",this.onMouseOver.bindAsEventListener(this));Event.observe(this.trigger,"mouseout",this.onMouseOut.bindAsEventListener(this));Event.observe(this.panel,"mouseover",this.onMouseOver.bindAsEventListener(this));Event.observe(this.panel,"mouseout",this.onMouseOut.bindAsEventListener(this))}},checkRequiredParams:function(B){if(B.trigger==null||B.panel==null){}},setDefaults:function(){this.trigger=null;this.panel=null;this.keepOpenElem=[];this.rndm=Math.random()*100000;this.delayOn=0;this.delayOff=0;this.mouseBuffer={T:0,R:0,B:0,L:0};this.mouseOverKey="pb_effect_flyout_over_"+this.rndm;this.mouseOutKey="pb_effect_flyout_out_"+this.rndm;this.mouseOutIEKey="pb_effect_flyout_out_ie_"+this.rndm;this.isOpen=false;this.useIframe=false;this.hoverClassName="hover";this.mouse=MouseUtil.getInstance();this.closeCallback=null;voidCallback=null},mixIn:function(B){this.checkRequiredParams(B);if(B.mouseBuffer){this.mouseBuffer=B.mouseBuffer}if(B.delayOn){this.delayOn=B.delayOn}if(B.delayOff){this.delayOff=B.delayOff}if(B.hoverClassName){this.hoverClassName=B.hoverClassName}if(B.trigger){this.trigger=B.trigger}if(B.panel){this.panel=B.panel}if(B.useIframe){this.useIframe=B.useIframe}if(B.keepOpenElem&&B.keepOpenElem[0]){this.keepOpenElem=$A(B.keepOpenElem)}if(B.closeCallback&&typeof B.closeCallback=="function"){this.closeCallback=B.closeCallback}if(voidCallback&&typeof voidCallback=="function"){voidCallback=voidCallback}}void:function(){this.panel.addClassName(this.hoverClassName);this.trigger.addClassName(this.hoverClassName);this.isOpen=true;if(voidCallback){voidCallback(this)}},close:function(){this.panel.removeClassName(this.hoverClassName);this.trigger.removeClassName(this.hoverClassName);this.isOpen=false;if(this.closeCallback){this.closeCallback(this.panel,this.trigger)}},onMouseOver:function(B){if(this.isOpen){return }if(this.delayOn>0){var C=this.mouseOverKey+(new Date()).getTime();this.mouse.observe(C);var D=function(){if(this.isMouseOver()){void()}this.mouse.stopObserving(C)};setTimeout(D.bind(this),this.delayOn)}else{void()}},onMouseOut:function(B){if(!this.isOpen){return }if(this.mouse.isActive&&!this.isMouseOver()&&this.delayOff==0){this.close();return }var C=this.mouseOutKey+(new Date()).getTime();this.mouse.observe(C);var D=function(){if(!this.isMouseOver()){this.close()}else{if(photobucket.browser.isIE6){var F=this.mouseOutIEKey+(new Date()).getTime();var E=function(){if(!this.isMouseOver()){this.close();this.mouse.stopObserving(F)}};this.mouse.observe(F,E.bind(this))}}this.mouse.stopObserving(C)};setTimeout(D.bind(this),this.delayOff)},isMouseOver:function(){var E=false;if(this.isOpen){for(var B=0;B<this.keepOpenElem.length;B++){var C=this.keepOpenElem[B];if(this.mouse.isOver(C,this.mouseBuffer)){E=true;break}}}else{E=(this.mouse.isOver(this.panel,this.mouseBuffer)||this.mouse.isOver(this.trigger,this.mouseBuffer))}if(this.isOpen&&!E&&this.panel.hasClassName("menuBar")){var D="menubar"}return E}};Object.extend(PB.Effect,{Flyout:Class.create(A)})})();
/*
 * jQuery BBQ: Back Button & Query Library - v1.2.1 - 2/17/2010
 * http://benalman.com/projects/jquery-bbq-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function($,P){var I,M=Array.prototype.slice,R=decodeURIComponent,A=$.param,C,L,V,B=$.bbq=$.bbq||{},Q,U,J,E=$.event.special,D="hashchange",a="querystring",d="fragment",Y="elemUrlAttr",G="location",K="href",T="src",X=/^.*\?|#.*$/g,W=/^.*\#/,H,c={};function e(f){return typeof f==="string"}function b(g){var f=M.call(arguments,1);return function(){return g.apply(this,f.concat(M.call(arguments)))}}function N(f){return f.replace(/^[^#]*#?(.*)$/,"$1")}function O(f){return f.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}function F(h,n,f,j,g){var p,m,l,o,k;if(j!==I){l=f.match(h?/^([^#]*)\#?(.*)$/:/^([^#?]*)\??([^#]*)(#?.*)/);k=l[3]||"";if(g===2&&e(j)){m=j.replace(h?W:X,"")}else{o=L(l[2]);j=e(j)?L[h?d:a](j):j;m=g===2?j:g===1?$.extend({},j,o):$.extend({},o,j);m=A(m);if(h){m=m.replace(H,R)}}p=l[1]+(h?"#":m||!l[1]?"?":"")+m+k}else{p=n(f!==I?f:P[G][K])}return p}A[a]=b(F,0,O);A[d]=C=b(F,1,N);C.noEscape=function(g){g=g||"";var f=$.map(g.split(""),encodeURIComponent);H=new RegExp(f.join("|"),"g")};C.noEscape(",/");$.deparam=L=function(j,f){var h={},g={"true":!0,"false":!1,"null":null};$.each(j.replace(/\+/g," ").split("&"),function(m,r){var l=r.split("="),q=R(l[0]),k,p=h,n=0,s=q.split("]["),o=s.length-1;if(/\[/.test(s[0])&&/\]$/.test(s[o])){s[o]=s[o].replace(/\]$/,"");s=s.shift().split("[").concat(s);o=s.length-1}else{o=0}if(l.length===2){k=R(l[1]);if(f){k=k&&!isNaN(k)?+k:k==="undefined"?I:g[k]!==I?g[k]:k}if(o){for(;n<=o;n++){q=s[n]===""?p.length:s[n];p=p[q]=n<o?p[q]||(s[n+1]&&isNaN(s[n+1])?{}:[]):k}}else{if($.isArray(h[q])){h[q].push(k)}else{if(h[q]!==I){h[q]=[h[q],k]}else{h[q]=k}}}}else{if(q){h[q]=f?I:""}}});return h};function Z(h,f,g){if(f===I||typeof f==="boolean"){g=f;f=A[h?d:a]()}else{f=e(f)?f.replace(h?W:X,""):f}return L(f,g)}L[a]=b(Z,0);L[d]=V=b(Z,1);$[Y]||($[Y]=function(f){return $.extend(c,f)})({a:K,base:K,iframe:T,img:T,input:T,form:"action",link:K,script:T});J=$[Y];function S(j,g,h,f){if(!e(h)&&typeof h!=="object"){f=h;h=g;g=I}return this.each(function(){var m=$(this),k=g||J()[(this.nodeName||"").toLowerCase()]||"",l=k&&m.attr(k)||"";m.attr(k,A[j](l,h,f))})}$.fn[a]=b(S,a);$.fn[d]=b(S,d);B.pushState=Q=function(j,f){if(e(j)&&/^#/.test(j)&&f===I){f=2}var h=j!==I,g=C(P[G][K],h?j:{},h?f:2);P[G][K]=g+(/#/.test(g)?"":"#")};B.getState=U=function(f,g){return f===I||typeof f==="boolean"?V(f):V(g)[f]};B.removeState=function(f){var g={};if(f!==I){g=U();$.each($.isArray(f)?f:arguments,function(j,h){delete g[h]})}Q(g,2)};E[D]=$.extend(E[D],{add:function(f){var h;function g(k){var j=k[d]=C();k.getState=function(l,m){return l===I||typeof l==="boolean"?L(j,l):L(j,m)[l]};h.apply(this,arguments)}if($.isFunction(f)){h=f;return g}else{h=f.handler;f.handler=g}}})})(jQuery,this);
/*
 * jQuery hashchange event - v1.2 - 2/11/2010
 * http://benalman.com/projects/jquery-hashchange-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function($,I,B){var J,K=$.event.special,C="location",D="hashchange",L="href",F=$.browser,G=document.documentMode,H=F.msie&&(G===B||G<8),E="on"+D in I&&!H;function A(M){M=M||I[C][L];return M.replace(/^[^#]*#?(.*)$/,"$1")}$[D+"Delay"]=100;K[D]=$.extend(K[D],{setup:function(){if(E){return false}$(J.start)},teardown:function(){if(E){return false}$(J.stop)}});J=(function(){var M={},R,N,O,Q;function P(){O=Q=function(S){return S};if(H){N=$('<iframe src="javascript:0"/>').hide().insertAfter("body")[0].contentWindow;Q=function(){return A(N.document[C][L])};O=function(U,S){if(U!==S){var T=N.document;void().close();T[C].hash="#"+U}};O(A())}}M.start=function(){if(R){return }var T=A();O||P();(function S(){var V=A(),U=Q(T);if(V!==T){O(T=V,U);$(I).trigger(D)}else{if(U!==T){I[C][L]=I[C][L].replace(/#.*/,"")+"#"+U}}R=setTimeout(S,$[D+"Delay"])})()};M.stop=function(){if(!N){R&&clearTimeout(R);R=0}};return M})()})(jQuery,this);var FullViewController;(function(){var A={trackingPrefix:"fullview",nMediaWidth:0,nMediaHeight:0,scalePercentageShown:true,initialize:function(){document.observe(FullViewPaginatorController.EVENT.PRIMARY_UPDATE,this.onPagination.bindAsEventListener(this))},bindHandlers:function(){this.eltScaledPercentage=$("scaledPercentage");this.eltFullSizedImage=$("fullSizedImage");this.eltFullImage=$("fullImage");this.eltZoomedLink=$("zoomedLink");this.eltFullViewContainer=$("fullViewContainer");this.eltContainerZoomedImage=$("containerZoomedImage");this.eltZoomedOffsetContainer=$("zoomedOffsetContainer");this.mediaContainer=$("containerMedia");this.mediaZoomedContainer=$("containerZoomedImage");this.border=$("borderedImage");this.widthPage=jq("#widthPage");if(this.eltScaledPercentage.innerHTML!="100%"){this.enableImageZoom()}else{this.disableImageZoom()}Event.observe(document,FullViewController.EVENT.ZOOMIN,this.handleInPageZoom.bindAsEventListener(this));Event.observe(document,FullViewController.EVENT.ZOOMOUT,this.handleCloseInPageZoom.bindAsEventListener(this));Event.observe(document,FullViewController.EVENT.SCALEOVER,this.onScaleOver.bindAsEventListener(this));Event.observe(document,FullViewController.EVENT.SCALEOUT,this.onScaleOut.bindAsEventListener(this))},onPagination:function(D){var C=D.memo;this.strMediaType=C.type;this.disableImageZoom()},onScaleOver:function(){if(this.scalePercentageShown){this.eltScaledPercentage.show()}},onScaleOut:function(){this.eltScaledPercentage.hide()},enableImageZoom:function(){if(this.isImage()){if(this.mediaContainer){this.mediaContainer.observe("click",this.handleInPageZoom.bindAsEventListener(this))}if(this.border){this.border.observe("click",this.handleInPageZoom.bindAsEventListener(this))}if(this.eltZoomedLink){this.eltZoomedLink.observe("click",this.handleCloseInPageZoom.bindAsEventListener(this))}if(this.mediaZoomedContainer){this.mediaZoomedContainer.observe("click",this.handleCloseInPageZoom.bindAsEventListener(this))}this.scalePercentageShown=true}else{this.disableImageZoom()}},disableImageZoom:function(){if(this.mediaContainer){this.mediaContainer.stopObserving("click")}if(this.border){this.border.stopObserving("click")}if(this.eltZoomedLink){this.eltZoomedLink.stopObserving("click")}if(this.mediaZoomedContainer){this.mediaZoomedContainer.stopObserving("click")}this.scalePercentageShown=false},handleInPageZoom:function(E){if(!E.memo){APIRequest.track(this.trackingPrefix+"_click_zoom_image")}if(this.isImage()){APIRequest.track(this.trackingPrefix+"_click_zoom");if(this.eltContainerZoomedImage&&this.eltFullViewContainer&&this.eltFullImage&&this.eltZoomedOffsetContainer){var C=this.nMediaWidth;if(E.memo){if(E.memo.url){this.eltFullImage.src=E.memo.url}if(E.memo.width){C=E.memo.width}}if(C<600){var D=600-C;this.eltZoomedOffsetContainer.setStyle({paddingLeft:D+"px"});this.eltContainerZoomedImage.setStyle({width:"600px"})}else{this.eltZoomedOffsetContainer.setStyle({paddingLeft:"0px"});this.eltContainerZoomedImage.setStyle({width:C+"px"})}this.toggleOverflow();Element.show(this.eltContainerZoomedImage);Element.hide(this.eltFullViewContainer)}this.widthPage.css("overflow","visible")}},handleCloseInPageZoom:function(C){if(this.eltContainerZoomedImage&&this.eltFullViewContainer){this.toggleOverflow();Element.hide(this.eltContainerZoomedImage);Element.show(this.eltFullViewContainer);if(this.eltFullImage){this.eltFullSizedImage=$("fullSizedImage");this.eltFullImage.src=this.eltFullSizedImage.src}this.widthPage.css("overflow","hidden")}return false},toggleOverflow:function(){var C=$("widthPage");var D=(C.style.overflow==""||C.style.overflow=="hidden")?"visible":"hidden";C.style.overflow=D},isImage:function(){return(this.strMediaType=="image"||this.strMediaType=="picture")}};var B={EVENT:{ZOOMIN:"FullViewController:zoomin",ZOOMOUT:"FullViewController:zoomout",SCALEOVER:"FullViewController:scaleover",SCALEOUT:"FullViewController:scaleout"}};Controller.create("FullViewController",A,B)})();var FullViewMediaController;(function(){var A={scaledImage:null,fullImage:null,staticServer:"",hasBorder:false,spacer:"httpdisabled://pic.pbsrc.com/spacer.gif",slideshowPlayer:"httpdisabled://photobucket.com/pbwidget.swf",isFullview:true,secondaryDataKeys:[],requiredFlashVersion:8,prevImage:null,disableRightClick:false,maxHeight:null,maxWidth:null,minHeight:null,minWidth:null,videoOverlayAdUrl:null,init:null,initialize:function(){document.observe(FullViewPaginatorController.EVENT.PRIMARY_UPDATE,this.onPagination.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.FULL_UPDATE,this.onPagination.bindAsEventListener(this));this.xid=null},findContainers:function(){this.fullImage=$("fullImage");this.mediaWrapper=$("imgEnv-fullSizedImage");this.border=$("borderedImage");this.borderToggle=jq("#containerMedia .menuTrigger");this.containerMedia=$("containerMedia");this.scaleContainer=$("scaledPercentage");this.fbContainer=jq("#fbContainer");this.tagSearchContainer=jq(".containerTagSearch");this.reportAbuseContainer=jq("#containerReportAbuse");this.mediaContainer=$("mediaContainer")},onPagination:function(D){if(this.init==null){this.findContainers();this.init=true}var C=D.memo;this.xid=C.xid;this.updatePageTitle(C);this.updateComments(C);this.updateSearchLinks(C);this.updateReportAbuse(C);this.containerMedia.setStyle({height:"auto",width:"auto"});if(C.type=="image"){this.toggleBorder(true);FullViewController.getInstance().enableImageZoom();this.imageInit(C)}else{if(C.type=="video"||C.type=="video_h264"){this.toggleBorder(false);FullViewController.getInstance().disableImageZoom();this.updateMediaWrapper(600+"px",361+"px");this.flashVideoPlayerInit(C.src,C.type)}else{if(C.type=="slideshow"){this.toggleBorder(false);FullViewController.getInstance().disableImageZoom();this.updateMediaWrapper(480+"px",360+"px");this.flashSlideshowInit(C.src)}else{if(C.type=="flash"){this.toggleBorder(false);FullViewController.getInstance().disableImageZoom();this.updateMediaWrapper("auto","auto",C.src)}}}}},scaleImage:function(T,U){this.scaledImage.setStyle({visibility:"hidden"});this.scaledImage.src=T.src;var M="100%";var L=T.height;var N=T.width;var S=L;var O=N;var Q=0;var D=0;var F=0;var J=0;var K=0;var P=0;if(this.hasBorder){K=parseInt(this.border.getStyle("padding-top"));P=parseInt(this.border.getStyle("padding-left"));if(isNaN(K)){K=0}else{Q=K*2;K=30}if(isNaN(P)){P=0}else{D=P*2;P=30}}var G=this.maxWidth-P;var I=this.maxHeight-K;if(N>G){O=G;S=Math.floor(L*G/N)}else{if(L>I){S=I;O=Math.floor(N*I/L)}}if(O==0){O=this.maxHeight}if(S==0){S=15}var E=O;var R=S;if(E<this.minWidth&&E>0){E=this.minWidth;J=(this.minWidth-N)/2}if(R<this.minHeight&&R>0){R=this.minHeight;F=(this.minHeight-L)/2}if(this.hasBorder){this.border.setStyle({height:R+"px",width:E+"px"})}this.scaledImage.setStyle({height:S+"px",width:O+"px"});this.mediaWrapper.setStyle({height:S+Q+"px",width:O+D+"px"});this.mediaContainer.setStyle({padding:F+"px "+J+"px"});this.scaledImage.setStyle({visibility:"visible"});var C=O/N;if(C<1){M=Math.floor(C*100)+"%"}this.scaleContainer.update(M);var H=FullViewController.getInstance();H.urlMedia=T.src;H.nMediaWidth=N;H.nMediaHeight=L;H.strMediaType="image";if(C<1){FullViewController.getInstance().enableImageZoom()}else{FullViewController.getInstance().disableImageZoom()}if(this.disableRightClick){new PB.Util.NoRightClick({elem:"fullImage"});new PB.Util.NoRightClick({elem:"fullSizedImage"})}},imageInit:function(D){jq(this.mediaWrapper).html('<img id="fullSizedImage" class="media" galleryimg="no" alt="" src="'+this.spacer+'"/>');this.scaledImage=$("fullSizedImage");var C=new Image();C.src=D.src+((typeof (D.cacheBust)!="undefined")?"?t="+D.cacheBust:"");if(C.height==0&&C.width==0){if(this.prevImage){Event.stopObserving(this.prevImage)}this.prevImage=C;Event.observe(C,"loaddisabled",function(){if(D.searchTerm){if(typeof (gomez)!="undefined"){gomez.nameEvent("MediaDetailCacheImage")}}else{if(typeof (gomez)!="undefined"){gomez.nameEvent("FullViewCacheImage")}}this.scaleImage(C,D.xid)}.bind(this))}else{this.scaleImage(C,D.xid)}this.fullImage.src=D.src},flashVideoPlayerInit:function(C,E){C=C.split("?file=")[1];var D=new SWFObject(this.staticServer+"/flash/onSiteVideo.swf?file="+C+"&os=1&ap=1","mymovie",600,361,"6.0.65","#FFFFFF");D.addParam("wmode","transparent");D.addParam("allowScriptAccess","always");D.addParam("allowNetworking","all");D.addParam("allowFullscreen","true");if(this.videoOverlayAdUrl){var F=this.videoOverlayAdUrl;var G=Math.floor(Math.random()*899999)+100000;F=F.replace(/random=\d+\//,"random="+G+"/");D.addVariable("overlayAdURL",F)}if(!void("flashcontent")){if(jq.browser.webkit&&E=="video_h264"){C=C.split("&t=")[0];jq("#flashcontent").html("<video src="+C+" controls='controls' autoplay='autoplay' width='600' height='360'/>")}else{voidFlashRequirement("flashcontent","video")}}},flashSlideshowInit:function(C){var D=new SWFObject(C,"mymovie",480,360,"6.0.65","#FFFFFF");D.addParam("wmode","transparent");if(!void("flashcontent")){voidFlashRequirement("flashcontent","slideshow")}}voidFlashRequirement:function(F,D){if(this.requiredFlashVersion>0){var C="<br><br><b>This "+D+" requires Flash "+this.requiredFlashVersion+' or newer. Go to <a target="blank" class="link" href="httpdisabled://www.abode.com/go/getflash"><u> http://www.adobe.com/go/getflash</u></a> to get it!</b><br><br><br>';var E=document.getElementById(F);E.innerHTML=C;$(E).css("color","red")}},toggleBorder:function(C){if(C){this.borderToggle.addClass("ninepoint")}else{this.borderToggle.removeClass("ninepoint")}},updateMediaWrapper:function(C,F,G){var E=(G)?'<embeddisabled type="application/x-shockwave-flash" wmode="transparent" src="'+G+'" class="media">':'<div id="flashcontent"></div>';var D=jq(this.mediaWrapper);D.css("height",F);D.css("width",C);D.html(E)},updatePageTitle:function(E){var C=document.title;var F=E.title?E.title:E.filename;var D=(C.indexOf("::")!=-1);if(D){C=C.substring(0,C.indexOf("::")+2);C+=" "+F+" "+E.type+" by "+E.owner+" - Photobucket"}else{C=F+" "+E.type+" by "+E.owner+" - Photobucket"}document.title=C},updateSearchLinks:function(E){if(!this.tagSearchContainer){this.findContainers()}if(this.tagSearchContainer){if(E.searchTerm&&E.searchTerm!=""){this.tagSearchContainer.css("display","none")}else{if(typeof (E.title)=="undefined"||E.title==""){this.tagSearchContainer.css("display","none")}else{if(E.type=="image"||E.type=="video"){var C=(E.type=="image")?"photos":"videos";var D='Search for more <a href="/'+E.type+"s/";D+=encodeURIComponent(E.title)+'">'+E.title+" "+C+"</a>";this.tagSearchContainer.html(D);this.tagSearchContainer.css("display","block")}}}}},updateReportAbuse:function(E){if(this.reportAbuseContainer.length>0){var C=E.type;if(C=="image"||C=="video"){this.reportAbuseContainer.show();var D=(C=="video")?E.src.substring(E.src.indexOf("=")+1):E.src;activateReportAbuseLink(D,C,C)}else{this.reportAbuseContainer.hide()}}},updateComments:function(G){if(!this.fbContainer.length>0){return }var H,F,L,D,P,K,N,O,I;H=G.xid;F=G.browseUrl;L=G.thumbUrl;D=G.filename;P=(G.title)?G.title:"";K=G.owner;N=G.type;I=this.fbContainer.width();var M=jq("meta");for(var J=0;J<M.length;J++){var E=M[J].getAttribute("property");switch(E){case"og:title":O=((P!="")?P:D)+" "+N+" by "+K+" on Photobucket";M[J].setAttribute("content",O);break;case"og:image":M[J].setAttribute("content",L);break;case"og:url":M[J].setAttribute("content",F);break}}var C='<div id="fbContent"><fb:comments migrated="1"';C+='xid="'+H+'" ';C+='numposts="10" ';C+='width="'+I+'" ';C+='title="'+O+'" ';C+='url="'+F+'" /></div>';var Q=document.getElementById("fbContent");if(Q){this.fbContainer.get(0).removeChild(Q)}this.fbContainer.get(0).innerHTML=C;setTimeout(function(){FB.XFBML.parse()},1000)}};var B={};Controller.create("FullViewMediaController",A,B)})();var FullViewPaginatorController;(function(){var A={isSearch:false,isLoggedIn:false,secondaryDataKeys:[],ajaxReq:null,init:false,initialize:function(){document.observe(CorePaginationController.EVENT.UPDATE,this.onPagination.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.CLEAR_CACHE,this.onClearCache.bindAsEventListener(this));document.observe("editor:changed",this.onClearCache.bindAsEventListener(this));this.xid=null},findContainers:function(){this.count=$("mediaIndexNumber");this.prevButton=jq("#prevButton");this.nextButton=jq("#nextButton");this.loaddisableding=jq("#navLoading")},onPagination:function(G){if(!this.init){this.findContainers();this.init=true}if(this.ajaxReq){this.ajaxReq.abort()}this.hideMessages();var E=G.memo.currentpage;var F=G.memo.cacheUpdate["1"];if(this.count){this.count.innerHTML=G.memo.currentpage}this.updatePaginationButtons(G.memo);this.xid=F.xid;var C=this.getSecondaryData(F.xid);if(C){this.loaddisableding.hide();jq.extend(F,C);this.fireUpdate(FullViewPaginatorController.EVENT.FULL_UPDATE,F)}else{if(this.isSearch){if(G.memo.searchTerm){F.searchTerm=G.memo.searchTerm}}this.fireUpdate(FullViewPaginatorController.EVENT.PRIMARY_UPDATE,F);this.loaddisableding.show();var D=F.browseUrl+"&fetchMetaData=true&isSearch="+this.isSearch+"&cb="+(new Date()).getTime();if(this.isSearch){if(G.memo.searchTerm){D+="&term="+G.memo.searchTerm;D+="&o="+E}}this.ajaxReq=jq.ajax({url:D,dataType:"jsonp",jsonp:"jsoncallback",success:function(I){var H=I.response;this.putSecondaryData(F.xid,H);if(this.xid==H.xid){this.fireUpdate(FullViewPaginatorController.EVENT.SECONDARY_UPDATE,H);this.loaddisableding.hide()}}.bind(this)})}if(this.isSearch&&typeof (SharePanelController)!="undefined"){}this.track(F)},fireUpdate:function(E,D){if(this.xid==D.xid){var C=jq.Event(E);C.memo=D;jq(document).trigger(C);document.fire(E,D)}},getSecondaryData:function(C){return jq("body").data(C)},putSecondaryData:function(D,E){jq("body").data(D,E);this.secondaryDataKeys[this.secondaryDataKeys.length]=D;if(this.secondaryDataKeys.length>100){var C=this.secondaryDataKeys.shift();jq("body").removeData(C)}},onClearCache:function(C){jq("body").removeData(this.xid)},updatePaginationButtons:function(C){if(C.currentpage==1){this.prevButton.removeClass("blue");this.prevButton.addClass("disabled")}else{this.prevButton.removeClass("disabled");this.prevButton.addClass("blue")}if(C.currentpage==C.totalpages||C.currentpage>=2000){this.nextButton.addClass("disabled");this.nextButton.removeClass("blue")}else{this.nextButton.removeClass("disabled");this.nextButton.addClass("blue")}},track:function(F){if(typeof (_gaq)!="undefined"){_gaq.push(["_trackPageview"])}if(this.isSearch){APIRequest.track("media_detail_views");if(typeof (gomez)!="undefined"){gomez.nameEvent("MediaDetailPaginate");gomez.nameEvent("media_detail_view")}var C=F.searchUrl}else{APIRequest.track("fullview_views");if(typeof (gomez)!="undefined"){gomez.nameEvent("FullViewPaginate");gomez.nameEvent("fullview_view")}var C=F.browseUrl}if(this.isLoggedIn){APIRequest.track("page_view_logged_in")}else{APIRequest.track("page_view_logged_out")}APIRequest.track("page_view");try{var D=C;var G=D.split("?",1);COMSCORE.beacon({c1:2,c2:6034695,c3:"",c4:G[0],c5:"",c6:"",c15:""})}catch(E){self.log("ERROR: failed to track comscore for offset ")}},hideMessages:function(){var C=jq("#fullviewMessagePanel");if(C.css("display")!="none"){C.hide()}}};var B={EVENT:{PRIMARY_UPDATE:"FullViewPaginatorController:initialupdate",SECONDARY_UPDATE:"FullViewPaginatorController:secondaryupdate",FULL_UPDATE:"FullViewPaginatorController:fullupdate",CLEAR_CACHE:"FullViewPaginatorController:clearcache"}};Controller.create("FullViewPaginatorController",A,B)})();jq(document).ready(function(){function A(){this.currentOffset=null;this.loggingOn=false;this.amper="QQ";this.eq="ZZ";this.googleHashingEnabled=true}jq.extend(A.prototype,{onChange:function(F){var E=jq.param.fragment();var B=_pb.history;if(B.googleHashingEnabled){E=E.substring(1)}var G=B.getParams(E);if(G.o){var D=new Number(G.o),C=new Number(B.currentOffset);if(D!=C){B.updatePage(D.valueOf())}}else{B.resetPage()}},getParams:function(F){try{F=F.split(this.amper);var E=new Array();for(var B=0;B<F.length;B++){var C=F[B].split(this.eq);if(C.length==2){E[C[0]]=decodeURIComponent(C[1])}}return E}catch(D){this.log("ERROR: failed to get params: "+D)}},add:function(D){var C=(this.googleHashingEnabled)?"#!":"#";for(var B in D){C+=B+this.eq+encodeURIComponent(D[B])+this.amper}if(D.o){this.currentOffset=D.o}C=C.substring(0,C.length-this.amper.length);document.location.hash=C},updatePage:function(C){var B=CorePaginationController.getInstance();if(B){B.pageChangeHandler({memo:{page:C}});this.currentOffset=C}else{this.log("ERROR: no access to CorePaginationController!")}},resetPage:function(){var B=CorePaginationController.getInstance();if(B){B.resetPage();this.currentOffset=null}else{this.log("ERROR: no access to CorePaginationController!")}},log:function(C){if(this.loggingOn){try{console.log(C)}catch(B){alert(C)}}}});_pb.history=new A();jq(window).bind("hashchange",_pb.history.onChange)});var FullViewMenuController;(function(){var B={trackingPrefix:"fullview",urlMedia:null,init:false,initialize:function(){FullViewMenuController.initialize();document.observe(FullViewPaginatorController.EVENT.PRIMARY_UPDATE,this.onPagination.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.SECONDARY_UPDATE,this.onSecondaryData.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.FULL_UPDATE,this.onFullData.bindAsEventListener(this))},findContainers:function(){this.zoomedInMenuContainer=jq("#zoomedInMenuContainer");this.zoomedOutMenuContainer=jq("#zoomedOutMenuContainer")},onPagination:function(D){if(!this.init){this.findContainers();this.init=true}FullViewMenuController.destroy()},onSecondaryData:function(E){var D=E.memo;this.zoomedInMenuContainer.html(D.zoomedIn);this.zoomedOutMenuContainer.html(D.zoomedOut);StyleGuideMenuController.initialize("zoomedInMenu");StyleGuideMenuController.initialize("zoomedOutMenu");FullViewMenuController.initialize()},onFullData:function(D){this.onPagination(D);this.onSecondaryData(D)},handleZoom:function(D){if(D.mode=="in"){document.fire(FullViewController.EVENT.ZOOMIN,{fromMenu:true,url:D.url,width:D.width});APIRequest.track("view_menu_"+D.tracking)}else{document.fire(FullViewController.EVENT.ZOOMOUT,{fromMenu:true});APIRequest.track(this.trackingPrefix+"_click_zoom_menu")}},handleShare:function(){APIRequest.track(this.trackingPrefix+"_click_share")},handleShareEmail:function(){tr(this.trackingPrefix+" share menu email click")},handleSharePanel:function(D){var E;switch(D.tabType){case"SharePanelController:easy":E="website";break;case"SharePanelController:email":E="email";break;default:E="mobile";break}tr(this.trackingPrefix+" share menu "+E+" click");pb_share_manager.getSharePanel(D)},handleMobile:function(){document.fire(SharePanelController.EVENT.SHOW,{tabType:SharePanelController.TYPE.MOBILE,mediaUrl:this.urlMedia});APIRequest.track(this.trackingPrefix+"_click_mobile")},handleSave:function(D){document.fire(SaveToAlbumController.EVENT.ACTIVATE,D);if(D.tracking){tr(D.tracking)}},handleDownloaddisabled:function(D){tr(this.trackingPrefix+" click downloaddisabled");window.location.href=D.url},handleComment:function(){document.fire(FullViewController.EVENT.ZOOMOUT,{fromMenu:true});document.location="#comments";$("addContent").activate()},handleRotate:function(D){var E=$("degrees");if(E){E.value=D.degrees;this.submit("rotate")}},handleResize:function(D){var E=confirm("You are about to resize this photo.\n\nAre you sure you want to do this?");if(E){var F=$("size");if(F){F.value=(D.w>D.h)?D.w:D.h;this.submit("resize")}}},handleSkinitPrint:function(D){if(D.tracking){APIRequest.track(this.trackingPrefix+"_click_"+D.tracking)}void(D.url);return false},handlePrint:function(E){if(E.tracking){APIRequest.track(this.trackingPrefix+"_click_"+E.tracking)}var D=(E.service!="")?"&extra=|"+E.service+"|||":"";var F=(E.serviceToken!="")?"&service_token="+E.serviceToken:"";document.location="httpdisabled://www.qoop.com/photobooks/pb_user/pblogin.php?"+D+F},handleViewAlbum:function(){APIRequest.track(this.trackingPrefix+"_click_view_album")},submit:function(D){jq("#formFullView").append('<input id="action" type="hidden" name="action" value="'+D+'"/>');$("formFullView").submit()},submitKodak:function(H){var I=H;var E=$("dynaForm");var D=$("ofoto_xml");var G=$("kodakSourceId");if(G){G=G.value}if(I&&E&&D&&G&&this.urlMedia){I=I.toLowerCase();var F=new KodakPartnerPurchase(G,KodakPartnerPurchase.LOCALE.EN_US,I);F.addImage(new KodakImage(this.urlMedia));var J=F.getXML();D.value=J;E.submit()}}};var C={initialize:function(){jq("table.menuBar").each(function(E,D){new A(D)})},destroy:function(){jq("#zoomedInMenu").remove();jq("#zoomedOutMenu").remove()}};Controller.create("FullViewMenuController",B,C);var A=Class.create({initialize:function(D){this.menubar=jq(D);this.wrapper=this.menubar.parent().parent();jq(this.wrapper).hoverIntent({over:this.onMenu.bind(this),out:this.offMenu.bind(this),interval:50})},onMenu:function(D){this.menubar.addClass("hover");document.fire(FullViewController.EVENT.SCALEOVER)},offMenu:function(D){this.menubar.removeClass("hover");document.fire(FullViewController.EVENT.SCALEOUT)}})})();var DeleteActionController;(function(){var B={EVENT:{DELETE:"PB:DeleteActionController_DELETE",DODELETE:"PB:DeleteActionController_DODELETE"}};var A={ajaxAction:false,actionType:"album",selected:[],notify:"MessagePanel",initialize:function(){Event.observe(document,DeleteActionController.EVENT.DELETE,this.onDelete.bindAsEventListener(this));Event.observe(document,DeleteActionController.EVENT.DODELETE,this.doDelete.bindAsEventListener(this))},onDelete:function(E){this.selected=E.memo.selected;this.ajaxAction=E.memo.ajaxActions;if(E.memo.notify){this.notify=E.memo.notify}if(E.memo.albumType){this.albumType=E.memo.albumType}var C=new Array();if(this.selected.length>0){this.selected.each(function(F){C.push(Object.toJSON(F))});var D={"selectedmedia[]":C,albumUrl:E.memo.albumUrl};if(E.memo.warnings){D.warnings=E.memo.warnings}if(E.memo.returnUrl){D.returnUrl=E.memo.returnUrl}if(E.memo.displayThumbnailBar){D.displayThumbnailBar=E.memo.displayThumbnailBar}if(E.memo.actionType){D.actionType=E.memo.actionType;this.actionType=E.memo.actionType}document.fire(PBLightbox.EVENT.ACTIVATE,{contentUrl:"/deleteaction",parameters:D,initialHeight:240,cache:false});this.bindKeyHandlers()}else{document.fire(PBMessage.EVENT.NOTIFY,{gotoHash:true,id:this.notify,message:new PBMessage({type:PBMessage.MESSAGE_TYPE.ERROR,title:"No files selected."})})}},doDelete:function(E){document.fire(PBLightbox.PBProgress.EVENT.ACTIVATE);if(this.actionType=="fullview"){tr("fullview_click_delete")}else{if(this.albumType){tr(this.albumType+"_album_bulk_action_delete_submit")}else{if(this.selected.length==1){tr("album_thumb_delete_submit")}}}if(this.ajaxAction){var D=$("deleteActionForm").serialize(true);D.action="ajaxdelete";new Ajax.Request($("deleteActionForm").getAttribute("action"),{method:"POST",parameters:D,evalJSON:"force",onSuccess:this.deleteHandler.bind(this)})}else{var C=jq("#deleteActionForm");C.find('input[name="positionHash"]').val(document.location.hash);jq("#deleteActionForm").submit()}},deleteHandler:function(F){var D=F.responseJSON;var C=D.response.message;var E=D.response.redir;if(D&&D.response.stat=="ok"){C.type=PBMessage.MESSAGE_TYPE.SUCCESS;if(typeof BulkActionsController!="undefined"){document.fire(BulkActionsController.EVENT.REMOVE,{selected:this.selected})}this.selected=[]}else{C.type=PBMessage.MESSAGE_TYPE.ERROR}document.fire(PBLightbox.PBProgress.EVENT.DEACTIVATE);this.unbindKeyHandlers();document.fire(PBLightbox.EVENT.DEACTIVATE);document.fire(PBMessage.EVENT.NOTIFY,{gotoHash:true,id:this.notify,message:new PBMessage(C)});if(E!==undefined){window.location.href=E}},keyHandler:function(C){if(C.keyCode==13){document.fire(DeleteActionController.EVENT.DODELETE)}},bindKeyHandlers:function(){this.windowObj=(photobucket.browser.isIE)?jq(document):jq(window);this.windowObj.keyup(this.keyHandler)},unbindKeyHandlers:function(){this.windowObj.unbind("keyup",this.keyHandler)}};Controller.create("DeleteActionController",A,B)})();var MoveAcionController;(function(){var B={EVENT:{MOVE:"PB:MoveActionController_MOVE",DOMOVE:"PB:MoveActionController_DOMOVE"}};var A={ajaxAction:false,actionType:"album",selected:[],albumUrl:null,notify:"MessagePanel",initialize:function(){Event.observe(document,MoveActionController.EVENT.MOVE,this.onMove.bindAsEventListener(this));Event.observe(document,MoveActionController.EVENT.DOMOVE,this.doMove.bindAsEventListener(this))},onMove:function(E){this.selected=E.memo.selected;this.ajaxAction=E.memo.ajaxActions;if(E.memo.notify){this.notify=E.memo.notify}if(E.memo.albumType){this.albumType=E.memo.albumType}var C=new Array();if(this.selected.length>0){this.selected.each(function(F){C.push(Object.toJSON(F))});this.albumUrl=E.memo.albumUrl;var D={"selectedmedia[]":C,albumUrl:this.albumUrl};if(E.memo.warnings){D.warnings=E.memo.warnings}if(E.memo.returnUrl){D.returnUrl=E.memo.returnUrl}if(E.memo.displayThumbnailBar){D.displayThumbnailBar=E.memo.displayThumbnailBar}if(E.memo.actionType){D.actionType=E.memo.actionType;this.actionType=E.memo.actionType}document.fire(PBLightbox.EVENT.ACTIVATE,{contentUrl:"/moveaction",parameters:D,initialHeight:320,cache:false});this.bindKeyHandlers()}else{document.fire(PBMessage.EVENT.NOTIFY,{gotoHash:true,id:this.notify,message:new PBMessage({type:PBMessage.MESSAGE_TYPE.ERROR,title:"No items selected."})})}},doMove:function(G){var C=jq("#moveActionForm input[name='origLoc']").val();var D=jq("#moveActionForm input[name='destination_album']").val();if(D==C){document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage({type:PBMessage.MESSAGE_TYPE.ERROR,title:"Cannot move file(s) to the same album.",details:"Try <a href='"+this.albumUrl+"?action=organize'>organize</a>, if you would like to re-order your files."})})}else{document.fire(PBLightbox.PBProgress.EVENT.ACTIVATE);if(this.actionType=="fullview"){tr("fullview_click_move")}else{if(this.albumType){tr(this.albumType+"_album_bulk_action_move_submit")}else{if(this.selected.length==1){tr("album_thumb_move_submit")}}}if(this.ajaxAction){var F=$("moveActionForm").serialize(true);F.action="ajaxmove";new Ajax.Request(jq("#moveActionForm").attr("action"),{method:"POST",parameters:F,evalJSON:"force",onSuccess:this.moveHandler.bind(this)})}else{var E=jq("#moveActionForm");E.find('input[name="positionHash"]').val(document.location.hash);jq("#moveActionForm").submit()}}},moveHandler:function(E){var D=E.responseJSON;var C=D.response.message;if(D&&D.response.stat=="ok"){C.type=PBMessage.MESSAGE_TYPE.SUCCESS;if(typeof BulkActionsController!="undefined"){document.fire(BulkActionsController.EVENT.REMOVE,{selected:this.selected})}this.selected=[]}else{C.type=PBMessage.MESSAGE_TYPE.ERROR}document.fire(PBLightbox.PBProgress.EVENT.DEACTIVATE);this.unbindKeyHandlers();document.fire(PBLightbox.EVENT.DEACTIVATE);document.fire(PBMessage.EVENT.NOTIFY,{gotoHash:true,id:this.notify,message:new PBMessage(C)})},keyHandler:function(C){if(C.keyCode==13){document.fire(MoveActionController.EVENT.DOMOVE)}},bindKeyHandlers:function(){this.windowObj=(photobucket.browser.isIE)?jq(document):jq(window);this.windowObj.keyup(this.keyHandler)},unbindKeyHandlers:function(){this.windowObj.unbind("keyup",this.keyHandler)}};Controller.create("MoveActionController",A,B)})();var AlbumChooserController;(function(){var A={initialize:function(){try{$$(".album_chooser").each(function(D){new B(D)})}catch(C){}}};Controller.create("AlbumChooserController",A,{});var B=Class.create({cn:"hover",initialize:function(C){this.chooser=C;this.selector=C.down(".selector");this.panel=C.down(".album_chooser_panel");this.input=C.down("input");this.tabPanel=C.down(".album_chooser_tab_panel");this.newAlbumPanel=C.down(".album_chooser_add_album");this.trackingPrefix=C.readAttribute("tracking");this.rootPath=C.readAttribute("rootpath");this.progressPanel=null;this.maxWidth=this.chooser.readAttribute("maxwidth")||100;jq(this.chooser).hoverIntent({over:this.onChooser.bind(this),out:this.offChooser.bind(this),timeout:300});var D=$("albumChooserCreate");if(D){D.observe("click",this.onCreateAlbum.bindAsEventListener(this))}this.selector.observe("click",this.onSelector.bindAsEventListener(this));this.panel.observe("click",this.onClick.bindAsEventListener(this));document.observe("PBAlbumCreate::new",this.onNewAlbum.bindAsEventListener(this));this.newAlbumName=this.newAlbumPanel.down(".album_chooser_add_album_name");this.newAlbumName.observe("keyup",this.checkAlbumName.bindAsEventListener(this))},onSelector:function(E){var D=Event.element(E);if(this.chooser.hasClassName(this.cn)){this.chooser.removeClassName(this.cn)}else{var C=this.panel.down(".album_chooser_album");if(C){this.chooser.addClassName(this.cn)}}},onChooser:function(C){},offChooser:function(C){this.chooser.removeClassName(this.cn)},onCreateAlbum:function(C){this.showNewAlbumPanel()},onClick:function(D){var C=Event.element(D);if(C.hasClassName("button")){return }if(C.hasClassName("album_chooser_album")){this.select({name:C.readAttribute("title"),location:C.readAttribute("location")})}else{if(C.hasClassName("album_chooser_new")){this.showNewAlbumPanel()}else{if(C.hasClassName("album_chooser_new_cancel")){this.hideNewAlbumPanel()}else{if(C.hasClassName("album_chooser_add_button")){this.addNewAlbum()}}}}},select:function(C){this.selector.down("b").update(this.truncateName(C.name));this.input.value=C.location;jq(this.tabPanel).find(".selected").removeClass("selected");jq(this.tabPanel).find("a[location='"+C.location+"']").parent().addClass("selected");this.offChooser();this.track("album select");C.path=this.rootPath+"/"+C.location;this.chooser.fire("chooser:selected",C)},showNewAlbumPanel:function(){this.track("album create");document.fire(PBLightbox.EVENT.ACTIVATE,{contentUrl:"/createalbum?p=redirect",cache:false,parameters:{p:"albumchooser"}})},hideNewAlbumPanel:function(){this.newAlbumPanel.hide();this.tabPanel.show()},truncateName:function(C){if(C.length>this.maxWidth){C=C.substring(0,this.maxWidth-2)+"..."}return C},track:function(C){if(this.trackingPrefix){tr(this.trackingPrefix+" "+C)}},addNewAlbum:function(){var D=this.newAlbumPanel.down("select");var G=(D)?$(D.options[D.selectedIndex]):false;var C=(G)?G.value:"";var F=(G)?G.readAttribute("depth"):1;var I=this.newAlbumPanel.down("input").value.strip().stripTags().stripScripts();var E={createnew:1,postaction:"update",newAlbum:I,parenttarget:C,parentdepth:F};if(E.newAlbum){if(E.parenttarget.length>0){E.addAsSub=true}var H=this.newAlbumPanel.readAttribute("create");new Ajax.Request(H,{method:"POST",parameters:E,onSuccess:this.onAddNewAlbumResp.bind(this)});if(!this.progressPanel){this.progressPanel=new PBProgress({parentId:this.newAlbumPanel.identify(),message:"Creating new album..."})}document.fire(PBProgress.EVENT.ACTIVATE,this.progressPanel)}},onAddNewAlbumResp:function(E){document.fire(PBProgress.EVENT.DEACTIVATE,this.progressPanel);track("create_album");var F=E.responseJSON.response;if(F.stat=="ok"){var D={name:F.optionLabel,location:F.optionValue,parentDepth:E.request.parameters.parentdepth,parentLocation:E.request.parameters.parenttarget};this.insert(D);this.select(D);this.track("album create")}else{var C={type:PBMessage.MESSAGE_TYPE.ERROR,title:"Failed To Create Album",details:F.message.details};document.fire(PBMessage.EVENT.NOTIFY,{message:new PBMessage(C)});this.offChooser()}},onNewAlbum:function(J){var I=J.memo.response;var E=J.memo.response.optionLabel;var D=J.memo.response.optionValue;var G=D.split("/");G.pop();var H=G.length+1;var F=G.join("/");var C={name:E,location:D,parentDepth:H,parentLocation:F};this.insert(C);this.select(C)},insert:function(E){var J=this.tabPanel.down(".recentalbumslist");var I=new Element("li");I.appendChild(this.getAlbumLinkElement(E));J.insert({top:I});var F=this.tabPanel.down(".allalbumslist");var D=(E.parentDepth)?((new Number(E.parentDepth)+1)*15):0;I=new Element("li",{style:"margin-left:"+D+"px;"});I.appendChild(this.getAlbumLinkElement(E));var H=false;if(E.parentLocation){F.select("a").each(function(L){if(L.readAttribute("location")==E.parentLocation){H=L.up("li")}})}if(H){H.insert({after:I})}else{F.insert({bottom:I})}if(this.newAlbumPanel&&E.parentDepth<4){var K=this.newAlbumPanel.down("select");if(K){var G="&nbsp;".times(E.parentDepth*2)+E.name;var C=new Element("option",{depth:E.parentDepth+1,value:E.location}).update(G);var H=false;if(E.parentLocation){K.select("option").each(function(L){if(L.value==E.parentLocation){H=L}})}if(H){H.insert({after:C})}else{K.insert({bottom:C})}}}},getAlbumLinkElement:function(C){return new Element("a",{href:"javascript:void(1)",title:C.name,location:C.location,"class":"album_chooser_album"}).update(C.name)},checkAlbumName:function(E){var C=this.newAlbumPanel.down(".album_chooser_add_button");var D="disabled";if(this.newAlbumName.value.strip()==""){C.addClassName(D)}else{C.removeClassName(D)}}})})();var Builder={NODEMAP:{AREA:"map",CAPTION:"table",COL:"table",COLGROUP:"table",LEGEND:"fieldset",OPTGROUP:"select",OPTION:"select",PARAM:"object",TBODY:"table",TD:"table",TFOOT:"table",TH:"table",THEAD:"table",TR:"table"},node:function(A){A=A.toUpperCase();var F=this.NODEMAP[A]||"div";var B=document.createElement(F);try{B.innerHTML="<"+A+"></"+A+">"}catch(E){}var D=B.firstChild||null;if(D&&(D.tagName.toUpperCase()!=A)){D=D.getElementsByTagName(A)[0]}if(!D){D=document.createElement(A)}if(!D){return }if(arguments[1]){if(this._isStringOrNumber(arguments[1])||(arguments[1] instanceof Array)||arguments[1].tagName){this._children(D,arguments[1])}else{var C=this._attributes(arguments[1]);if(C.length){try{B.innerHTML="<"+A+" "+C+"></"+A+">"}catch(E){}D=B.firstChild||null;if(!D){D=document.createElement(A);for(attr in arguments[1]){D[attr=="class"?"className":attr]=arguments[1][attr]}}if(D.tagName.toUpperCase()!=A){D=B.getElementsByTagName(A)[0]}}}}if(arguments[2]){this._children(D,arguments[2])}return D},_text:function(A){return document.createTextNode(A)},ATTR_MAP:{className:"class",htmlFor:"for"},_attributes:function(A){var B=[];for(attribute in A){B.push((attribute in this.ATTR_MAP?this.ATTR_MAP[attribute]:attribute)+'="'+A[attribute].toString().escapeHTML().gsub(/"/,"&quot;")+'"')}return B.join(" ")},_children:function(B,A){if(A.tagName){B.appendChild(A);return }if(typeof A=="object"){A.flatten().each(function(C){if(typeof C=="object"){B.appendChild(C)}else{if(Builder._isStringOrNumber(C)){B.appendChild(Builder._text(C))}}})}else{if(Builder._isStringOrNumber(A)){B.appendChild(Builder._text(A))}}},_isStringOrNumber:function(A){return(typeof A=="string"||typeof A=="number")},build:function(B){var A=this.node("div");$(A).update(B.strip());return A.down()},dump:function(B){if(typeof B!="object"&&typeof B!="function"){B=window}var A=("A ABBR ACRONYM ADDRESS APPLET AREA B BASE BASEFONT BDO BIG BLOCKQUOTE BODY BR BUTTON CAPTION CENTER CITE CODE COL COLGROUP DD DEL DFN DIR DIV DL DT EM FIELDSET FONT FORM FRAME FRAMESET H1 H2 H3 H4 H5 H6 HEAD HR HTML I IFRAME IMG INPUT INS ISINDEX KBD LABEL LEGEND LI LINK MAP MENU META NOFRAMES NOSCRIPT OBJECT OL OPTGROUP OPTION P PARAM PRE Q S SAMP SCRIPT SELECT SMALL SPAN STRIKE STRONG STYLE SUB SUP TABLE TBODY TD TEXTAREA TFOOT TH THEAD TITLE TR TT U UL VAR").split(/\s+/);A.each(function(C){B[C]=function(){return Builder.node.apply(Builder,[C].concat($A(arguments)))}})}};String.prototype.parseColor=function(){var A="#";if(this.slice(0,4)=="rgb("){var C=this.slice(4,this.length-1).split(",");var B=0;do{A+=parseInt(C[B]).toColorPart()}while(++B<3)}else{if(this.slice(0,1)=="#"){if(this.length==4){for(var B=1;B<4;B++){A+=(this.charAt(B)+this.charAt(B)).toLowerCase()}}if(this.length==7){A=this.toLowerCase()}}}return(A.length==7?A:(arguments[0]||this))};Element.collectTextNodes=function(A){return $A($(A).childNodes).collect(function(B){return(B.nodeType==3?B.nodeValue:(B.hasChildNodes()?Element.collectTextNodes(B):""))}).flatten().join("")};Element.collectTextNodesIgnoreClass=function(A,B){return $A($(A).childNodes).collect(function(C){return(C.nodeType==3?C.nodeValue:((C.hasChildNodes()&&!Element.hasClassName(C,B))?Element.collectTextNodesIgnoreClass(C,B):""))}).flatten().join("")};Element.setContentZoom=function(A,B){A=$(A);A.setStyle({fontSize:(B/100)+"em"});if(Prototype.Browser.WebKit){window.scrollBy(0,0)}return A};Element.getInlineOpacity=function(A){return $(A).style.opacity||""};Element.forceRerendering=function(A){try{A=$(A);var C=document.createTextNode(" ");A.appendChild(C);A.removeChild(C)}catch(B){}};var Effect={_elementDoesNotExistError:{name:"ElementDoesNotExistError",message:"The specified DOM element does not exist, but is required for this effect to operate"},Transitions:{linear:Prototype.K,sinoidal:function(A){return(-Math.cos(A*Math.PI)/2)+0.5},reverse:function(A){return 1-A},flicker:function(A){var A=((-Math.cos(A*Math.PI)/4)+0.75)+Math.random()/4;return A>1?1:A},wobble:function(A){return(-Math.cos(A*Math.PI*(9*A))/2)+0.5},pulse:function(B,A){A=A||5;return(((B%(1/A))*A).round()==0?((B*A*2)-(B*A*2).floor()):1-((B*A*2)-(B*A*2).floor()))},spring:function(A){return 1-(Math.cos(A*4.5*Math.PI)*Math.exp(-A*6))},none:function(A){return 0},full:function(A){return 1}},DefaultOptions:{duration:1,fps:100,sync:false,from:0,to:1,delay:0,queue:"parallel"},tagifyText:function(A){var B="position:relative";if(Prototype.Browser.IE){B+=";zoom:1"}A=$(A);$A(A.childNodes).each(function(C){if(C.nodeType==3){C.nodeValue.toArray().each(function(D){A.insertBefore(new Element("span",{style:B}).update(D==" "?String.fromCharCode(160):D),C)});Element.remove(C)}})},multiple:function(B,C){var E;if(((typeof B=="object")||Object.isFunction(B))&&(B.length)){E=B}else{E=$(B).childNodes}var A=Object.extend({speed:0.1,delay:0},arguments[2]||{});var D=A.delay;$A(E).each(function(G,F){new C(G,Object.extend(A,{delay:F*A.speed+D}))})},PAIRS:{slide:["SlideDown","SlideUp"],blind:["BlindDown","BlindUp"],appear:["Appear","Fade"]},toggle:function(B,C){B=$(B);C=(C||"appear").toLowerCase();var A=Object.extend({queue:{position:"end",scope:(B.id||"global"),limit:1}},arguments[2]||{});Effect[B.visible()?Effect.PAIRS[C][1]:Effect.PAIRS[C][0]](B,A)}};Effect.DefaultOptions.transition=Effect.Transitions.sinoidal;Effect.ScopedQueue=Class.create(Enumerable,{initialize:function(){this.effects=[];this.interval=null},_each:function(A){this.effects._each(A)},add:function(B){var C=new Date().getTime();var A=Object.isString(B.options.queue)?B.options.queue:B.options.queue.position;switch(A){case"front":this.effects.findAll(function(D){return D.state=="idle"}).each(function(D){D.startOn+=B.finishOn;D.finishOn+=B.finishOn});break;case"with-last":C=this.effects.pluck("startOn").max()||C;break;case"end":C=this.effects.pluck("finishOn").max()||C;break}B.startOn+=C;B.finishOn+=C;if(!B.options.queue.limit||(this.effects.length<B.options.queue.limit)){this.effects.push(B)}if(!this.interval){this.interval=setInterval(this.loop.bind(this),15)}},remove:function(A){this.effects=this.effects.reject(function(B){return B==A});if(this.effects.length==0){clearInterval(this.interval);this.interval=null}},loop:function(){var C=new Date().getTime();for(var B=0,A=this.effects.length;B<A;B++){this.effects[B]&&this.effects[B].loop(C)}}});Effect.Queues={instances:$H(),get:function(A){if(!Object.isString(A)){return A}return this.instances.get(A)||this.instances.set(A,new Effect.ScopedQueue())}};Effect.Queue=Effect.Queues.get("global");Effect.Base=Class.create({position:null,start:function(options){function codeForEvent(options,eventName){return((options[eventName+"Internal"]?"this.options."+eventName+"Internal(this);":"")+(options[eventName]?"this.options."+eventName+"(this);":""))}if(options&&options.transition===false){options.transition=Effect.Transitions.linear}this.options=Object.extend(Object.extend({},Effect.DefaultOptions),options||{});this.currentFrame=0;this.state="idle";this.startOn=this.options.delay*1000;this.finishOn=this.startOn+(this.options.duration*1000);this.fromToDelta=this.options.to-this.options.from;this.totalTime=this.finishOn-this.startOn;this.totalFrames=this.options.fps*this.options.duration;eval('this.render = function(pos){ if (this.state=="idle"){this.state="running";'+codeForEvent(this.options,"beforeSetup")+(this.setup?"this.setup();":"")+codeForEvent(this.options,"afterSetup")+'};if (this.state=="running"){pos=this.options.transition(pos)*'+this.fromToDelta+"+"+this.options.from+";this.position=pos;"+codeForEvent(this.options,"beforeUpdate")+(this.update?"this.update(pos);":"")+codeForEvent(this.options,"afterUpdate")+"}}");this.event("beforeStart");if(!this.options.sync){Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).add(this)}},loop:function(C){if(C>=this.startOn){if(C>=this.finishOn){this.render(1);this.cancel();this.event("beforeFinish");if(this.finish){this.finish()}this.event("afterFinish");return }var B=(C-this.startOn)/this.totalTime,A=(B*this.totalFrames).round();if(A>this.currentFrame){this.render(B);this.currentFrame=A}}},cancel:function(){if(!this.options.sync){Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).remove(this)}this.state="finished"},event:function(A){if(this.options[A+"Internal"]){this.options[A+"Internal"](this)}if(this.options[A]){this.options[A](this)}},inspect:function(){var A=$H();for(property in this){if(!Object.isFunction(this[property])){A.set(property,this[property])}}return"#<Effect:"+A.inspect()+",options:"+$H(this.options).inspect()+">"}});Effect.Parallel=Class.create(Effect.Base,{initialize:function(A){this.effects=A||[];this.start(arguments[1])},update:function(A){this.effects.invoke("render",A)},finish:function(A){this.effects.each(function(B){B.render(1);B.cancel();B.event("beforeFinish");if(B.finish){B.finish(A)}B.event("afterFinish")})}});Effect.Tween=Class.create(Effect.Base,{initialize:function(C,F,E){C=Object.isString(C)?$(C):C;var B=$A(arguments),D=B.last(),A=B.length==5?B[3]:null;this.method=Object.isFunction(D)?D.bind(C):Object.isFunction(C[D])?C[D].bind(C):function(G){C[D]=G};this.start(Object.extend({from:F,to:E},A||{}))},update:function(A){this.method(A)}});Effect.Event=Class.create(Effect.Base,{initialize:function(){this.start(Object.extend({duration:0},arguments[0]||{}))},update:Prototype.emptyFunction});Effect.Opacity=Class.create(Effect.Base,{initialize:function(B){this.element=$(B);if(!this.element){throw (Effect._elementDoesNotExistError)}if(Prototype.Browser.IE&&(!this.element.currentStyle.hasLayout)){this.element.setStyle({zoom:1})}var A=Object.extend({from:this.element.getOpacity()||0,to:1},arguments[1]||{});this.start(A)},update:function(A){this.element.setOpacity(A)}});Effect.Move=Class.create(Effect.Base,{initialize:function(B){this.element=$(B);if(!this.element){throw (Effect._elementDoesNotExistError)}var A=Object.extend({x:0,y:0,mode:"relative"},arguments[1]||{});this.start(A)},setup:function(){this.element.makePositioned();this.originalLeft=parseFloat(this.element.getStyle("left")||"0");this.originalTop=parseFloat(this.element.getStyle("top")||"0");if(this.options.mode=="absolute"){this.options.x=this.options.x-this.originalLeft;this.options.y=this.options.y-this.originalTop}},update:function(A){this.element.setStyle({left:(this.options.x*A+this.originalLeft).round()+"px",top:(this.options.y*A+this.originalTop).round()+"px"})}});Effect.MoveBy=function(B,A,C){return new Effect.Move(B,Object.extend({x:C,y:A},arguments[3]||{}))};Effect.Scale=Class.create(Effect.Base,{initialize:function(B,C){this.element=$(B);if(!this.element){throw (Effect._elementDoesNotExistError)}var A=Object.extend({scaleX:true,scaleY:true,scaleContent:true,scaleFromCenter:false,scaleMode:"box",scaleFrom:100,scaleTo:C},arguments[2]||{});this.start(A)},setup:function(){this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle("position");this.originalStyle={};["top","left","width","height","fontSize"].each(function(B){this.originalStyle[B]=this.element.style[B]}.bind(this));this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;var A=this.element.getStyle("font-size")||"100%";["em","px","%","pt"].each(function(B){if(A.indexOf(B)>0){this.fontSize=parseFloat(A);this.fontSizeType=B}}.bind(this));this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;this.dims=null;if(this.options.scaleMode=="box"){this.dims=[this.element.offsetHeight,this.element.offsetWidth]}if(/^content/.test(this.options.scaleMode)){this.dims=[this.element.scrollHeight,this.element.scrollWidth]}if(!this.dims){this.dims=[this.options.scaleMode.originalHeight,this.options.scaleMode.originalWidth]}},update:function(A){var B=(this.options.scaleFrom/100)+(this.factor*A);if(this.options.scaleContent&&this.fontSize){this.element.setStyle({fontSize:this.fontSize*B+this.fontSizeType})}this.setDimensions(this.dims[0]*B,this.dims[1]*B)},finish:function(A){if(this.restoreAfterFinish){this.element.setStyle(this.originalStyle)}},setDimensions:function(A,D){var E={};if(this.options.scaleX){E.width=D.round()+"px"}if(this.options.scaleY){E.height=A.round()+"px"}if(this.options.scaleFromCenter){var C=(A-this.dims[0])/2;var B=(D-this.dims[1])/2;if(this.elementPositioning=="absolute"){if(this.options.scaleY){E.top=this.originalTop-C+"px"}if(this.options.scaleX){E.left=this.originalLeft-B+"px"}}else{if(this.options.scaleY){E.top=-C+"px"}if(this.options.scaleX){E.left=-B+"px"}}}this.element.setStyle(E)}});Effect.Highlight=Class.create(Effect.Base,{initialize:function(B){this.element=$(B);if(!this.element){throw (Effect._elementDoesNotExistError)}var A=Object.extend({startcolor:"#ffff99"},arguments[1]||{});this.start(A)},setup:function(){if(this.element.getStyle("display")=="none"){this.cancel();return }this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle("background-image");this.element.setStyle({backgroundImage:"none"})}if(!this.options.endcolor){this.options.endcolor=this.element.getStyle("background-color").parseColor("#ffffff")}if(!this.options.restorecolor){this.options.restorecolor=this.element.getStyle("background-color")}this._base=$R(0,2).map(function(A){return parseInt(this.options.startcolor.slice(A*2+1,A*2+3),16)}.bind(this));this._delta=$R(0,2).map(function(A){return parseInt(this.options.endcolor.slice(A*2+1,A*2+3),16)-this._base[A]}.bind(this))},update:function(A){this.element.setStyle({backgroundColor:$R(0,2).inject("#",function(B,C,D){return B+((this._base[D]+(this._delta[D]*A)).round().toColorPart())}.bind(this))})},finish:function(){this.element.setStyle(Object.extend(this.oldStyle,{backgroundColor:this.options.restorecolor}))}});Effect.ScrollTo=function(D){var C=arguments[1]||{},B=document.viewport.getScrollOffsets(),E=$(D).cumulativeOffset(),A=(window.height||document.body.scrollHeight)-document.viewport.getHeight();if(C.offset){E[1]+=C.offset}return new Effect.Tween(null,B.top,E[1]>A?A:E[1],C,function(F){scrollTo(B.left,F.round())})};Effect.Fade=function(C){C=$(C);var A=C.getInlineOpacity();var B=Object.extend({from:C.getOpacity()||1,to:0,afterFinishInternal:function(D){if(D.options.to!=0){return }D.element.hide().setStyle({opacity:A})}},arguments[1]||{});return new Effect.Opacity(C,B)};Effect.Appear=function(B){B=$(B);var A=Object.extend({from:(B.getStyle("display")=="none"?0:B.getOpacity()||0),to:1,afterFinishInternal:function(C){C.element.forceRerendering()},beforeSetup:function(C){C.element.setOpacity(C.options.from).show()}},arguments[1]||{});return new Effect.Opacity(B,A)};Effect.Puff=function(B){B=$(B);var A={opacity:B.getInlineOpacity(),position:B.getStyle("position"),top:B.style.top,left:B.style.left,width:B.style.width,height:B.style.height};return new Effect.Parallel([new Effect.Scale(B,200,{sync:true,scaleFromCenter:true,scaleContent:true,restoreAfterFinish:true}),new Effect.Opacity(B,{sync:true,to:0})],Object.extend({duration:1,beforeSetupInternal:function(C){Position.absolutize(C.effects[0].element)},afterFinishInternal:function(C){C.effects[0].element.hide().setStyle(A)}},arguments[1]||{}))};Effect.BlindUp=function(A){A=$(A);A.makeClipping();return new Effect.Scale(A,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(B){B.element.hide().undoClipping()}},arguments[1]||{}))};Effect.BlindDown=function(B){B=$(B);var A=B.getDimensions();return new Effect.Scale(B,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:A.height,originalWidth:A.width},restoreAfterFinish:true,afterSetup:function(C){C.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(C){C.element.undoClipping()}},arguments[1]||{}))};Effect.SwitchOff=function(B){B=$(B);var A=B.getInlineOpacity();return new Effect.Appear(B,Object.extend({duration:0.4,from:0,transition:Effect.Transitions.flicker,afterFinishInternal:function(C){new Effect.Scale(C.element,1,{duration:0.3,scaleFromCenter:true,scaleX:false,scaleContent:false,restoreAfterFinish:true,beforeSetup:function(D){D.element.makePositioned().makeClipping()},afterFinishInternal:function(D){D.element.hide().undoClipping().undoPositioned().setStyle({opacity:A})}})}},arguments[1]||{}))};Effect.DropOut=function(B){B=$(B);var A={top:B.getStyle("top"),left:B.getStyle("left"),opacity:B.getInlineOpacity()};return new Effect.Parallel([new Effect.Move(B,{x:0,y:100,sync:true}),new Effect.Opacity(B,{sync:true,to:0})],Object.extend({duration:0.5,beforeSetup:function(C){C.effects[0].element.makePositioned()},afterFinishInternal:function(C){C.effects[0].element.hide().undoPositioned().setStyle(A)}},arguments[1]||{}))};Effect.Shake=function(D){D=$(D);var B=Object.extend({distance:20,duration:0.5},arguments[1]||{});var E=parseFloat(B.distance);var C=parseFloat(B.duration)/10;var A={top:D.getStyle("top"),left:D.getStyle("left")};return new Effect.Move(D,{x:E,y:0,duration:C,afterFinishInternal:function(F){new Effect.Move(F.element,{x:-E*2,y:0,duration:C*2,afterFinishInternal:function(G){new Effect.Move(G.element,{x:E*2,y:0,duration:C*2,afterFinishInternal:function(H){new Effect.Move(H.element,{x:-E*2,y:0,duration:C*2,afterFinishInternal:function(I){new Effect.Move(I.element,{x:E*2,y:0,duration:C*2,afterFinishInternal:function(J){new Effect.Move(J.element,{x:-E,y:0,duration:C,afterFinishInternal:function(K){K.element.undoPositioned().setStyle(A)}})}})}})}})}})}})};Effect.SlideDown=function(C){C=$(C).cleanWhitespace();var A=C.down().getStyle("bottom");var B=C.getDimensions();return new Effect.Scale(C,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:window.opera?0:1,scaleMode:{originalHeight:B.height,originalWidth:B.width},restoreAfterFinish:true,afterSetup:function(D){D.element.makePositioned();D.element.down().makePositioned();if(window.opera){D.element.setStyle({top:""})}D.element.makeClipping().setStyle({height:"0px"}).show()},afterUpdateInternal:function(D){D.element.down().setStyle({bottom:(D.dims[0]-D.element.clientHeight)+"px"})},afterFinishInternal:function(D){D.element.undoClipping().undoPositioned();D.element.down().undoPositioned().setStyle({bottom:A})}},arguments[1]||{}))};Effect.SlideUp=function(C){C=$(C).cleanWhitespace();var A=C.down().getStyle("bottom");var B=C.getDimensions();return new Effect.Scale(C,window.opera?0:1,Object.extend({scaleContent:false,scaleX:false,scaleMode:"box",scaleFrom:100,scaleMode:{originalHeight:B.height,originalWidth:B.width},restoreAfterFinish:true,afterSetup:function(D){D.element.makePositioned();D.element.down().makePositioned();if(window.opera){D.element.setStyle({top:""})}D.element.makeClipping().show()},afterUpdateInternal:function(D){D.element.down().setStyle({bottom:(D.dims[0]-D.element.clientHeight)+"px"})},afterFinishInternal:function(D){D.element.hide().undoClipping().undoPositioned();D.element.down().undoPositioned().setStyle({bottom:A})}},arguments[1]||{}))};Effect.Squish=function(A){return new Effect.Scale(A,window.opera?1:0,{restoreAfterFinish:true,beforeSetup:function(B){B.element.makeClipping()},afterFinishInternal:function(B){B.element.hide().undoClipping()}})};Effect.Grow=function(C){C=$(C);var B=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.full},arguments[1]||{});var A={top:C.style.top,left:C.style.left,height:C.style.height,width:C.style.width,opacity:C.getInlineOpacity()};var G=C.getDimensions();var H,F;var E,D;switch(B.direction){case"top-left":H=F=E=D=0;break;case"top-right":H=G.width;F=D=0;E=-G.width;break;case"bottom-left":H=E=0;F=G.height;D=-G.height;break;case"bottom-right":H=G.width;F=G.height;E=-G.width;D=-G.height;break;case"center":H=G.width/2;F=G.height/2;E=-G.width/2;D=-G.height/2;break}return new Effect.Move(C,{x:H,y:F,duration:0.01,beforeSetup:function(I){I.element.hide().makeClipping().makePositioned()},afterFinishInternal:function(I){new Effect.Parallel([new Effect.Opacity(I.element,{sync:true,to:1,from:0,transition:B.opacityTransition}),new Effect.Move(I.element,{x:E,y:D,sync:true,transition:B.moveTransition}),new Effect.Scale(I.element,100,{scaleMode:{originalHeight:G.height,originalWidth:G.width},sync:true,scaleFrom:window.opera?1:0,transition:B.scaleTransition,restoreAfterFinish:true})],Object.extend({beforeSetup:function(J){J.effects[0].element.setStyle({height:"0px"}).show()},afterFinishInternal:function(J){J.effects[0].element.undoClipping().undoPositioned().setStyle(A)}},B))}})};Effect.Shrink=function(C){C=$(C);var B=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.none},arguments[1]||{});var A={top:C.style.top,left:C.style.left,height:C.style.height,width:C.style.width,opacity:C.getInlineOpacity()};var F=C.getDimensions();var E,D;switch(B.direction){case"top-left":E=D=0;break;case"top-right":E=F.width;D=0;break;case"bottom-left":E=0;D=F.height;break;case"bottom-right":E=F.width;D=F.height;break;case"center":E=F.width/2;D=F.height/2;break}return new Effect.Parallel([new Effect.Opacity(C,{sync:true,to:0,from:1,transition:B.opacityTransition}),new Effect.Scale(C,window.opera?1:0,{sync:true,transition:B.scaleTransition,restoreAfterFinish:true}),new Effect.Move(C,{x:E,y:D,sync:true,transition:B.moveTransition})],Object.extend({beforeStartInternal:function(G){G.effects[0].element.makePositioned().makeClipping()},afterFinishInternal:function(G){G.effects[0].element.hide().undoClipping().undoPositioned().setStyle(A)}},B))};Effect.Pulsate=function(C){C=$(C);var B=arguments[1]||{};var A=C.getInlineOpacity();var E=B.transition||Effect.Transitions.sinoidal;var D=function(F){return E(1-Effect.Transitions.pulse(F,B.pulses))};D.bind(E);return new Effect.Opacity(C,Object.extend(Object.extend({duration:2,from:0,afterFinishInternal:function(F){F.element.setStyle({opacity:A})}},B),{transition:D}))};Effect.Fold=function(B){B=$(B);var A={top:B.style.top,left:B.style.left,width:B.style.width,height:B.style.height};B.makeClipping();return new Effect.Scale(B,5,Object.extend({scaleContent:false,scaleX:false,afterFinishInternal:function(C){new Effect.Scale(B,1,{scaleContent:false,scaleY:false,afterFinishInternal:function(D){D.element.hide().undoClipping().setStyle(A)}})}},arguments[1]||{}))};Effect.Morph=Class.create(Effect.Base,{initialize:function(C){this.element=$(C);if(!this.element){throw (Effect._elementDoesNotExistError)}var A=Object.extend({style:{}},arguments[1]||{});if(!Object.isString(A.style)){this.style=$H(A.style)}else{if(A.style.include(":")){this.style=A.style.parseStyle()}else{this.element.addClassName(A.style);this.style=$H(this.element.getStyles());this.element.removeClassName(A.style);var B=this.element.getStyles();this.style=this.style.reject(function(D){return D.value==B[D.key]});A.afterFinishInternal=function(D){D.element.addClassName(D.options.style);D.transforms.each(function(E){D.element.style[E.style]=""})}}}this.start(A)},setup:function(){function A(B){if(!B||["rgba(0, 0, 0, 0)","transparent"].include(B)){B="#ffffff"}B=B.parseColor();return $R(0,2).map(function(C){return parseInt(B.slice(C*2+1,C*2+3),16)})}this.transforms=this.style.map(function(G){var F=G[0],E=G[1],D=null;if(E.parseColor("#zzzzzz")!="#zzzzzz"){E=E.parseColor();D="color"}else{if(F=="opacity"){E=parseFloat(E);if(Prototype.Browser.IE&&(!this.element.currentStyle.hasLayout)){this.element.setStyle({zoom:1})}}else{if(Element.CSS_LENGTH.test(E)){var C=E.match(/^([\+\-]?[0-9\.]+)(.*)$/);E=parseFloat(C[1]);D=(C.length==3)?C[2]:null}}}var B=this.element.getStyle(F);return{style:F.camelize(),originalValue:D=="color"?A(B):parseFloat(B||0),targetValue:D=="color"?A(E):E,unit:D}}.bind(this)).reject(function(B){return((B.originalValue==B.targetValue)||(B.unit!="color"&&(isNaN(B.originalValue)||isNaN(B.targetValue))))})},update:function(A){var D={},B,C=this.transforms.length;while(C--){D[(B=this.transforms[C]).style]=B.unit=="color"?"#"+(Math.round(B.originalValue[0]+(B.targetValue[0]-B.originalValue[0])*A)).toColorPart()+(Math.round(B.originalValue[1]+(B.targetValue[1]-B.originalValue[1])*A)).toColorPart()+(Math.round(B.originalValue[2]+(B.targetValue[2]-B.originalValue[2])*A)).toColorPart():(B.originalValue+(B.targetValue-B.originalValue)*A).toFixed(3)+(B.unit===null?"":B.unit)}this.element.setStyle(D,true)}});Effect.Transform=Class.create({initialize:function(A){this.tracks=[];this.options=arguments[1]||{};this.addTracks(A)},addTracks:function(A){A.each(function(B){B=$H(B);var C=B.values().first();this.tracks.push($H({ids:B.keys().first(),effect:Effect.Morph,options:{style:C}}))}.bind(this));return this},play:function(){return new Effect.Parallel(this.tracks.map(function(A){var D=A.get("ids"),C=A.get("effect"),B=A.get("options");var E=[$(D)||$$(D)].flatten();return E.map(function(F){return new C(F,Object.extend({sync:true},B))})}).flatten(),this.options)}});Element.CSS_PROPERTIES=$w("backgroundColor backgroundPosition borderBottomColor borderBottomStyle borderBottomWidth borderLeftColor borderLeftStyle borderLeftWidth borderRightColor borderRightStyle borderRightWidth borderSpacing borderTopColor borderTopStyle borderTopWidth bottom clip color fontSize fontWeight height left letterSpacing lineHeight marginBottom marginLeft marginRight marginTop markerOffset maxHeight maxWidth minHeight minWidth opacity outlineColor outlineOffset outlineWidth paddingBottom paddingLeft paddingRight paddingTop right textIndent top width wordSpacing zIndex");Element.CSS_LENGTH=/^(([\+\-]?[0-9\.]+)(em|ex|px|in|cm|mm|pt|pc|\%))|0$/;String.__parseStyleElement=document.createElement("div");String.prototype.parseStyle=function(){var B,A=$H();if(Prototype.Browser.WebKit){B=new Element("div",{style:this}).style}else{String.__parseStyleElement.innerHTML='<div style="'+this+'"></div>';B=String.__parseStyleElement.childNodes[0].style}Element.CSS_PROPERTIES.each(function(C){if(B[C]){A.set(C,B[C])}});if(Prototype.Browser.IE&&this.include("opacity")){A.set("opacity",this.match(/opacity:\s*((?:0|1)?(?:\.\d*)?)/)[1])}return A};if(document.defaultView&&document.defaultView.getComputedStyle){Element.getStyles=function(B){var A=document.defaultView.getComputedStyle($(B),null);return Element.CSS_PROPERTIES.inject({},function(C,D){C[D]=A[D];return C})}}else{Element.getStyles=function(B){B=$(B);var A=B.currentStyle,C;C=Element.CSS_PROPERTIES.inject({},function(D,E){D[E]=A[E];return D});if(!C.opacity){C.opacity=B.getOpacity()}return C}}Effect.Methods={morph:function(A,B){A=$(A);new Effect.Morph(A,Object.extend({style:B},arguments[2]||{}));return A},visualEffect:function(C,E,B){C=$(C);var D=E.dasherize().camelize(),A=D.charAt(0).toUpperCase()+D.substring(1);new Effect[A](C,B);return C},highlight:function(B,A){B=$(B);new Effect.Highlight(B,A);return B}};$w("fade appear grow shrink fold blindUp blindDown slideUp slideDown pulsate shake puff squish switchOff dropOut").each(function(A){Effect.Methods[A]=function(C,B){C=$(C);Effect[A.charAt(0).toUpperCase()+A.substring(1)](C,B);return C}});$w("getInlineOpacity forceRerendering setContentZoom collectTextNodes collectTextNodesIgnoreClass getStyles").each(function(A){Effect.Methods[A]=Element[A]});Element.addMethods(Effect.Methods);if(Object.isUndefined(Effect)){throw ("dragdrop.js requires including script.aculo.us' effects.js library")}var Droppables={drops:[],remove:function(A){this.drops=this.drops.reject(function(B){return B.element==$(A)})},add:function(B){B=$(B);var A=Object.extend({greedy:true,hoverclass:null,tree:false},arguments[1]||{});if(A.containment){A._containers=[];var C=A.containment;if(Object.isArray(C)){C.each(function(D){A._containers.push($(D))})}else{A._containers.push($(C))}}if(A.accept){A.accept=[A.accept].flatten()}Element.makePositioned(B);A.element=B;this.drops.push(A)},findDeepestChild:function(A){deepest=A[0];for(i=1;i<A.length;++i){if(Element.isParent(A[i].element,deepest.element)){deepest=A[i]}}return deepest},isContained:function(B,A){var C;if(A.tree){C=B.treeNode}else{C=B.parentNode}return A._containers.detect(function(D){return C==D})},isAffected:function(A,C,B){return((B.element!=C)&&((!B._containers)||this.isContained(C,B))&&((!B.accept)||(Element.classNames(C).detect(function(D){return B.accept.include(D)})))&&Position.within(B.element,A[0],A[1]))},deactivate:function(A){if(A.hoverclass){Element.removeClassName(A.element,A.hoverclass)}this.last_active=null},activate:function(A){if(A.hoverclass){Element.addClassName(A.element,A.hoverclass)}this.last_active=A},show:function(A,C){if(!this.drops.length){return }var B,D=[];this.drops.each(function(E){if(Droppables.isAffected(A,C,E)){D.push(E)}});if(D.length>0){B=Droppables.findDeepestChild(D)}if(this.last_active&&this.last_active!=B){this.deactivate(this.last_active)}if(B){Position.within(B.element,A[0],A[1]);if(B.onHover){B.onHover(C,B.element,Position.overlap(B.overlap,B.element))}if(B!=this.last_active){Droppables.activate(B)}}},fire:function(B,A){if(!this.last_active){return }Position.prepare();if(this.isAffected([Event.pointerX(B),Event.pointerY(B)],A,this.last_active)){if(this.last_active.onDrop){this.last_active.onDrop(A,this.last_active.element,B);return true}}},reset:function(){if(this.last_active){this.deactivate(this.last_active)}}};var Draggables={drags:[],observers:[],register:function(A){if(this.drags.length==0){this.eventMouseUp=this.endDrag.bindAsEventListener(this);this.eventMouseMove=this.updateDrag.bindAsEventListener(this);this.eventKeypress=this.keyPress.bindAsEventListener(this);Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress)}this.drags.push(A)},unregister:function(A){this.drags=this.drags.reject(function(B){return B==A});if(this.drags.length==0){Event.stopObserving(document,"mouseup",this.eventMouseUp);Event.stopObserving(document,"mousemove",this.eventMouseMove);Event.stopObserving(document,"keypress",this.eventKeypress)}},activate:function(A){if(A.options.delay){this._timeout=setTimeout(function(){Draggables._timeout=null;window.focus();Draggables.activeDraggable=A}.bind(this),A.options.delay)}else{window.focus();this.activeDraggable=A}},deactivate:function(){this.activeDraggable=null},updateDrag:function(A){if(!this.activeDraggable){return }var B=[Event.pointerX(A),Event.pointerY(A)];if(this._lastPointer&&(this._lastPointer.inspect()==B.inspect())){return }this._lastPointer=B;this.activeDraggable.updateDrag(A,B)},endDrag:function(A){if(this._timeout){clearTimeout(this._timeout);this._timeout=null}if(!this.activeDraggable){return }this._lastPointer=null;this.activeDraggable.endDrag(A);this.activeDraggable=null},keyPress:function(A){if(this.activeDraggable){this.activeDraggable.keyPress(A)}},addObserver:function(A){this.observers.push(A);this._cacheObserverCallbacks()},removeObserver:function(A){this.observers=this.observers.reject(function(B){return B.element==A});this._cacheObserverCallbacks()},notify:function(B,A,C){if(this[B+"Count"]>0){this.observers.each(function(D){if(D[B]){D[B](B,A,C)}})}if(A.options[B]){A.options[B](A,C)}},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(A){Draggables[A+"Count"]=Draggables.observers.select(function(B){return B[A]}).length})}};var Draggable=Class.create({initialize:function(B){var C={handle:false,reverteffect:function(F,E,D){var G=Math.sqrt(Math.abs(E^2)+Math.abs(D^2))*0.02;new Effect.Move(F,{x:-D,y:-E,duration:G,queue:{scope:"_draggable",position:"end"}})},endeffect:function(E){var D=Object.isNumber(E._opacity)?E._opacity:1;new Effect.Opacity(E,{duration:0.2,from:0.7,to:D,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[E]=false}})},zindex:1000,revert:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,snap:false,delay:0};if(!arguments[1]||Object.isUndefined(arguments[1].endeffect)){Object.extend(C,{starteffect:function(D){D._opacity=Element.getOpacity(D);Draggable._dragging[D]=true;new Effect.Opacity(D,{duration:0.2,from:D._opacity,to:0.7})}})}var A=Object.extend(C,arguments[1]||{});this.element=$(B);if(A.handle&&Object.isString(A.handle)){this.handle=this.element.down("."+A.handle,0)}if(!this.handle){this.handle=$(A.handle)}if(!this.handle){this.handle=this.element}if(A.scroll&&!A.scroll.scrollTo&&!A.scroll.outerHTML){A.scroll=$(A.scroll);this._isScrollChild=Element.childOf(this.element,A.scroll)}Element.makePositioned(this.element);this.options=A;this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);Draggables.unregister(this)},currentDelta:function(){return([parseInt(Element.getStyle(this.element,"left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")])},initDrag:function(A){if(!Object.isUndefined(Draggable._dragging[this.element])&&Draggable._dragging[this.element]){return }if(Event.isLeftClick(A)){var C=Event.element(A);if((tag_name=C.tagName.toUpperCase())&&(tag_name=="INPUT"||tag_name=="SELECT"||tag_name=="OPTION"||tag_name=="BUTTON"||tag_name=="TEXTAREA")){return }var B=[Event.pointerX(A),Event.pointerY(A)];var D=Position.cumulativeOffset(this.element);this.offset=[0,1].map(function(E){return(B[E]-D[E])});Draggables.activate(this);Event.stop(A)}},startDrag:function(B){this.dragging=true;if(!this.delta){this.delta=this.currentDelta()}if(this.options.zindex){this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0);this.element.style.zIndex=this.options.zindex}if(this.options.ghosting){this._clone=this.element.cloneNode(true);this.element._originallyAbsolute=(this.element.getStyle("position")=="absolute");if(!this.element._originallyAbsolute){Position.absolutize(this.element)}this.element.parentNode.insertBefore(this._clone,this.element)}if(this.options.scroll){if(this.options.scroll==window){var A=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=A.left;this.originalScrollTop=A.top}else{this.originalScrollLeft=this.options.scroll.scrollLeft;this.originalScrollTop=this.options.scroll.scrollTop}}Draggables.notify("onStart",this,B);if(this.options.starteffect){this.options.starteffect(this.element)}},updateDrag:function(event,pointer){if(!this.dragging){this.startDrag(event)}if(!this.options.quiet){Position.prepare();Droppables.show(pointer,this.element)}Draggables.notify("onDrag",this,event);this.draw(pointer);if(this.options.change){this.options.change(this)}if(this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){p=[left,top,left+width,top+height]}}else{p=Position.page(this.options.scroll);p[0]+=this.options.scroll.scrollLeft+Position.deltaX;p[1]+=this.options.scroll.scrollTop+Position.deltaY;p.push(p[0]+this.options.scroll.offsetWidth);p.push(p[1]+this.options.scroll.offsetHeight)}var speed=[0,0];if(pointer[0]<(p[0]+this.options.scrollSensitivity)){speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)}if(pointer[1]<(p[1]+this.options.scrollSensitivity)){speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)}if(pointer[0]>(p[2]-this.options.scrollSensitivity)){speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)}if(pointer[1]>(p[3]-this.options.scrollSensitivity)){speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)}this.startScrolling(speed)}if(Prototype.Browser.WebKit){window.scrollBy(0,0)}Event.stop(event)},finishDrag:function(B,E){this.dragging=false;if(this.options.quiet){Position.prepare();var D=[Event.pointerX(B),Event.pointerY(B)];Droppables.show(D,this.element)}if(this.options.ghosting){if(!this.element._originallyAbsolute){Position.relativize(this.element)}delete this.element._originallyAbsolute;Element.remove(this._clone);this._clone=null}var F=false;if(E){F=Droppables.fire(B,this.element);if(!F){F=false}}if(F&&this.options.onDropped){this.options.onDropped(this.element)}Draggables.notify("onEnd",this,B);var A=this.options.revert;if(A&&Object.isFunction(A)){A=A(this.element)}var C=this.currentDelta();if(A&&this.options.reverteffect){if(F==0||A!="failure"){this.options.reverteffect(this.element,C[1]-this.delta[1],C[0]-this.delta[0])}}else{this.delta=C}if(this.options.zindex){this.element.style.zIndex=this.originalZ}if(this.options.endeffect){this.options.endeffect(this.element)}Draggables.deactivate(this);Droppables.reset()},keyPress:function(A){if(A.keyCode!=Event.KEY_ESC){return }this.finishDrag(A,false);Event.stop(A)},endDrag:function(A){if(!this.dragging){return }this.stopScrolling();this.finishDrag(A,true);Event.stop(A)},draw:function(A){var F=Position.cumulativeOffset(this.element);if(this.options.ghosting){var C=Position.realOffset(this.element);F[0]+=C[0]-Position.deltaX;F[1]+=C[1]-Position.deltaY}var E=this.currentDelta();F[0]-=E[0];F[1]-=E[1];if(this.options.scroll&&(this.options.scroll!=window&&this._isScrollChild)){F[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft;F[1]-=this.options.scroll.scrollTop-this.originalScrollTop}var D=[0,1].map(function(G){return(A[G]-F[G]-this.offset[G])}.bind(this));if(this.options.snap){if(Object.isFunction(this.options.snap)){D=this.options.snap(D[0],D[1],this)}else{if(Object.isArray(this.options.snap)){D=D.map(function(G,H){return(G/this.options.snap[H]).round()*this.options.snap[H]}.bind(this))}else{D=D.map(function(G){return(G/this.options.snap).round()*this.options.snap}.bind(this))}}}var B=this.element.style;if((!this.options.constraint)||(this.options.constraint=="horizontal")){B.left=D[0]+"px"}if((!this.options.constraint)||(this.options.constraint=="vertical")){B.top=D[1]+"px"}if(B.visibility=="hidden"){B.visibility=""}},stopScrolling:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=null;Draggables._lastScrollPointer=null}},startScrolling:function(A){if(!(A[0]||A[1])){return }this.scrollSpeed=[A[0]*this.options.scrollSpeed,A[1]*this.options.scrollSpeed];this.lastScrolled=new Date();this.scrollInterval=setInterval(this.scroll.bind(this),10)},scroll:function(){var current=new Date();var delta=current-this.lastScrolled;this.lastScrolled=current;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){if(this.scrollSpeed[0]||this.scrollSpeed[1]){var d=delta/1000;this.options.scroll.scrollTo(left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1])}}}else{this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1000;this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1000}Position.prepare();Droppables.show(Draggables._lastPointer,this.element);Draggables.notify("onDrag",this);if(this._isScrollChild){Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer);Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1000;Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1000;if(Draggables._lastScrollPointer[0]<0){Draggables._lastScrollPointer[0]=0}if(Draggables._lastScrollPointer[1]<0){Draggables._lastScrollPointer[1]=0}this.draw(Draggables._lastScrollPointer)}if(this.options.change){this.options.change(this)}},_getWindowScroll:function(w){var T,L,W,H;with(w.document){if(w.document.documentElement&&documentElement.scrollTop){T=documentElement.scrollTop;L=documentElement.scrollLeft}else{if(w.document.body){T=body.scrollTop;L=body.scrollLeft}}if(w.innerWidth){W=w.innerWidth;H=w.innerHeight}else{if(w.document.documentElement&&documentElement.clientWidth){W=documentElement.clientWidth;H=documentElement.clientHeight}else{W=body.offsetWidth;H=body.offsetHeight}}}return{top:T,left:L,width:W,height:H}}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(B,A){this.element=$(B);this.observer=A;this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark();if(this.lastValue!=Sortable.serialize(this.element)){this.observer(this.element)}}});var Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(A){while(A.tagName.toUpperCase()!="BODY"){if(A.id&&Sortable.sortables[A.id]){return A}A=A.parentNode}},options:function(A){A=Sortable._findRootElement($(A));if(!A){return }return Sortable.sortables[A.id]},destroy:function(A){var B=Sortable.options(A);if(B){Draggables.removeObserver(B.element);B.droppables.each(function(C){Droppables.remove(C)});B.draggables.invoke("destroy");delete Sortable.sortables[B.element.id]}},create:function(C){C=$(C);var B=Object.extend({element:C,tag:"li",dropOnEmpty:false,tree:false,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:C,handle:false,only:false,delay:0,hoverclass:null,ghosting:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:false,handles:false,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(C);var A={revert:true,quiet:B.quiet,scroll:B.scroll,scrollSpeed:B.scrollSpeed,scrollSensitivity:B.scrollSensitivity,delay:B.delay,ghosting:B.ghosting,constraint:B.constraint,handle:B.handle};if(B.starteffect){A.starteffect=B.starteffect}if(B.reverteffect){A.reverteffect=B.reverteffect}else{if(B.ghosting){A.reverteffect=function(F){F.style.top=0;F.style.left=0}}}if(B.endeffect){A.endeffect=B.endeffect}if(B.zindex){A.zindex=B.zindex}var D={overlap:B.overlap,containment:B.containment,tree:B.tree,hoverclass:B.hoverclass,onHover:Sortable.onHover};var E={onHover:Sortable.onEmptyHover,overlap:B.overlap,containment:B.containment,hoverclass:B.hoverclass};Element.cleanWhitespace(C);B.draggables=[];B.droppables=[];if(B.dropOnEmpty||B.tree){Droppables.add(C,E);B.droppables.push(C)}(B.elements||this.findElements(C,B)||[]).each(function(H,F){var G=B.handles?$(B.handles[F]):(B.handle?$(H).select("."+B.handle)[0]:H);B.draggables.push(new Draggable(H,Object.extend(A,{handle:G})));Droppables.add(H,D);if(B.tree){H.treeNode=C}B.droppables.push(H)});if(B.tree){(Sortable.findTreeElements(C,B)||[]).each(function(F){Droppables.add(F,E);F.treeNode=C;B.droppables.push(F)})}this.sortables[C.id]=B;Draggables.addObserver(new SortableObserver(C,B.onUpdate))},findElements:function(B,A){return Element.findChildren(B,A.only,A.tree?true:false,A.tag)},findTreeElements:function(B,A){return Element.findChildren(B,A.only,A.tree?true:false,A.treeTag)},onHover:function(E,D,A){if(Element.isParent(D,E)){return }if(A>0.33&&A<0.66&&Sortable.options(D).tree){return }else{if(A>0.5){Sortable.mark(D,"before");if(D.previousSibling!=E){var B=E.parentNode;E.style.visibility="hidden";D.parentNode.insertBefore(E,D);if(D.parentNode!=B){Sortable.options(B).onChange(E)}Sortable.options(D.parentNode).onChange(E)}}else{Sortable.mark(D,"after");var C=D.nextSibling||null;if(C!=E){var B=E.parentNode;E.style.visibility="hidden";D.parentNode.insertBefore(E,C);if(D.parentNode!=B){Sortable.options(B).onChange(E)}Sortable.options(D.parentNode).onChange(E)}}}},onEmptyHover:function(E,G,H){var I=E.parentNode;var A=Sortable.options(G);if(!Element.isParent(G,E)){var F;var C=Sortable.findElements(G,{tag:A.tag,only:A.only});var B=null;if(C){var D=Element.offsetSize(G,A.overlap)*(1-H);for(F=0;F<C.length;F+=1){if(D-Element.offsetSize(C[F],A.overlap)>=0){D-=Element.offsetSize(C[F],A.overlap)}else{if(D-(Element.offsetSize(C[F],A.overlap)/2)>=0){B=F+1<C.length?C[F+1]:null;break}else{B=C[F];break}}}}G.insertBefore(E,B);Sortable.options(I).onChange(E);A.onChange(E)}},unmark:function(){if(Sortable._marker){Sortable._marker.hide()}},mark:function(B,A){var D=Sortable.options(B.parentNode);if(D&&!D.ghosting){return }if(!Sortable._marker){Sortable._marker=($("dropmarker")||Element.extend(document.createElement("DIV"))).hide().addClassName("dropmarker").setStyle({position:"absolute"});document.getElementsByTagName("body").item(0).appendChild(Sortable._marker)}var C=Position.cumulativeOffset(B);Sortable._marker.setStyle({left:C[0]+"px",top:C[1]+"px"});if(A=="after"){if(D.overlap=="horizontal"){Sortable._marker.setStyle({left:(C[0]+B.clientWidth)+"px"})}else{Sortable._marker.setStyle({top:(C[1]+B.clientHeight)+"px"})}}Sortable._marker.show()},_tree:function(E,B,F){var D=Sortable.findElements(E,B)||[];for(var C=0;C<D.length;++C){var A=D[C].id.match(B.format);if(!A){continue}var G={id:encodeURIComponent(A?A[1]:null),element:E,parent:F,children:[],position:F.children.length,container:$(D[C]).down(B.treeTag)};if(G.container){this._tree(G.container,B,G)}F.children.push(G)}return F},tree:function(D){D=$(D);var C=this.options(D);var B=Object.extend({tag:C.tag,treeTag:C.treeTag,only:C.only,name:D.id,format:C.format},arguments[1]||{});var A={id:null,parent:null,children:[],container:D,position:0};return Sortable._tree(D,B,A)},_constructIndex:function(B){var A="";do{if(B.id){A="["+B.position+"]"+A}}while((B=B.parent)!=null);return A},sequence:function(B){B=$(B);var A=Object.extend(this.options(B),arguments[1]||{});return $(this.findElements(B,A)||[]).map(function(C){return C.id.match(A.format)?C.id.match(A.format)[1]:""})},setSequence:function(B,C){B=$(B);var A=Object.extend(this.options(B),arguments[2]||{});var D={};this.findElements(B,A).each(function(E){if(E.id.match(A.format)){D[E.id.match(A.format)[1]]=[E,E.parentNode]}E.parentNode.removeChild(E)});C.each(function(E){var F=D[E];if(F){F[1].appendChild(F[0]);delete D[E]}})},serialize:function(C){C=$(C);var B=Object.extend(Sortable.options(C),arguments[1]||{});var A=encodeURIComponent((arguments[1]&&arguments[1].name)?arguments[1].name:C.id);if(B.tree){return Sortable.tree(C,arguments[1]).children.map(function(D){return[A+Sortable._constructIndex(D)+"[id]="+encodeURIComponent(D.id)].concat(D.children.map(arguments.callee))}).flatten().join("&")}else{return Sortable.sequence(C,arguments[1]).map(function(D){return A+"[]="+encodeURIComponent(D)}).join("&")}}};Element.isParent=function(B,A){if(!B.parentNode||B==A){return false}if(B.parentNode==A){return true}return Element.isParent(B.parentNode,A)};Element.findChildren=function(D,B,A,C){if(!D.hasChildNodes()){return null}C=C.toUpperCase();if(B){B=[B].flatten()}var E=[];$A(D.childNodes).each(function(G){if(G.tagName&&G.tagName.toUpperCase()==C&&(!B||(Element.classNames(G).detect(function(H){return B.include(H)})))){E.push(G)}if(A){var F=Element.findChildren(G,B,A,C);if(F){E.push(F)}}});return(E.length>0?E.flatten():[])};Element.offsetSize=function(A,B){return A["offset"+((B=="vertical"||B=="height")?"Height":"Width")]};var CropDraggable=Class.create();Object.extend(Object.extend(CropDraggable.prototype,Draggable.prototype),{initialize:function(A){this.options=Object.extend({drawMethod:function(){}},arguments[1]||{});this.element=$(A);this.handle=this.element;this.delta=this.currentDelta();this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},draw:function(B){var A=Position.cumulativeOffset(this.element);var D=this.currentDelta();A[0]-=D[0];A[1]-=D[1];var C=[0,1].map(function(E){return(B[E]-A[E]-this.offset[E])}.bind(this));this.options.drawMethod(C)}});var Cropper={};Cropper.Img=Class.create();Cropper.Img.prototype={initialize:function(C,A){this.options=Object.extend({ratioDim:{x:0,y:0},minWidth:0,minHeight:0,displayOnInit:false,onEndCrop:Prototype.emptyFunction,captureKeys:true,onloaddisabledCoords:null,maxWidth:0,maxHeight:0},A||{});this.img=$(C);this.clickCoords={x:0,y:0};this.dragging=false;this.resizing=false;this.isWebKit=/Konqueror|Safari|KHTML/.test(navigator.userAgent);this.isIE=/MSIE/.test(navigator.userAgent);this.isOpera8=/Opera\s[1-8]/.test(navigator.userAgent);this.ratioX=0;this.ratioY=0;this.attached=false;this.fixedWidth=(this.options.maxWidth>0&&(this.options.minWidth>=this.options.maxWidth));this.fixedHeight=(this.options.maxHeight>0&&(this.options.minHeight>=this.options.maxHeight));if(typeof this.img=="undefined"){return }$A(document.getElementsByTagName("script")).each(function(F){if(F.src.match(/cropper\.js/)){var E=F.src.replace(/cropper\.js(.*)?/,"");var D=document.createElement("link");D.rel="stylesheet";D.type="text/css";D.href=E+"cropper.css";D.media="screen";document.getElementsByTagName("head")[0].appendChild(D)}});if(this.options.ratioDim.x>0&&this.options.ratioDim.y>0){var B=this.getGCD(this.options.ratioDim.x,this.options.ratioDim.y);this.ratioX=this.options.ratioDim.x/B;this.ratioY=this.options.ratioDim.y/B}this.subInitialize();if(this.img.complete||this.isWebKit){this.onLoad()}else{Event.observe(this.img,"loaddisabled",this.onLoad.bindAsEventListener(this))}},getGCD:function(B,A){if(A==0){return B}return this.getGCD(A,B%A)},onLoad:function(){var D="imgCrop_";var C=this.img.parentNode;var B="";if(this.isOpera8){B=" opera8"}this.imgWrap=Builder.node("div",{"class":D+"wrap"+B});this.north=Builder.node("div",{"class":D+"overlay "+D+"north"},[Builder.node("span")]);this.east=Builder.node("div",{"class":D+"overlay "+D+"east"},[Builder.node("span")]);this.south=Builder.node("div",{"class":D+"overlay "+D+"south"},[Builder.node("span")]);this.west=Builder.node("div",{"class":D+"overlay "+D+"west"},[Builder.node("span")]);var A=[this.north,this.east,this.south,this.west];this.dragArea=Builder.node("div",{"class":D+"dragArea"},A);this.handleN=Builder.node("div",{"class":D+"handle "+D+"handleN"});this.handleNE=Builder.node("div",{"class":D+"handle "+D+"handleNE"});this.handleE=Builder.node("div",{"class":D+"handle "+D+"handleE"});this.handleSE=Builder.node("div",{"class":D+"handle "+D+"handleSE"});this.handleS=Builder.node("div",{"class":D+"handle "+D+"handleS"});this.handleSW=Builder.node("div",{"class":D+"handle "+D+"handleSW"});this.handleW=Builder.node("div",{"class":D+"handle "+D+"handleW"});this.handleNW=Builder.node("div",{"class":D+"handle "+D+"handleNW"});this.selArea=Builder.node("div",{"class":D+"selArea"},[Builder.node("div",{"class":D+"marqueeHoriz "+D+"marqueeNorth"},[Builder.node("span")]),Builder.node("div",{"class":D+"marqueeVert "+D+"marqueeEast"},[Builder.node("span")]),Builder.node("div",{"class":D+"marqueeHoriz "+D+"marqueeSouth"},[Builder.node("span")]),Builder.node("div",{"class":D+"marqueeVert "+D+"marqueeWest"},[Builder.node("span")]),this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW,Builder.node("div",{"class":D+"clickArea"})]);this.imgWrap.appendChild(this.img);this.imgWrap.appendChild(this.dragArea);this.dragArea.appendChild(this.selArea);this.dragArea.appendChild(Builder.node("div",{"class":D+"clickArea"}));C.appendChild(this.imgWrap);this.startDragBind=this.startDrag.bindAsEventListener(this);Event.observe(this.dragArea,"mousedown",this.startDragBind);this.onDragBind=this.onDrag.bindAsEventListener(this);Event.observe(document,"mousemove",this.onDragBind);this.endCropBind=this.endCrop.bindAsEventListener(this);Event.observe(document,"mouseup",this.endCropBind);this.resizeBind=this.startResize.bindAsEventListener(this);this.handles=[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW];this.registerHandles(true);if(this.options.captureKeys){this.keysBind=this.handleKeys.bindAsEventListener(this);Event.observe(document,"keypress",this.keysBind)}new CropDraggable(this.selArea,{drawMethod:this.moveArea.bindAsEventListener(this)});this.setParams()},registerHandles:function(G){for(var E=0;E<this.handles.length;E++){var F=$(this.handles[E]);if(G){var D=false;if(this.fixedWidth&&this.fixedHeight){D=true}else{if(this.fixedWidth||this.fixedHeight){var C=F.className.match(/([S|N][E|W])$/);var B=F.className.match(/(E|W)$/);var A=F.className.match(/(N|S)$/);if(C){D=true}else{if(this.fixedWidth&&B){D=true}else{if(this.fixedHeight&&A){D=true}}}}}if(D){F.hide()}else{Event.observe(F,"mousedown",this.resizeBind)}}else{F.show();Event.stopObserving(F,"mousedown",this.resizeBind)}}},setParams:function(){this.imgW=this.img.width;this.imgH=this.img.height;$(this.north).setStyle({height:0});$(this.east).setStyle({width:0,height:0});$(this.south).setStyle({height:0});$(this.west).setStyle({width:0,height:0});$(this.imgWrap).setStyle({width:this.imgW+"px",height:this.imgH+"px"});$(this.selArea).hide();var B={x1:0,y1:0,x2:0,y2:0};var A=false;if(this.options.onloaddisabledCoords!=null){B=this.cloneCoords(this.options.onloaddisabledCoords);A=true}else{if(this.options.ratioDim.x>0&&this.options.ratioDim.y>0){B.x1=Math.ceil((this.imgW-this.options.ratioDim.x)/2);B.y1=Math.ceil((this.imgH-this.options.ratioDim.y)/2);B.x2=B.x1+this.options.ratioDim.x;B.y2=B.y1+this.options.ratioDim.y;A=true}}this.setAreaCoords(B,false,false,1);if(this.options.displayOnInit&&A){this.selArea.show();this.drawArea();this.endCrop()}this.attached=true},remove:function(){if(this.attached){this.attached=false;this.imgWrap.parentNode.insertBefore(this.img,this.imgWrap);this.imgWrap.parentNode.removeChild(this.imgWrap);Event.stopObserving(this.dragArea,"mousedown",this.startDragBind);Event.stopObserving(document,"mousemove",this.onDragBind);Event.stopObserving(document,"mouseup",this.endCropBind);this.registerHandles(false);if(this.options.captureKeys){Event.stopObserving(document,"keypress",this.keysBind)}}},reset:function(){if(!this.attached){this.onLoad()}else{this.setParams()}this.endCrop()},handleKeys:function(B){var A={x:0,y:0};if(!this.dragging){switch(B.keyCode){case (37):A.x=-1;break;case (38):A.y=-1;break;case (39):A.x=1;break;case (40):A.y=1;break}if(A.x!=0||A.y!=0){if(B.shiftKey){A.x*=10;A.y*=10}this.moveArea([this.areaCoords.x1+A.x,this.areaCoords.y1+A.y]);Event.stop(B)}}},calcW:function(){return(this.areaCoords.x2-this.areaCoords.x1)},calcH:function(){return(this.areaCoords.y2-this.areaCoords.y1)},moveArea:function(A){this.setAreaCoords({x1:A[0],y1:A[1],x2:A[0]+this.calcW(),y2:A[1]+this.calcH()},true,false);this.drawArea()},cloneCoords:function(A){return{x1:A.x1,y1:A.y1,x2:A.x2,y2:A.y2}},setAreaCoords:function(E,D,C,B,M){if(D){var K=E.x2-E.x1;var I=E.y2-E.y1;if(E.x1<0){E.x1=0;E.x2=K}if(E.y1<0){E.y1=0;E.y2=I}if(E.x2>this.imgW){E.x2=this.imgW;E.x1=this.imgW-K}if(E.y2>this.imgH){E.y2=this.imgH;E.y1=this.imgH-I}}else{if(E.x1<0){E.x1=0}if(E.y1<0){E.y1=0}if(E.x2>this.imgW){E.x2=this.imgW}if(E.y2>this.imgH){E.y2=this.imgH}if(B!=null){if(this.ratioX>0){this.applyRatio(E,{x:this.ratioX,y:this.ratioY},B,M)}else{if(C){this.applyRatio(E,{x:1,y:1},B,M)}}var H=[this.options.minWidth,this.options.minHeight];var G=[this.options.maxWidth,this.options.maxHeight];if(H[0]>0||H[1]>0||G[0]>0||G[1]>0){var F={a1:E.x1,a2:E.x2};var A={a1:E.y1,a2:E.y2};var L={min:0,max:this.imgW};var J={min:0,max:this.imgH};if((H[0]!=0||H[1]!=0)&&C){if(H[0]>0){H[1]=H[0]}else{if(H[1]>0){H[0]=H[1]}}}if((G[0]!=0||G[0]!=0)&&C){if(G[0]>0&&G[0]<=G[1]){G[1]=G[0]}else{if(G[1]>0&&G[1]<=G[0]){G[0]=G[1]}}}if(H[0]>0){this.applyDimRestriction(F,H[0],B.x,L,"min")}if(H[1]>1){this.applyDimRestriction(A,H[1],B.y,J,"min")}if(G[0]>0){this.applyDimRestriction(F,G[0],B.x,L,"max")}if(G[1]>1){this.applyDimRestriction(A,G[1],B.y,J,"max")}E={x1:F.a1,y1:A.a1,x2:F.a2,y2:A.a2}}}}this.areaCoords=E},applyDimRestriction:function(E,F,C,D,B){var A;if(B=="min"){A=((E.a2-E.a1)<F)}else{A=((E.a2-E.a1)>F)}if(A){if(C==1){E.a2=E.a1+F}else{E.a1=E.a2-F}if(E.a1<D.min){E.a1=D.min;E.a2=F}else{if(E.a2>D.max){E.a1=D.max-F;E.a2=D.max}}}},applyRatio:function(A,E,D,C){var B;if(C=="N"||C=="S"){B=this.applyRatioToAxis({a1:A.y1,b1:A.x1,a2:A.y2,b2:A.x2},{a:E.y,b:E.x},{a:D.y,b:D.x},{min:0,max:this.imgW});A.x1=B.b1;A.y1=B.a1;A.x2=B.b2;A.y2=B.a2}else{B=this.applyRatioToAxis({a1:A.x1,b1:A.y1,a2:A.x2,b2:A.y2},{a:E.x,b:E.y},{a:D.x,b:D.y},{min:0,max:this.imgH});A.x1=B.a1;A.y1=B.b1;A.x2=B.a2;A.y2=B.b2}},applyRatioToAxis:function(D,B,J,I){var H=Object.extend(D,{});var G=H.a2-H.a1;var F=Math.floor(G*B.b/B.a);var E;var C;var A=null;if(J.b==1){E=H.b1+F;if(E>I.max){E=I.max;A=E-H.b1}H.b2=E}else{E=H.b2-F;if(E<I.min){E=I.min;A=E+H.b2}H.b1=E}if(A!=null){C=Math.floor(A*B.a/B.b);if(J.a==1){H.a2=H.a1+C}else{H.a1=H.a1=H.a2-C}}return H},drawArea:function(){var I=this.calcW();var H=this.calcH();var J="px";var E=[this.areaCoords.x1+J,this.areaCoords.y1+J,I+J,H+J,this.areaCoords.x2+J,this.areaCoords.y2+J,(this.img.width-this.areaCoords.x2)+J,(this.img.height-this.areaCoords.y2)+J];var D=this.selArea.style;D.left=E[0];D.top=E[1];D.width=E[2];D.height=E[3];var C=Math.ceil((I-6)/2)+J;var B=Math.ceil((H-6)/2)+J;this.handleN.style.left=C;this.handleE.style.top=B;this.handleS.style.left=C;this.handleW.style.top=B;this.north.style.height=E[1];var A=this.east.style;A.top=E[1];A.height=E[3];A.left=E[4];A.width=E[6];var G=this.south.style;G.top=E[5];G.height=E[7];var F=this.west.style;F.top=E[1];F.height=E[3];F.width=E[0];this.subDrawArea();this.forceReRender()},forceReRender:function(){if(this.isIE||this.isWebKit){var F=document.createTextNode(" ");var D,B,E,A;if(this.isIE){fixEl=this.selArea}else{if(this.isWebKit){fixEl=document.getElementsByClassName("imgCrop_marqueeSouth",this.imgWrap)[0];D=Builder.node("div","");D.style.visibility="hidden";var C=["SE","S","SW"];for(A=0;A<C.length;A++){B=document.getElementsByClassName("imgCrop_handle"+C[A],this.selArea)[0];if(B.childNodes.length){B.removeChild(B.childNodes[0])}B.appendChild(D)}}}fixEl.appendChild(F);fixEl.removeChild(F)}},startResize:function(A){this.startCoords=this.cloneCoords(this.areaCoords);this.resizing=true;this.resizeHandle=Event.element(A).classNames().toString().replace(/([^N|NE|E|SE|S|SW|W|NW])+/,"");Event.stop(A)},startDrag:function(A){this.selArea.show();this.clickCoords=this.getCurPos(A);this.setAreaCoords({x1:this.clickCoords.x,y1:this.clickCoords.y,x2:this.clickCoords.x,y2:this.clickCoords.y},false,false,null);this.dragging=true;this.onDrag(A);Event.stop(A)},getCurPos:function(B){var A=this.imgWrap,C=Position.cumulativeOffset(A);while(A.nodeName!="BODY"){C[1]-=A.scrollTop||0;C[0]-=A.scrollLeft||0;A=A.parentNode}return curPos={x:Event.pointerX(B)-C[0],y:Event.pointerY(B)-C[1]}},onDrag:function(E){if(this.dragging||this.resizing){var D=null;var C=this.getCurPos(E);var B=this.cloneCoords(this.areaCoords);var A={x:1,y:1};if(this.dragging){if(C.x<this.clickCoords.x){A.x=-1}if(C.y<this.clickCoords.y){A.y=-1}this.transformCoords(C.x,this.clickCoords.x,B,"x");this.transformCoords(C.y,this.clickCoords.y,B,"y")}else{if(this.resizing){D=this.resizeHandle;if(D.match(/E/)){this.transformCoords(C.x,this.startCoords.x1,B,"x");if(C.x<this.startCoords.x1){A.x=-1}}else{if(D.match(/W/)){this.transformCoords(C.x,this.startCoords.x2,B,"x");if(C.x<this.startCoords.x2){A.x=-1}}}if(D.match(/N/)){this.transformCoords(C.y,this.startCoords.y2,B,"y");if(C.y<this.startCoords.y2){A.y=-1}}else{if(D.match(/S/)){this.transformCoords(C.y,this.startCoords.y1,B,"y");if(C.y<this.startCoords.y1){A.y=-1}}}}}this.setAreaCoords(B,false,E.shiftKey,A,D);this.drawArea();Event.stop(E)}},transformCoords:function(E,D,C,B){var A=[E,D];if(E>D){A.reverse()}C[B+"1"]=A[0];C[B+"2"]=A[1]},endCrop:function(){this.dragging=false;this.resizing=false;this.options.onEndCrop(this.areaCoords,{width:this.calcW(),height:this.calcH()})},subInitialize:function(){},subDrawArea:function(){}};Cropper.ImgWithPreview=Class.create();Object.extend(Object.extend(Cropper.ImgWithPreview.prototype,Cropper.Img.prototype),{subInitialize:function(){this.hasPreviewImg=false;if(typeof (this.options.previewWrap)!="undefined"&&this.options.minWidth>0&&this.options.minHeight>0){this.previewWrap=$(this.options.previewWrap);this.previewImg=this.img.cloneNode(false);this.previewImg.id="imgCrop_"+this.previewImg.id;this.options.displayOnInit=true;this.hasPreviewImg=true;this.previewWrap.addClassName("imgCrop_previewWrap");this.previewWrap.setStyle({width:this.options.minWidth+"px",height:this.options.minHeight+"px"});this.previewWrap.appendChild(this.previewImg)}},subDrawArea:function(){if(this.hasPreviewImg){var F=this.calcW();var E=this.calcH();var C={x:this.imgW/F,y:this.imgH/E};var D={x:F/this.options.minWidth,y:E/this.options.minHeight};var B={w:Math.ceil(this.options.minWidth*C.x)+"px",h:Math.ceil(this.options.minHeight*C.y)+"px",x:"-"+Math.ceil(this.areaCoords.x1/D.x)+"px",y:"-"+Math.ceil(this.areaCoords.y1/D.y)+"px"};var A=this.previewImg.style;A.width=B.w;A.height=B.h;A.left=B.x;A.top=B.y}}});var ImageTagPage=Class.create();ImageTagPage.prototype={celllist:null,enablehandler:null,actioncallbacks:{onmouseover:null,onmouseout:null},mouseactions:null,initialize:function(){this.celllist=new Array();this.callbacklist=new Array()},addImg:function(A){this.celllist[A]=new ImageTag(A,this);this.celllist[A].setMouseActions(this.mouseactions);return this.celllist[A]},addTagToImg:function(B,A){if(typeof (this.celllist[B])=="undefined"){this.addImg(B)}this.getImageTag(B).addTag(A)},addTagListToImg:function(C,A,B){if(typeof (this.celllist[C])=="undefined"||B==true){this.addImg(C)}this.getImageTag(C).addTagList(A)},removeTagFromImg:function(C,E,D,B){var A=this.getImageTag(C);if(A){A.removeTag(E,D,B)}},showTagsOnImg:function(B){var A=this.getImageTag(B);if(A){A.showAllTags()}},hideTagsOnImg:function(B){var A=this.getImageTag(B);if(A){A.hideAllTags()}},showTagTextsOnImg:function(B){var A=this.getImageTag(B);if(A){A.showAllTagTexts()}},hideTagTextsOnImg:function(B){var A=this.getImageTag(B);if(A){A.hideAllTagTexts()}},getImageTag:function(A){return this.celllist[A]},disableTagsOnImg:function(B,C){var A=this.getImageTag(B);if(A){A.disableTags(C)}},enableTagsOnImg:function(B,C){var A=this.getImageTag(B);if(A){A.enableTags(C)}},handleDisableClick_Closure:function(A,C,B,D){return function(E){this.disableTagsOnImg(A,C);this.enablehandler=this.handleEnableClick_Closure(A,C,B).bindAsEventListener(this);Event.observe(B,"click",this.enablehandler);if(typeof (D)=="undefined"||D===true){Event.stop(E)}return true}},handleEnableClick_Closure:function(A,C,B){return function(D){this.enableTagsOnImg(A,C);Event.stopObserving(B,"click",this.enablehandler);return true}},addEventCallback:function(A,B){this.callbacklist[A]=B},setGlobalMouseActions:function(D){var C=$H(this.celllist).keys();var A=null;Object.extend(this.mouseactions,D||{});for(var B=0;B<C.length;B++){this.setMouseActionsOnImg(C.get(B),D)}},setGlobalMouseAction:function(D,F,E){var C=$H(this.celllist).keys();var A=null;this.mouseactions[D][F]=E;for(var B=0;B<C.length;B++){this.setMouseActionOnImg(C.get(B),D,F,E)}},setMouseActionsOnImg:function(B,C){var A=this.getImageTag(B);if(A){A.setMouseActions(C)}},setMouseActionOnImg:function(B,C,E,D){var A=this.getImageTag(B);if(A){A.setMouseAction(C,E,D)}}};var pageTags=new ImageTagPage();var ImageTag=Class.create();ImageTag.prototype={img_id:"",taglist:null,tagidmap:null,tagimg:null,tagimgx:0,tagimgy:0,tagenv:null,parent:null,disable:false,mouseactions:{box:{mouseover:"showtextbox",mouseout:"hideboth",click:"none"},textbox:{mouseover:"showtextbox",mouseout:"hideboth",click:"golink"},link:{mouseover:"showbox",mouseout:"hideboth",click:"golink"}},basezindex:100,tagboxtextoffsety:4,tagboxtextoffsetx:2,textminx:0,textminy:0,textmaxx:0,textmaxy:0,textminwidth:75,textwidthmultiplier:2,textContainerClassName:"tagText",initialize:function(A,C){this.taglist=new Array();this.tagidmap=new Array();this.img_id=A;if(typeof (C)=="object"){this.parent=C}this.tagimg=$(A);this.tagimgx=Element.getWidth(this.tagimg);this.tagimgy=Element.getHeight(this.tagimg);this.tagenv=$("imgEnv-"+A);if(!this.tagenv){var B=this.tagimg.parentNode;this.tagenv=Builder.node("div",{id:"imgEnv-"+A,className:"imgEnv",style:"width:"+this.tagimgx+"px; height:"+this.tagimgy+"px; vertical-align:middle;"},[this.tagimg]);B.appendChild(this.tagenv)}},addTagList:function(B){for(var A=0;A<B.length;A++){this.addTag(B[A])}},addTag:function(A){if(typeof (A)!="object"||A.boxId=="0_0_1000_1000"){return false}var B=A.tag_id;this.taglist.push(A);this.tagidmap[A.tag_id]=this.taglist.length-1;if(typeof (A.tag)!="undefined"&&A.tag!=""){this.addTagListItem(B,A)}if(ImageTag.pointDataExists(A)&&ImageTag.getArea(A)>0){this.addTagDisplayDiv(A)}this.reorderTagZIndex()},addTagDisplayDiv:function(B){var E="";var A="";if(typeof (B.tag)!="undefined"&&B.tag!=""&&B.tag!=null){E=(""+B.tag).stripTags().stripScripts()}if(typeof (B.url)!="undefined"&&B.url!=""&&B.url!=null){A=(""+B.url).stripTags().stripScripts()}var D=this.getTagDimensions(B);var C=$(this.getTagTextNode(B.boxId,D));this.setTagText(E,A,C,D,B.tag_id)},getTagDimensions:function(E){var C=this.tagimgx*E.p1x;var B=this.tagimgy*E.p1y;var D=this.tagimgx*Math.abs(E.p2x-E.p1x);var A=this.tagimgy*Math.abs(E.p2y-E.p1y);return{offsetX:C,offsetY:B,width:D,height:A}},getTagTextNode:function(D,E){this.tagenv=$(this.tagenv);var F=this.tagenv.down(".tagTextBox_"+D);if(!F){var C=Builder.node("div",{className:"tag tag_"+D});C.style.top=E.offsetY+"px";C.style.left=E.offsetX+"px";C.style.width=E.width+"px";C.style.height=E.height+"px";C.onmouseover=this.handleTagMouseover_Closure(D,"box").bindAsEventListener(this);C.onmouseout=this.handleTagMouseout_Closure(D,"box").bindAsEventListener(this);this.tagenv.appendChild(C);var A=Builder.node("img",{width:E.width,height:E.height,src:"httpdisabled://pic.pbsrc.com/spacer.gif",className:"tagImg"});var I=Builder.node("div",{className:"tagBoxInner tagBoxInner_"+D,style:"visibility: hidden"},[A]);var H=Builder.node("div",{className:"tagBoxOuter tagBoxOuter_"+D,style:"visibility: hidden"},[I]);C.appendChild(H);var B=Builder.node("div",{className:this.textContainerClassName+" tagText_"+D,style:"visibility: hidden"});var G=Builder.node("img",{src:"httpdisabled://pic.pbsrc.com/spacer.gif",className:"tagTextImg"});F=Builder.node("div",{className:"tagTextBox tagTextBox_"+D},[G,B]);F.onmouseover=this.handleTagMouseover_Closure(D,"textbox").bindAsEventListener(this);F.onmouseout=this.handleTagMouseout_Closure(D,"textbox").bindAsEventListener(this);this.tagenv.appendChild(F)}return F},setTagText:function(M,B,E,G,C){var D=E.down("."+this.textContainerClassName);var K=document.createElement("span");K.setAttribute("id","tagTextSpan_"+C);M=M.unescapeHTML();if(D.innerHTML!=""){K.appendChild(document.createTextNode(", "))}if(B){var I=Builder.node("a",{href:"javascript:void(0)",title:"Go to: "+B});I.appendChild(document.createTextNode(M));I.onclick=this.handleTagClick_Closure("link","textbox",B).bindAsEventListener(this);K.appendChild(I)}else{K.appendChild(document.createTextNode(M))}D.appendChild(K);var A=(G.offsetY+G.height+this.tagboxtextoffsety);var F=this.optimizeTagWidth(this.tagenv,D.innerHTML.stripTags(),G.width*this.textwidthmultiplier);var L=G.offsetX+(G.width-F)/2+this.tagboxtextoffsetx;var J=Element.getHeight(D);E.style.top=A+"px";E.style.left=L+"px";E.style.width=F+"px";E.style.height=J+"px";var H=E.down(".tagTextImg");if((A+J)>(this.tagimgy+this.textmaxy)){A=this.tagimgy-J}if((L+F)>(this.tagimgx+this.textmaxx)){L=this.tagimgx-F}if(A<this.textminy){A=this.textminy}if(L<this.textminx){L=this.textminx}E.style.top=A+"px";E.style.left=L+"px"},optimizeTagWidth:function(A,I,J){var G=$w(I);var D=G.length;var C=G.join(" <br/>");if(J<this.textminwidth){J=this.textminwidth}var B=Builder.node("div",{style:"visibility:hidden; position:absolute; top:0; left:0; padding:5px; border:2px"});B.innerHTML=C;A.appendChild(B);var H=Element.getWidth(B);A.removeChild(B);var F=H;if(H<J){var E=Math.floor(J/H);if(D<E){E=D}F=H*E}return F},reorderTagZIndex:function(){this.taglist.sort(function(G,F){if(ImageTag.pointDataExists(G)&&ImageTag.pointDataExists(F)){aArea=ImageTag.getArea(G);bArea=ImageTag.getArea(F);return(bArea-aArea)}return 0});for(var D=0;D<this.taglist.length;D++){var E=this.taglist[D].boxId;var C=this.basezindex+D;this.tagidmap[this.taglist[D].tag_id]=D;var B=$$(".tag_"+E)[0];if(B){B.style.zIndex=C;var A=$$(".tagTextBox_"+E)[0];if(A){A.style.zIndex=C}}}},addTagListItem:function(B,A){},removeTag:function(D,C,B){this.removeTagDisplayDiv(D,C,B);var A=this.tagidmap[D];this.tagidmap.splice(D,1);this.taglist.splice(A,1);this.reorderTagZIndex()},removeTagDisplayDiv:function(G,D,F){var C=$$(".tagTextBox_"+D)[0];var B=$("tagTextSpan_"+G);var E=$$(".tag_"+D)[0];var A=C.select("span");if(A.length==1){Element.remove(C);Element.remove(E)}else{Element.remove(B)}},removeTagListItem:function(A){},handleTagMouseover_Closure:function(B,A){return function(D){if(this.disable==true){return }if(typeof (this.parent.callbacklist.mouseover)=="function"){this.parent.callbacklist.mouseover(this.img_id)}var C=D.type;if(this.mouseactions[A][C]=="showtextbox"||this.mouseactions[A][C]=="showboth"){ImageTag.showTagText(B,this.tagenv)}if(this.mouseactions[A][C]=="showbox"||this.mouseactions[A][C]=="showboth"){ImageTag.showTag(B,this.tagenv)}}},handleTagMouseout_Closure:function(B,A){return function(D){if(this.disable==true){return }if(typeof (this.parent.callbacklist.mouseout)=="function"){this.parent.callbacklist.mouseout(this.img_id)}var C=D.type;if(this.mouseactions[A][C]=="hidetextbox"||this.mouseactions[A][C]=="hideboth"){ImageTag.hideTagText(B,this.tagenv)}if(this.mouseactions[A][C]=="hidebox"||this.mouseactions[A][C]=="hideboth"){ImageTag.hideTag(B,this.tagenv)}}},handleTagClick_Closure:function(C,B,A){return function(F){if(this.disable==true){return }if(typeof (this.parent.callbacklist.click)=="function"){this.parent.callbacklist.click(this.img_id)}var D=F.type;if(this.mouseactions[B][D]=="golink"){var E=void(A,"Tag_"+C);E.focus()}}},showAllTags:function(){for(var A=0;A<this.taglist.length;A++){ImageTag.showTag(this.taglist[A].tag_id,this.tagenv)}},hideAllTags:function(){for(var A=0;A<this.taglist.length;A++){ImageTag.hideTag(this.taglist[A].tag_id,this.tagenv)}},showAllTagTexts:function(){for(var A=0;A<this.taglist.length;A++){ImageTag.showTagText(this.taglist[A].tag_id,this.tagenv)}},hideAllTagTexts:function(){for(var A=0;A<this.taglist.length;A++){ImageTag.hideTagText(this.taglist[A].tag_id,this.tagenv)}},disableTags:function(B){this.disable=true;if(B==true){for(var A=0;A<this.taglist.length;A++){ImageTag.disableTagDisplay(this.taglist[A].tag_id,this.tagenv)}}},enableTags:function(B){this.disable=false;if(B==true){for(var A=0;A<this.taglist.length;A++){ImageTag.enableTagDisplay(this.taglist[A].tag_id,this.tagenv)}}},setMouseActions:function(A){Object.extend(this.mouseactions,A||{})},setMouseAction:function(A,C,B){this.mouseactions[A][C]=B}};ImageTag.pointDataExists=function(A){if(typeof (A.p1x)!="undefined"&&typeof (A.p2x)!="undefined"&&typeof (A.p1y)!="undefined"&&typeof (A.p2y)!="undefined"){return true}return false},ImageTag.getArea=function(A){return Math.abs(A.p2x-A.p1x)*Math.abs(A.p2y-A.p1y)},ImageTag.showTag=function(D,C){C=C||"imageEnvelope";var B=$(C);var A=B.down(".tagBoxOuter_"+D);if(A){A.style.visibility="visible";B.down(".tagBoxInner_"+D).style.visibility="visible"}},ImageTag.hideTag=function(D,C){C=C||"imageEnvelope";var B=$(C);var A=B.down(".tagBoxOuter_"+D);if(A){A.style.visibility="hidden";B.down(".tagBoxInner_"+D).style.visibility="hidden"}},ImageTag.showTagText=function(D,B){B=B||"imageEnvelope";var A=$(B);var C=A.down(".tagText_"+D);if(C){C.style.visibility="visible"}},ImageTag.hideTagText=function(D,B){B=B||"imageEnvelope";var A=$(B);var C=A.down(".tagText_"+D);if(C){C.style.visibility="hidden"}},ImageTag.disableTagDisplay=function(F,B){B=B||"imageEnvelope";var A=$(B);var E="none";var D=A.down(".tag_"+F);if(D){D.style.display=E}var C=A.down(".tagTextBox_"+F);if(C){C.style.display=E}},ImageTag.enableTagDisplay=function(F,B){B=B||"imageEnvelope";var A=$(B);var E="";var D=A.down(".tag_"+F);if(D){D.style.display=E}var C=A.down(".tagTextBox_"+F);if(C){C.style.display=E}};var TagEditorController;(function(){var A={tagContainerId:"listCurrentTags",tagListClassName:"tagListContainer",imgId:"fullSizeContainer",observing:false,isSearch:false,initialize:function(){if(this.observing==false){Event.observe(document,Autocompleter.LocalTags.EVENT.TAG_ADDED,this.addTag.bindAsEventListener(this));Event.observe(document,Autocompleter.LocalTags.EVENT.TAG_REMOVED,this.removeTag.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.PRIMARY_UPDATE,this.onPagination.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.SECONDARY_UPDATE,this.onSecondaryData.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.FULL_UPDATE,this.onFullData.bindAsEventListener(this));this.observing=true;this.tagContainer=jq("#tagContainer")}},onPagination:function(D){if(this.tagContainer.length>0){this.tagContainer.text("")}var C=jq("#imgEnv-fullSizeContainer");C.find(".tag").remove();C.find(".tagTextBox").remove()},onSecondaryData:function(I){var E=I.memo.tags;if(E.length){pageTags.addTagListToImg("fullSizedImage",E,true)}if(this.isSearch){var H="";for(var F=0,D=E.length;F<D;F++){if(F==0){H='<label id="photoTagsLabel" class="empty">Tags in this image: </label>'}else{H+=" | "}H+='<a href="'+baseURL+"/images/"+E[F].tag+'" onmouseover="ImageTag.showTag(\''+E[F].boxId+"');\" onmouseout=\"ImageTag.hideTag('"+E[F].boxId+"');\">"+E[F].tag+"</a>"}var C=jq("#tagContainer");C.css("display","none");var G=$("tagContainer");G.innerHTML=H;C.fadeIn("slow")}},onFullData:function(C){this.onPagination(C);this.onSecondaryData(C)},addTag:function(D){if(pageTags){var C=PBTag.validate(D.memo.tag);if(C.boxId!="0_0_1000_1000"){pageTags.addTagToImg(this.imgId,C.toPageTagConfig())}}},removeTag:function(D){var C=D.memo.tag;this.removeTagFromImage(this.imgId,C);if(PBLightbox.getInstance().panel.active){this.removeTagFromImage(PBLightbox.getInstance().panel.lightboxId,C)}},removeTagFromImage:function(E,C){var D=$(E);var H=D.select(".tagTextBox_"+C.boxId)[0];var G=D.select("#tagTextSpan_"+C.id)[0];var I=D.select(".tag_"+C.boxId)[0];if(H){var F=H.select("span");if(F.length==1){Element.remove(H);Element.remove(I)}else{Element.remove(G)}}}};var B={};Controller.create("TagEditorController",A,B)})();var FullViewMetaDataController;(function(){var A={tracking:null,init:false,initialize:function(){document.observe(FullViewPaginatorController.EVENT.PRIMARY_UPDATE,this.onPagination.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.SECONDARY_UPDATE,this.onSecondaryData.bindAsEventListener(this));document.observe(FullViewPaginatorController.EVENT.FULL_UPDATE,this.onFullData.bindAsEventListener(this));document.observe(CollapsableModuleController.EVENT.UPDATE,this.onImageInfoClick.bindAsEventListener(this));this.xid=null},findContainers:function(){this.container=jq("#containerMetaData");this.shareEmail=jq("#shareemail");this.shareDirect=jq("#sharedirectlink");this.shareHtml=jq("#sharehtml");this.shareHtmlThumb=jq("#sharehtmlthumb");this.shareImg=jq("#shareimg");this.shareImgThumb=jq("#shareimgthumb");this.shareFlash=jq("#shareflash");this.shareLink=jq("#share_fullview_link_container");this.shareButton=jq("#share_fullview_button_container");this.shareModuleContainer=jq("#sharefullviewmodule");this.shareModuleTitle=jq("#sharefullviewmodule .title");this.imageInfoContainer=jq("#imageinfo");this.imageInfoTitle=this.imageInfoContainer.find("h5.title");this.exifContainer=this.imageInfoContainer.find("#containerEXIF");this.exifProgress=this.imageInfoContainer.find("div.progress")},onPagination:function(H){if(!this.init){this.findContainers();this.init=true}var F=H.memo;this.xid=F.xid;this.container.css("visibility","hidden");var E=this.imageInfoContainer.find("div.collapsible");var G=this.imageInfoContainer.find("div.header");if(E.css("display")=="block"){var C=this.imageInfoContainer.find("div.header .collapsible-icon span");E.toggle();C.toggle();G.toggleClass("collapsed")}this.hideSharePanel();if(photobucket.browser.isIE){this.shareModuleContainer.find("div.transBackground").css("filter","alpha(opacity=50)").css("zoom","1");this.shareModuleContainer.find("div.header").css("filter","alpha(opacity=50)").css("zoom","1")}else{this.shareModuleContainer.find("div.transBackground").fadeTo("fast",0.5);this.shareModuleContainer.find("div.header").fadeTo("fast",0.5)}this.shareModuleContainer.find("div.transBackground").css("z-index","3002");this.shareModuleContainer.find(".shroud").show();if(H.memo.type=="image"){var D="Photo info"}else{var D="More info"}this.imageInfoTitle.html(D);this.currentMedia=F},onSecondaryData:function(E){if(this.xid==E.memo.xid){var C=E.memo.metaHTML;this.container.replaceWith(C);this.container=jq("#containerMetaData");this.container.css("visibility","visible");var D=E.memo.type;this.updateSharePanel(E.memo.media,D)}},updateZeroClipboard:function(D){var C=CopyCodeController.getInstance();if(C.hasClient(D)){C.createZeroClipboard(D)}},hideSharePanel:function(){if(this.shareLink.length>0){this.shareLink.hide()}},updateSharePanel:function(D,C){if(C=="video_h264"){C="video"}else{if(C=="image"){C="photo"}}var E="Share this "+C;this.shareModuleTitle.html(E);if(this.shareEmail.length>0){this.shareEmail.val(D.codeBrowseURL);this.updateZeroClipboard("shareemail")}if(this.shareDirect.length>0){this.shareDirect.val(D.codeURL);this.updateZeroClipboard("sharedirectlink")}if(this.shareHtml.length>0){this.shareHtml.val(D.codeHTML);this.updateZeroClipboard("sharehtml")}if(this.shareHtmlThumb.length>0){this.shareHtmlThumb.val(D.codeTagThumb);this.updateZeroClipboard("sharehtmlthumb")}if(this.shareImg.length>0){this.shareImg.val(D.codeIMG);this.updateZeroClipboard("shareimg")}if(this.shareImgThumb.length>0){this.shareImgThumb.val(D.codeIMGThumb);this.updateZeroClipboard("shareimgthumb")}if(this.shareFlash.length>0){this.shareFlash.val(D.codeURLFlash);this.updateZeroClipboard("shareflash")}if(this.shareLink.length>0){this.shareLink.show();this.shareLink.html(D.shareLink)}if(this.shareButton.length>0){this.shareButton.html(D.shareButton)}if(photobucket.browser.isIE){this.shareModuleContainer.find("div.transBackground").css("filter","alpha(opacity=80)");this.shareModuleContainer.find("div.header").css("filter","")}else{this.shareModuleContainer.find("div.transBackground").fadeTo("fast",0.8);this.shareModuleContainer.find("div.header").fadeTo("fast",1)}this.shareModuleContainer.find("div.transBackground").css("z-index","3000");this.shareModuleContainer.find(".shroud").hide()},onFullData:function(C){this.onPagination(C);this.onSecondaryData(C)},onImageInfoClick:function(E){if(this.tracking){tr(this.tracking)}if(this.currentMedia){var C=this.exifContainer.height();this.exifProgress.css("display","block");this.exifProgress.css("height",C+20+"px");var D=this.currentMedia.browseUrl+"&fetchExif=true";jq.ajax({url:D,dataType:"jsonp",jsonp:"jsoncallback",success:function(G){var F=G.response.exif;this.exifContainer.html(F);this.exifContainer.css("height","100%");this.exifProgress.css("display","none")}.bind(this)})}}};var B={};Controller.create("FullViewMetaDataController",A,B)})();(function(E){E.fn.editInPlace=function(F){var G=E.extend({},E.fn.editInPlace.defaults,F);B(G);C(G.saving_image);return this.each(function(){var H=E(this);if(H.data("editInPlace")){return }H.data("editInPlace",true);new D(G,H).init()})};E.fn.editInPlace.defaults={url:"",bg_over:"#ffc",bg_out:"transparent",hover_class:"",show_buttons:false,save_button:'<button class="inplace_save">Save</button>',cancel_button:'<button class="inplace_cancel">Cancel</button>',params:"",field_type:"text",default_text:"(Click here to add text)",textarea_rows:10,textarea_cols:25,select_text:"Choose new value",select_options:"",saving_text:"Saving...",saving_image:"",saving_animation_color:"transparent",value_required:false,element_id:"element_id",update_value:"update_value",original_html:"original_html",save_if_nothing_changed:false,on_blur:"save",cancel:"",callback:null,success:null,error:null,error_sink:function(F,G){alert(G)},preinit:null,postclose:null};function D(F,G){this.settings=F;this.dom=G;this.originalHTML=null;this.originalText=null;this.didInsertDefaultText=false;this.shouldDelayReinit=false}E.extend(D.prototype,{init:function(){this.setDefaultTextIfNeccessary();this.connectEvents()},reinit:function(){if(this.shouldDelayReinit){return }if(this.settings.postclose){this.triggerCallback(this.settings.postclose,this.dom)}this.markEditorAsInactive();this.connectEvents()},setDefaultTextIfNeccessary:function(){if(""!==this.dom.html()){return }this.dom.html(this.settings.default_text);this.didInsertDefaultText=true},connectEvents:function(){var F=this;this.dom.bind("mouseenter.editInPlace",function(){F.addHoverEffect()}).bind("mouseleave.editInPlace",function(){F.removeHoverEffect()}).bind("click.editInPlace",function(G){voidEditor(G)})},addHoverEffect:function(){if(this.settings.hover_class){this.dom.addClass(this.settings.hover_class)}else{this.dom.css("background-color",this.settings.bg_over)}},removeHoverEffect:function(){if(this.settings.hover_class){this.dom.removeClass(this.settings.hover_class)}else{this.dom.css("background-color",this.settings.bg_out)}}voidEditor:function(F){if(!this.shouldOpenEditor(F.target)){return }this.dom.unbind(".editInPlace");this.removeHoverEffect();this.removeInsertedDefaultTextIfNeccessary();this.originalHTML=this.dom.html();var G=this.dom.text();if(G=="Click to add title"||G=="Click to add"){G=""}this.originalText=A(G);this.workaroundFirefoxBlurBug();this.markEditorAsActive();this.replaceContentWithEditor();this.connectEventsToEditor()},shouldOpenEditor:function(F){if(this.isClickedObjectCancelled(F)){return false}if(this.settings.preinit){return false!==this.triggerCallback(this.settings.preinit,this.dom)}return true},removeInsertedDefaultTextIfNeccessary:function(){if(!this.didInsertDefaultText||this.dom.html()!==this.settings.default_text){return }this.dom.html("");this.didInsertDefaultText=false},isClickedObjectCancelled:function(H){if(!this.settings.cancel){return false}var F=E(H).parents().andSelf();var G=F.filter(this.settings.cancel);return 0!==G.length},workaroundFirefoxBlurBug:function(){if(!E.browser.mozilla){return }this.dom.parents(":last").find(".editInPlace-active :input").blur()},replaceContentWithEditor:function(){var G=(this.settings.show_buttons)?this.settings.save_button+" "+this.settings.cancel_button:"";var F=this.createEditorElement();this.dom.html('<form class="inplace_form" style="display: inline; margin: 0; padding: 0;"></form>').find("form").append(F).append(G)},createEditorElement:function(){if(-1===E.inArray(this.settings.field_type,["text","textarea","select"])){throw"Unknown field_type <fnord>, supported are 'text', 'textarea' and 'select'"}if("select"===this.settings.field_type){return this.createSelectEditor()}var F=null;if("text"===this.settings.field_type){F=E('<input type="text"'+this.inputNameAndClass()+"/>")}else{if("textarea"===this.settings.field_type){F=E("<textarea"+this.inputNameAndClass()+'rows="'+this.settings.textarea_rows+'" cols="'+this.settings.textarea_cols+'"></textarea>')}}F.val(this.originalText);return F},inputNameAndClass:function(){return' name="inplace_value" class="inplace_field" '},createSelectEditor:function(){var K=E("<select"+this.inputNameAndClass()+'><option disabled="true" value="">'+this.settings.select_text+"</option></select>");var G=this.settings.select_options;if(!E.isArray(G)){G=G.split(",")}for(var H=0;H<G.length;H++){var F=G[H];if(!E.isArray(F)){F=F.split(":")}var L=A(F[1]||F[0]);var M=A(F[0]);var J=(L==this.originalText)?'selected="selected" ':"";var I=E("<option "+J+" ></option>").val(L).text(M);K.append(I)}return K},connectEventsToEditor:function(){var I=this;function H(){I.handleCancelEditor();return false}function F(){I.handleSaveEditor();return false}var G=this.dom.find("form");G.find(".inplace_field").focus().select();G.find(".inplace_cancel").click(H);G.find(".inplace_save").click(F);if(!this.settings.show_buttons){if("save"===this.settings.on_blur){G.find(".inplace_field").blur(F)}else{G.find(".inplace_field").blur(H)}if(E.browser.mozilla){G.keyup(function(J){if(13===J.which){F()}})}}G.keyup(function(J){if(27===J.which){return H()}else{if(13===J.which){return F()}}});G.submit(F)},handleCancelEditor:function(){this.dom.html(this.originalHTML);this.reinit()},handleSaveEditor:function(){var G=A(this.dom.find(":input").val());var F=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;G=G.replace(F,"");if(this.isDisabledDefaultSelectChoice()||this.isUnchangedInput(G)){this.handleCancelEditor();return }if(this.didForgetRequiredText(G)){this.handleCancelEditor();this.reportError("Error: You must enter a value to save this field");return }this.showSaving();if(this.settings.callback){this.handleSubmitToCallback(G)}else{this.handleSubmitToServer(G)}},didForgetRequiredText:function(F){return this.settings.value_required&&(""===F||undefined===F)},isDisabledDefaultSelectChoice:function(){return this.dom.find("option").eq(0).is(":selected:disabled")},isUnchangedInput:function(F){return !this.settings.save_if_nothing_changed&&this.originalText===F},showSaving:function(){var F=this.settings.saving_text;if(""!==this.settings.saving_image){F='<img src="'+this.settings.saving_image+'" alt="Saving..." />'}this.dom.html(F)},handleSubmitToCallback:function(F){this.enableOrDisableAnimationCallbacks(true,false);var G=this.triggerCallback(this.settings.callback,this.id(),F,this.originalHTML,this.settings.params,this.savingAnimationCallbacks());if(undefined===G){this.reportError("Error: Failed to save value: "+F);this.dom.html(this.originalHTML)}else{this.dom.html(G)}if(this.didCallNoCallbacks()){this.enableOrDisableAnimationCallbacks(false,false);this.reinit()}},handleSubmitToServer:function(F){var H=this.settings.update_value+"="+encodeURIComponent(F)+"&"+this.settings.element_id+"="+this.dom.attr("id")+((this.settings.params)?"&"+this.settings.params:"")+"&"+this.settings.original_html+"="+encodeURIComponent(this.originalHTML);this.enableOrDisableAnimationCallbacks(true,false);this.didStartSaving();var G=this;E.ajax({url:G.settings.url,type:"POST",data:H,dataType:"html",complete:function(I){G.didEndSaving()},success:function(J){var I=J||G.settings.default_text;G.dom.html(I);G.triggerCallback(G.settings.success,J)},error:function(I){G.dom.html(G.originalHTML);if(G.settings.error){G.triggerCallback(G.settings.error,I)}else{G.reportError("Failed to save value: "+I.responseText||"Unspecified Error")}}})},triggerCallback:function(G){if(!G){return }var F=Array.prototype.splice.call(arguments,1,arguments.length-1);return G.apply(this.dom[0],F)},reportError:function(F){this.triggerCallback(this.settings.error_sink,this.id(),F)},id:function(){return this.dom.attr("id")},markEditorAsActive:function(){this.dom.addClass("editInPlace-active")},markEditorAsInactive:function(){this.dom.removeClass("editInPlace-active")},savingAnimationCallbacks:function(){var F=this;return{didStartSaving:function(){F.didStartSaving()},didEndSaving:function(){F.didEndSaving()}}},enableOrDisableAnimationCallbacks:function(G,F){this.didStartSaving.enabled=G;this.didEndSaving.enabled=F},didCallNoCallbacks:function(){return this.didStartSaving.enabled&&!this.didEndSaving.enabled},assertCanCall:function(F){if(!this[F].enabled){throw new Error("Cannot call "+F+" now. See documentation for details.")}},didStartSaving:function(){this.assertCanCall("didStartSaving");this.shouldDelayReinit=true;this.enableOrDisableAnimationCallbacks(false,true);this.startSavingAnimation()},didEndSaving:function(){this.assertCanCall("didEndSaving");this.shouldDelayReinit=false;this.enableOrDisableAnimationCallbacks(false,false);this.reinit();this.stopSavingAnimation()},startSavingAnimation:function(){var F=this;this.dom.animate({backgroundColor:this.settings.saving_animation_color},400).animate({backgroundColor:"transparent"},400,"swing",function(){setTimeout(function(){F.startSavingAnimation()},10)})},stopSavingAnimation:function(){this.dom.stop(true).css({backgroundColor:""})},missingCommaErrorPreventer:""});function B(F){if(F.url||F.callback){return }throw new Error("Need to set either url: or callback: option for the inline editor to work.")}function C(G){if(""===G){return }var F=new Image();F.src=G}function A(F){return F.replace(/^\s+/,"").replace(/\s+$/,"")}})(jQuery);var InlineEditorController;(function(){var A={id:null,editors:new Hash(),initialize:function(){},onFullviewDynamicPagination:function(){this.editors.keys().each(function(C){this.destroyEditor(C)}.bind(this))},destroyEditor:function(C){jq("#"+C).unbind(".editInPlace");this.editors.unset(C)},addEditor:function(D,C,F,J,I,K){var H={save_button:InlineEditorController.SaveButton,cancel_button:InlineEditorController.CancelButton,show_buttons:true,bg_over:"transparent",callback:this.onEdit.curry({url:C,params:F,defaultText:J,hideLabel:K,id:this.id}),postclose:this.onClose.curry(J)};if(I=="textarea"){H.field_type=I;H.textarea_cols=60;H.textarea_rows=4;H.save_button="<br/>"+InlineEditorController.SaveButton}var G=jq("#"+D).editInPlace(H);this.editors.set(D,G);this.type=I;if(this.id=="filename"){var E=$("edit"+D);Event.observe(E,"click",this.hideExtension.bindAsEventListener(this))}},hideExtension:function(E){var D=Event.element(E);var C=D.up().down(".noneditableText");if(C){C.hide()}},onEdit:function(H,G,F,E,D){document.fire("editor:changed");var J=jq("#label"+G);var K=jq("#edit"+G);if(F==""){if(H.hideLabel){J.show()}K.hide()}else{if(H.hideLabel){J.hide()}K.show()}if(H.id=="filename"){var I=confirm("WARNING: Renaming files will cause your direct links, slideshows, or scrapbooks to break.\n\nAre you sure you want to do this?");if(!I){return E}else{var C=jq("#formFullView");C.find("#action").val("rename");C.append('<input type="hidden" name="new_filename" value="'+F+'"/>');C.submit()}}else{jq.post(H.url,H.params+encodeURIComponent(F),function(L){if(L.response.stat!="ok"){jq("#"+G).html(E)}},"json")}return(F.length==0)?H.defaultText:F},onClose:function(C){var F=$(this);var E=this.innerHTML;if(E==C||jq.trim(E)==""){F.addClassName("linkClr");F.removeClassName("userValue")}else{F.removeClassName("linkClr");F.addClassName("userValue");var G=F.up(".editable").down(".triggerEdit");G.show()}var D=this.up().down(".noneditableText");if(D){D.show()}}};var B={SaveButton:'<button type="button" class="inplace_save button xsmall blue tight">Ok</button>',CancelButton:'<button type="button" class="inplace_cancel button xsmall tight">Cancel</button>'};Controller.create("InlineEditorController",A,B)})();if(typeof Effect=="undefined"){throw ("controls.js requires including script.aculo.us' effects.js library")}var Autocompleter={};Autocompleter.Base=Class.create({baseInitialize:function(B,C,A){B=$(B);this.element=B;this.update=$(C);this.hasFocus=false;this.changed=false;this.active=false;this.index=0;this.entryCount=0;this.oldElementValue=this.element.value;if(this.setOptions){this.setOptions(A)}else{this.options=A||{}}if(!this.options.forceSuggestions&&this.options.forceSuggestions!==false){this.options.forceSuggestions=true}this.options.paramName=this.options.paramName||this.element.name;this.options.tokens=this.options.tokens||[];this.options.frequency=this.options.frequency||0.4;this.options.minChars=this.options.minChars||1;this.options.onShow=this.options.onShow||function(D,E){if(!E.style.position||E.style.position=="absolute"){E.style.position="absolute";Position.clone(D,E,{setHeight:false,offsetTop:D.offsetHeight})}Effect.Appear(E,{duration:0.15})};this.options.onHide=this.options.onHide||function(D,E){new Effect.Fade(E,{duration:0.15})};if(typeof (this.options.tokens)=="string"){this.options.tokens=new Array(this.options.tokens)}if(!this.options.tokens.include("\n")){this.options.tokens.push("\n")}this.observer=null;this.element.setAttribute("autocomplete","off");Element.hide(this.update);Event.observe(this.element,"blur",this.onBlur.bindAsEventListener(this));Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},show:function(){if(Element.getStyle(this.update,"display")=="none"){this.options.onShow(this.element,this.update)}if(!this.iefix&&(Prototype.Browser.IE)&&(Element.getStyle(this.update,"position")=="absolute")){new Insertion.After(this.update,'<iframe id="'+this.update.id+'_iefix" style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" src="javascript:false;" frameborder="0" scrolling="no"></iframe>');this.iefix=$(this.update.id+"_iefix")}if(this.iefix){setTimeout(this.fixIEOverlapping.bind(this),50)}},fixIEOverlapping:function(){Position.clone(this.update,this.iefix,{setTop:(!this.update.style.height)});this.iefix.style.zIndex=1;this.update.style.zIndex=2;Element.show(this.iefix)},hide:function(){this.stopIndicator();if(Element.getStyle(this.update,"display")!="none"){this.options.onHide(this.element,this.update)}if(this.iefix){Element.hide(this.iefix)}},startIndicator:function(){if(this.options.indicator){Element.show(this.options.indicator)}},stopIndicator:function(){if(this.options.indicator){Element.hide(this.options.indicator)}},onKeyPress:function(A){if(this.active){switch(A.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry();Event.stop(A);case Event.KEY_ESC:this.hide();this.active=false;Event.stop(A);return ;case Event.KEY_LEFT:case Event.KEY_RIGHT:return ;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(A);return ;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(A);return }}else{if(A.keyCode==Event.KEY_TAB||A.keyCode==Event.KEY_RETURN||(Prototype.Browser.WebKit>0&&A.keyCode==0)){return }}this.changed=true;this.hasFocus=true;if(this.observer){clearTimeout(this.observer)}this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},activate:function(){this.changed=false;this.hasFocus=true;this.getUpdatedChoices()},onHover:function(B){var A=Event.findElement(B,"LI");if(this.index!=A.autocompleteIndex){this.index=A.autocompleteIndex;this.render()}Event.stop(B)},onClick:function(B){var A=Event.findElement(B,"LI");this.index=A.autocompleteIndex;this.selectEntry();this.hide()},onBlur:function(A){setTimeout(this.hide.bind(this),250);this.hasFocus=false;this.active=false},render:function(){if(this.entryCount>0){for(var A=0;A<this.entryCount;A++){this.index==A?Element.addClassName(this.getEntry(A),"selected"):Element.removeClassName(this.getEntry(A),"selected")}if(this.hasFocus){this.show();this.active=true}}else{this.active=false;this.hide()}},markPrevious:function(){if(this.index>0){this.index--}else{this.index=this.entryCount-1}this.getEntry(this.index).scrollIntoView(true)},markNext:function(){if(this.index<this.entryCount-1){this.index++}else{this.index=0}this.getEntry(this.index).scrollIntoView(false)},getEntry:function(A){return this.update.firstChild.childNodes[A]},getCurrentEntry:function(){return this.getEntry(this.index)},selectEntry:function(){this.active=false;this.updateElement(this.getCurrentEntry())},updateElement:function(F){if(this.options.updateElement){this.options.updateElement(F);return }var D="";if(this.options.select){var A=$(F).select("."+this.options.select)||[];if(A.length>0){D=Element.collectTextNodes(A[0],this.options.select)}}else{D=Element.collectTextNodesIgnoreClass(F,"informal")}var C=this.getTokenBounds();if(C[0]!=-1){var E=this.element.value.substr(0,C[0]);var B=this.element.value.substr(C[0]).match(/^\s+/);if(B){E+=B[0]}this.element.value=E+D+this.element.value.substr(C[1])}else{this.element.value=D}this.oldElementValue=this.element.value;this.element.focus();if(this.options.afterUpdateElement){this.options.afterUpdateElement(this.element,F)}},updateChoices:function(C){if(!this.changed&&this.hasFocus){this.update.innerHTML=C;Element.cleanWhitespace(this.update);Element.cleanWhitespace(this.update.down());if(this.update.firstChild&&this.update.down().childNodes){this.entryCount=this.update.down().childNodes.length;for(var A=0;A<this.entryCount;A++){var B=this.getEntry(A);B.autocompleteIndex=A;this.addObservers(B)}}else{this.entryCount=0}this.stopIndicator();this.index=(this.options.forceSuggestions)?0:-1;if(this.entryCount==1&&this.options.autoSelect){this.selectEntry();this.hide()}else{this.render()}}},addObservers:function(A){Event.observe(A,"mouseover",this.onHover.bindAsEventListener(this));Event.observe(A,"click",this.onClick.bindAsEventListener(this))},onObserverEvent:function(){this.changed=false;this.tokenBounds=null;if(this.getToken().length>=this.options.minChars){this.getUpdatedChoices()}else{this.active=false;this.hide()}this.oldElementValue=this.element.value},getToken:function(){var A=this.getTokenBounds();return this.element.value.substring(A[0],A[1]).strip()},getTokenBounds:function(){if(null!=this.tokenBounds){return this.tokenBounds}var E=this.element.value;if(E.strip().empty()){return[-1,0]}var F=arguments.callee.getFirstDifferencePos(E,this.oldElementValue);var H=(F==this.oldElementValue.length?1:0);var D=-1,C=E.length;var G;for(var B=0,A=this.options.tokens.length;B<A;++B){G=E.lastIndexOf(this.options.tokens[B],F+H-1);if(G>D){D=G}G=E.indexOf(this.options.tokens[B],F+H);if(-1!=G&&G<C){C=G}}return(this.tokenBounds=[D+1,C])}});Autocompleter.Base.prototype.getTokenBounds.getFirstDifferencePos=function(C,A){var D=Math.min(C.length,A.length);for(var B=0;B<D;++B){if(C[B]!=A[B]){return B}}return D};Ajax.Autocompleter=Class.create(Autocompleter.Base,{initialize:function(C,D,B,A){this.baseInitialize(C,D,A);this.options.asynchronous=true;this.options.onComplete=this.onComplete.bind(this);this.options.defaultParams=this.options.parameters||null;this.url=B},getUpdatedChoices:function(){this.startIndicator();var A=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,A):A;if(this.options.defaultParams){this.options.parameters+="&"+this.options.defaultParams}new Ajax.Request(this.url,this.options)},onComplete:function(A){this.updateChoices(A.responseText)}});Autocompleter.Local=Class.create(Autocompleter.Base,{initialize:function(B,D,C,A){this.baseInitialize(B,D,A);this.options.array=C},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this))},setOptions:function(A){this.options=Object.extend({choices:10,partialSearch:true,partialChars:2,ignoreCase:true,fullSearch:false,selector:function(B){var D=[];var C=[];var H=B.getToken();var G=0;for(var E=0;E<B.options.array.length&&D.length<B.options.choices;E++){var F=B.options.array[E];var I=B.options.ignoreCase?F.toLowerCase().indexOf(H.toLowerCase()):F.indexOf(H);while(I!=-1){if(I==0&&F.length!=H.length){D.push("<li><strong>"+F.substr(0,H.length)+"</strong>"+F.substr(H.length)+"</li>");break}else{if(H.length>=B.options.partialChars&&B.options.partialSearch&&I!=-1){if(B.options.fullSearch||/\s/.test(F.substr(I-1,1))){C.push("<li>"+F.substr(0,I)+"<strong>"+F.substr(I,H.length)+"</strong>"+F.substr(I+H.length)+"</li>");break}}}I=B.options.ignoreCase?F.toLowerCase().indexOf(H.toLowerCase(),I+1):F.indexOf(H,I+1)}}if(C.length){D=D.concat(C.slice(0,B.options.choices-D.length))}return"<ul>"+D.join("")+"</ul>"}},A||{})}});Field.scrollFreeActivate=function(A){setTimeout(function(){Field.activate(A)},1)};Ajax.InPlaceEditor=Class.create({initialize:function(C,B,A){this.url=B;this.element=C=$(C);this.prepareOptions();this._controls={};arguments.callee.dealWithDeprecatedOptions(A);Object.extend(this.options,A||{});if(!this.options.formId&&this.element.id){this.options.formId=this.element.id+"-inplaceeditor";if($(this.options.formId)){this.options.formId=""}}if(this.options.externalControl){this.options.externalControl=$(this.options.externalControl)}if(!this.options.externalControl){this.options.externalControlOnly=false}this._originalBackground=this.element.getStyle("background-color")||"transparent";this.element.title=this.options.clickToEditText;this._boundCancelHandler=this.handleFormCancellation.bind(this);this._boundComplete=(this.options.onComplete||Prototype.emptyFunction).bind(this);this._boundFailureHandler=this.handleAJAXFailure.bind(this);this._boundSubmitHandler=this.handleFormSubmission.bind(this);this._boundWrapperHandler=this.wrapUp.bind(this);this.registerListeners()},checkForEscapeOrReturn:function(A){if(!this._editing||A.ctrlKey||A.altKey||A.shiftKey){return }if(Event.KEY_ESC==A.keyCode){this.handleFormCancellation(A)}else{if(Event.KEY_RETURN==A.keyCode){this.handleFormSubmission(A)}}},createControl:function(G,C,B){var E=this.options[G+"Control"];var F=this.options[G+"Text"];if("button"==E){var A=document.createElement("input");A.type="submit";A.value=F;A.className="editor_"+G+"_button";if("cancel"==G){A.onclick=this._boundCancelHandler}this._form.appendChild(A);this._controls[G]=A}else{if("link"==E){var D=document.createElement("a");D.href="#";D.appendChild(document.createTextNode(F));D.onclick="cancel"==G?this._boundCancelHandler:this._boundSubmitHandler;D.className="editor_"+G+"_link";if(B){D.className+=" "+B}this._form.appendChild(D);this._controls[G]=D}}},createEditField:function(){var C=(this.options.loaddisabledTextURL?this.options.loaddisabledingText:this.getText());var B;if(1>=this.options.rows&&!/\r|\n/.test(this.getText())){B=document.createElement("input");B.type="text";var A=this.options.size||this.options.cols||0;if(0<A){B.size=A}}else{B=document.createElement("textarea");B.rows=(1>=this.options.rows?this.options.autoRows:this.options.rows);B.cols=this.options.cols||40}B.name=this.options.paramName;B.value=C;B.className="editor_field";if(this.options.submitOnBlur){B.onblur=this._boundSubmitHandler}this._controls.editor=B;if(this.options.loaddisabledTextURL){this.loaddisabledExternalText()}this._form.appendChild(this._controls.editor)},createForm:function(){var B=this;function A(D,E){var C=B.options["text"+D+"Controls"];if(!C||E===false){return }B._form.appendChild(document.createTextNode(C))}this._form=$(document.createElement("form"));this._form.id=this.options.formId;this._form.addClassName(this.options.formClassName);this._form.onsubmit=this._boundSubmitHandler;this.createEditField();if("textarea"==this._controls.editor.tagName.toLowerCase()){this._form.appendChild(document.createElement("br"))}if(this.options.onFormCustomization){this.options.onFormCustomization(this,this._form)}A("Before",this.options.okControl||this.options.cancelControl);this.createControl("ok",this._boundSubmitHandler);A("Between",this.options.okControl&&this.options.cancelControl);this.createControl("cancel",this._boundCancelHandler,"editor_cancel");A("After",this.options.okControl||this.options.cancelControl)},destroy:function(){if(this._oldInnerHTML){this.element.innerHTML=this._oldInnerHTML}this.leaveEditMode();this.unregisterListeners()},enterEditMode:function(A){if(this._saving||this._editing){return }this._editing=true;this.triggerCallback("onEnterEditMode");if(this.options.externalControl){this.options.externalControl.hide()}this.element.hide();this.createForm();this.element.parentNode.insertBefore(this._form,this.element);if(!this.options.loaddisabledTextURL){this.postProcessEditField()}if(A){Event.stop(A)}},enterHover:function(A){if(this.options.hoverClassName){this.element.addClassName(this.options.hoverClassName)}if(this._saving){return }this.triggerCallback("onEnterHover")},getText:function(){return this.element.innerHTML},handleAJAXFailure:function(A){this.triggerCallback("onFailure",A);if(this._oldInnerHTML){this.element.innerHTML=this._oldInnerHTML;this._oldInnerHTML=null}},handleFormCancellation:function(A){this.wrapUp();if(A){Event.stop(A)}},handleFormSubmission:function(D){var B=this._form;var C=$F(this._controls.editor);this.prepareSubmission();var E=this.options.callback(B,C)||"";if(Object.isString(E)){E=E.toQueryParams()}E.editorId=this.element.id;if(this.options.htmlResponse){var A=Object.extend({evalScripts:true},this.options.ajaxOptions);Object.extend(A,{parameters:E,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler});new Ajax.Updater({success:this.element},this.url,A)}else{var A=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(A,{parameters:E,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler});new Ajax.Request(this.url,A)}if(D){Event.stop(D)}},leaveEditMode:function(){this.element.removeClassName(this.options.savingClassName);this.removeForm();this.leaveHover();this.element.style.backgroundColor=this._originalBackground;this.element.show();if(this.options.externalControl){this.options.externalControl.show()}this._saving=false;this._editing=false;this._oldInnerHTML=null;this.triggerCallback("onLeaveEditMode")},leaveHover:function(A){if(this.options.hoverClassName){this.element.removeClassName(this.options.hoverClassName)}if(this._saving){return }this.triggerCallback("onLeaveHover")},loaddisabledExternalText:function(){this._form.addClassName(this.options.loaddisabledingClassName);this._controls.editor.disabled=true;var A=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(A,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(C){this._form.removeClassName(this.options.loaddisabledingClassName);var B=C.responseText;if(this.options.stripLoadedTextTags){B=B.stripTags()}this._controls.editor.value=B;this._controls.editor.disabled=false;this.postProcessEditField()}.bind(this),onFailure:this._boundFailureHandler});new Ajax.Request(this.options.loaddisabledTextURL,A)},postProcessEditField:function(){var A=this.options.fieldPostCreation;if(A){$(this._controls.editor)["focus"==A?"focus":"activate"]()}},prepareOptions:function(){this.options=Object.clone(Ajax.InPlaceEditor.DefaultOptions);Object.extend(this.options,Ajax.InPlaceEditor.DefaultCallbacks);[this._extraDefaultOptions].flatten().compact().each(function(A){Object.extend(this.options,A)}.bind(this))},prepareSubmission:function(){this._saving=true;this.removeForm();this.leaveHover();this.showSaving()},registerListeners:function(){this._listeners={};var A;$H(Ajax.InPlaceEditor.Listeners).each(function(B){A=this[B.value].bind(this);this._listeners[B.key]=A;if(!this.options.externalControlOnly){this.element.observe(B.key,A)}if(this.options.externalControl){this.options.externalControl.observe(B.key,A)}}.bind(this))},removeForm:function(){if(!this._form){return }this._form.remove();this._form=null;this._controls={}},showSaving:function(){this._oldInnerHTML=this.element.innerHTML;this.element.innerHTML=this.options.savingText;this.element.addClassName(this.options.savingClassName);this.element.style.backgroundColor=this._originalBackground;this.element.show()},triggerCallback:function(B,A){if("function"==typeof this.options[B]){this.options[B](this,A)}},unregisterListeners:function(){$H(this._listeners).each(function(A){if(!this.options.externalControlOnly){this.element.stopObserving(A.key,A.value)}if(this.options.externalControl){this.options.externalControl.stopObserving(A.key,A.value)}}.bind(this))},wrapUp:function(A){this.leaveEditMode();this._boundComplete(A,this.element)}});Object.extend(Ajax.InPlaceEditor.prototype,{dispose:Ajax.InPlaceEditor.prototype.destroy});Ajax.InPlaceCollectionEditor=Class.create(Ajax.InPlaceEditor,{initialize:function($super,C,B,A){this._extraDefaultOptions=Ajax.InPlaceCollectionEditor.DefaultOptions;$super(C,B,A)},createEditField:function(){var A=document.createElement("select");A.name=this.options.paramName;A.size=1;this._controls.editor=A;this._collection=this.options.collection||[];if(this.options.loaddisabledCollectionURL){this.loaddisabledCollection()}else{this.checkForExternalText()}this._form.appendChild(this._controls.editor)},loaddisabledCollection:function(){this._form.addClassName(this.options.loaddisabledingClassName);this.showLoadingText(this.options.loaddisabledingCollectionText);var options=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(options,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){var js=transport.responseText.strip();if(!/^\[.*\]$/.test(js)){throw"Server returned an invalid collection representation."}this._collection=eval(js);this.checkForExternalText()}.bind(this),onFailure:this.onFailure});new Ajax.Request(this.options.loaddisabledCollectionURL,options)},showLoadingText:function(B){this._controls.editor.disabled=true;var A=this._controls.editor.firstChild;if(!A){A=document.createElement("option");A.value="";this._controls.editor.appendChild(A);A.selected=true}A.update((B||"").stripScripts().stripTags())},checkForExternalText:function(){this._text=this.getText();if(this.options.loaddisabledTextURL){this.loaddisabledExternalText()}else{this.buildOptionList()}},loaddisabledExternalText:function(){this.showLoadingText(this.options.loaddisabledingText);var A=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(A,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(B){this._text=B.responseText.strip();this.buildOptionList()}.bind(this),onFailure:this.onFailure});new Ajax.Request(this.options.loaddisabledTextURL,A)},buildOptionList:function(){this._form.removeClassName(this.options.loaddisabledingClassName);this._collection=this._collection.map(function(D){return 2===D.length?D:[D,D].flatten()});var B=("value" in this.options)?this.options.value:this._text;var A=this._collection.any(function(D){return D[0]==B}.bind(this));this._controls.editor.update("");var C;this._collection.each(function(E,D){C=document.createElement("option");C.value=E[0];C.selected=A?E[0]==B:0==D;C.appendChild(document.createTextNode(E[1]));this._controls.editor.appendChild(C)}.bind(this));this._controls.editor.disabled=false;Field.scrollFreeActivate(this._controls.editor)}});Ajax.InPlaceEditor.prototype.initialize.dealWithDeprecatedOptions=function(A){if(!A){return }function B(C,D){if(C in A||D===undefined){return }A[C]=D}B("cancelControl",(A.cancelLink?"link":(A.cancelButton?"button":A.cancelLink==A.cancelButton==false?false:undefined)));B("okControl",(A.okLink?"link":(A.okButton?"button":A.okLink==A.okButton==false?false:undefined)));B("highlightColor",A.highlightcolor);B("highlightEndColor",A.highlightendcolor)};Object.extend(Ajax.InPlaceEditor,{DefaultOptions:{ajaxOptions:{},autoRows:3,cancelControl:"link",cancelText:"cancel",clickToEditText:"Click to edit",externalControl:null,externalControlOnly:false,fieldPostCreation:"activate",formClassName:"inplaceeditor-form",formId:null,highlightColor:"#ffff99",highlightEndColor:"#ffffff",hoverClassName:"",htmlResponse:true,loaddisabledingClassName:"inplaceeditor-loaddisableding",loaddisabledingText:"Loading...",okControl:"button",okText:"ok",paramName:"value",rows:1,savingClassName:"inplaceeditor-saving",savingText:"Saving...",size:0,stripLoadedTextTags:false,submitOnBlur:false,textAfterControls:"",textBeforeControls:"",textBetweenControls:""},DefaultCallbacks:{callback:function(A){return Form.serialize(A)},onComplete:function(B,A){new Effect.Highlight(A,{startcolor:this.options.highlightColor,keepBackgroundImage:true})},onEnterEditMode:null,onEnterHover:function(A){A.element.style.backgroundColor=A.options.highlightColor;if(A._effect){A._effect.cancel()}},onFailure:function(B,A){alert("Error communication with the server: "+B.responseText.stripTags())},onFormCustomization:null,onLeaveEditMode:null,onLeaveHover:function(A){A._effect=new Effect.Highlight(A.element,{startcolor:A.options.highlightColor,endcolor:A.options.highlightEndColor,restorecolor:A._originalBackground,keepBackgroundImage:true})}},Listeners:{click:"enterEditMode",keydown:"checkForEscapeOrReturn",mouseover:"enterHover",mouseout:"leaveHover"}});Ajax.InPlaceCollectionEditor.DefaultOptions={loaddisabledingCollectionText:"Loading options..."};Form.Element.DelayedObserver=Class.create({initialize:function(B,A,C){this.delay=A||0.5;this.element=$(B);this.callback=C;this.timer=null;this.lastValue=$F(this.element);Event.observe(this.element,"keyup",this.delayedListener.bindAsEventListener(this))},delayedListener:function(A){if(this.lastValue==$F(this.element)){return }if(this.timer){clearTimeout(this.timer)}this.timer=setTimeout(this.onTimerEvent.bind(this),this.delay*1000);this.lastValue=$F(this.element)},onTimerEvent:function(){this.timer=null;this.callback(this.element,$F(this.element))}});if(Object.isUndefined(Effect)){throw ("dragdrop.js requires including script.aculo.us' effects.js library")}var Droppables={drops:[],remove:function(A){this.drops=this.drops.reject(function(B){return B.element==$(A)})},add:function(B){B=$(B);var A=Object.extend({greedy:true,hoverclass:null,tree:false},arguments[1]||{});if(A.containment){A._containers=[];var C=A.containment;if(Object.isArray(C)){C.each(function(D){A._containers.push($(D))})}else{A._containers.push($(C))}}if(A.accept){A.accept=[A.accept].flatten()}Element.makePositioned(B);A.element=B;this.drops.push(A)},findDeepestChild:function(A){deepest=A[0];for(i=1;i<A.length;++i){if(Element.isParent(A[i].element,deepest.element)){deepest=A[i]}}return deepest},isContained:function(B,A){var C;if(A.tree){C=B.treeNode}else{C=B.parentNode}return A._containers.detect(function(D){return C==D})},isAffected:function(A,C,B){return((B.element!=C)&&((!B._containers)||this.isContained(C,B))&&((!B.accept)||(Element.classNames(C).detect(function(D){return B.accept.include(D)})))&&Position.within(B.element,A[0],A[1]))},deactivate:function(A){if(A.hoverclass){Element.removeClassName(A.element,A.hoverclass)}this.last_active=null},activate:function(A){if(A.hoverclass){Element.addClassName(A.element,A.hoverclass)}this.last_active=A},show:function(A,C){if(!this.drops.length){return }var B,D=[];this.drops.each(function(E){if(Droppables.isAffected(A,C,E)){D.push(E)}});if(D.length>0){B=Droppables.findDeepestChild(D)}if(this.last_active&&this.last_active!=B){this.deactivate(this.last_active)}if(B){Position.within(B.element,A[0],A[1]);if(B.onHover){B.onHover(C,B.element,Position.overlap(B.overlap,B.element))}if(B!=this.last_active){Droppables.activate(B)}}},fire:function(B,A){if(!this.last_active){return }Position.prepare();if(this.isAffected([Event.pointerX(B),Event.pointerY(B)],A,this.last_active)){if(this.last_active.onDrop){this.last_active.onDrop(A,this.last_active.element,B);return true}}},reset:function(){if(this.last_active){this.deactivate(this.last_active)}}};var Draggables={drags:[],observers:[],register:function(A){if(this.drags.length==0){this.eventMouseUp=this.endDrag.bindAsEventListener(this);this.eventMouseMove=this.updateDrag.bindAsEventListener(this);this.eventKeypress=this.keyPress.bindAsEventListener(this);Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress)}this.drags.push(A)},unregister:function(A){this.drags=this.drags.reject(function(B){return B==A});if(this.drags.length==0){Event.stopObserving(document,"mouseup",this.eventMouseUp);Event.stopObserving(document,"mousemove",this.eventMouseMove);Event.stopObserving(document,"keypress",this.eventKeypress)}},activate:function(A){if(A.options.delay){this._timeout=setTimeout(function(){Draggables._timeout=null;window.focus();Draggables.activeDraggable=A}.bind(this),A.options.delay)}else{window.focus();this.activeDraggable=A}},deactivate:function(){this.activeDraggable=null},updateDrag:function(A){if(!this.activeDraggable){return }var B=[Event.pointerX(A),Event.pointerY(A)];if(this._lastPointer&&(this._lastPointer.inspect()==B.inspect())){return }this._lastPointer=B;this.activeDraggable.updateDrag(A,B)},endDrag:function(A){if(this._timeout){clearTimeout(this._timeout);this._timeout=null}if(!this.activeDraggable){return }this._lastPointer=null;this.activeDraggable.endDrag(A);this.activeDraggable=null},keyPress:function(A){if(this.activeDraggable){this.activeDraggable.keyPress(A)}},addObserver:function(A){this.observers.push(A);this._cacheObserverCallbacks()},removeObserver:function(A){this.observers=this.observers.reject(function(B){return B.element==A});this._cacheObserverCallbacks()},notify:function(B,A,C){if(this[B+"Count"]>0){this.observers.each(function(D){if(D[B]){D[B](B,A,C)}})}if(A.options[B]){A.options[B](A,C)}},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(A){Draggables[A+"Count"]=Draggables.observers.select(function(B){return B[A]}).length})}};var Draggable=Class.create({initialize:function(B){var C={handle:false,reverteffect:function(F,E,D){var G=Math.sqrt(Math.abs(E^2)+Math.abs(D^2))*0.02;new Effect.Move(F,{x:-D,y:-E,duration:G,queue:{scope:"_draggable",position:"end"}})},endeffect:function(E){var D=Object.isNumber(E._opacity)?E._opacity:1;new Effect.Opacity(E,{duration:0.2,from:0.7,to:D,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[E]=false}})},zindex:1000,revert:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,snap:false,delay:0};if(!arguments[1]||Object.isUndefined(arguments[1].endeffect)){Object.extend(C,{starteffect:function(D){D._opacity=Element.getOpacity(D);Draggable._dragging[D]=true;new Effect.Opacity(D,{duration:0.2,from:D._opacity,to:0.7})}})}var A=Object.extend(C,arguments[1]||{});this.element=$(B);if(A.handle&&Object.isString(A.handle)){this.handle=this.element.down("."+A.handle,0)}if(!this.handle){this.handle=$(A.handle)}if(!this.handle){this.handle=this.element}if(A.scroll&&!A.scroll.scrollTo&&!A.scroll.outerHTML){A.scroll=$(A.scroll);this._isScrollChild=Element.childOf(this.element,A.scroll)}Element.makePositioned(this.element);this.options=A;this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);Draggables.unregister(this)},currentDelta:function(){return([parseInt(Element.getStyle(this.element,"left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")])},initDrag:function(A){if(!Object.isUndefined(Draggable._dragging[this.element])&&Draggable._dragging[this.element]){return }if(Event.isLeftClick(A)){var C=Event.element(A);if((tag_name=C.tagName.toUpperCase())&&(tag_name=="INPUT"||tag_name=="SELECT"||tag_name=="OPTION"||tag_name=="BUTTON"||tag_name=="TEXTAREA")){return }var B=[Event.pointerX(A),Event.pointerY(A)];var D=Position.cumulativeOffset(this.element);this.offset=[0,1].map(function(E){return(B[E]-D[E])});Draggables.activate(this);Event.stop(A)}},startDrag:function(B){this.dragging=true;if(!this.delta){this.delta=this.currentDelta()}if(this.options.zindex){this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0);this.element.style.zIndex=this.options.zindex}if(this.options.ghosting){this._clone=this.element.cloneNode(true);this.element._originallyAbsolute=(this.element.getStyle("position")=="absolute");if(!this.element._originallyAbsolute){Position.absolutize(this.element)}this.element.parentNode.insertBefore(this._clone,this.element)}if(this.options.scroll){if(this.options.scroll==window){var A=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=A.left;this.originalScrollTop=A.top}else{this.originalScrollLeft=this.options.scroll.scrollLeft;this.originalScrollTop=this.options.scroll.scrollTop}}Draggables.notify("onStart",this,B);if(this.options.starteffect){this.options.starteffect(this.element)}},updateDrag:function(event,pointer){if(!this.dragging){this.startDrag(event)}if(!this.options.quiet){Position.prepare();Droppables.show(pointer,this.element)}Draggables.notify("onDrag",this,event);this.draw(pointer);if(this.options.change){this.options.change(this)}if(this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){p=[left,top,left+width,top+height]}}else{p=Position.page(this.options.scroll);p[0]+=this.options.scroll.scrollLeft+Position.deltaX;p[1]+=this.options.scroll.scrollTop+Position.deltaY;p.push(p[0]+this.options.scroll.offsetWidth);p.push(p[1]+this.options.scroll.offsetHeight)}var speed=[0,0];if(pointer[0]<(p[0]+this.options.scrollSensitivity)){speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)}if(pointer[1]<(p[1]+this.options.scrollSensitivity)){speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)}if(pointer[0]>(p[2]-this.options.scrollSensitivity)){speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)}if(pointer[1]>(p[3]-this.options.scrollSensitivity)){speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)}this.startScrolling(speed)}if(Prototype.Browser.WebKit){window.scrollBy(0,0)}Event.stop(event)},finishDrag:function(B,E){this.dragging=false;if(this.options.quiet){Position.prepare();var D=[Event.pointerX(B),Event.pointerY(B)];Droppables.show(D,this.element)}if(this.options.ghosting){if(!this.element._originallyAbsolute){Position.relativize(this.element)}delete this.element._originallyAbsolute;Element.remove(this._clone);this._clone=null}var F=false;if(E){F=Droppables.fire(B,this.element);if(!F){F=false}}if(F&&this.options.onDropped){this.options.onDropped(this.element)}Draggables.notify("onEnd",this,B);var A=this.options.revert;if(A&&Object.isFunction(A)){A=A(this.element)}var C=this.currentDelta();if(A&&this.options.reverteffect){if(F==0||A!="failure"){this.options.reverteffect(this.element,C[1]-this.delta[1],C[0]-this.delta[0])}}else{this.delta=C}if(this.options.zindex){this.element.style.zIndex=this.originalZ}if(this.options.endeffect){this.options.endeffect(this.element)}Draggables.deactivate(this);Droppables.reset()},keyPress:function(A){if(A.keyCode!=Event.KEY_ESC){return }this.finishDrag(A,false);Event.stop(A)},endDrag:function(A){if(!this.dragging){return }this.stopScrolling();this.finishDrag(A,true);Event.stop(A)},draw:function(A){var F=Position.cumulativeOffset(this.element);if(this.options.ghosting){var C=Position.realOffset(this.element);F[0]+=C[0]-Position.deltaX;F[1]+=C[1]-Position.deltaY}var E=this.currentDelta();F[0]-=E[0];F[1]-=E[1];if(this.options.scroll&&(this.options.scroll!=window&&this._isScrollChild)){F[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft;F[1]-=this.options.scroll.scrollTop-this.originalScrollTop}var D=[0,1].map(function(G){return(A[G]-F[G]-this.offset[G])}.bind(this));if(this.options.snap){if(Object.isFunction(this.options.snap)){D=this.options.snap(D[0],D[1],this)}else{if(Object.isArray(this.options.snap)){D=D.map(function(G,H){return(G/this.options.snap[H]).round()*this.options.snap[H]}.bind(this))}else{D=D.map(function(G){return(G/this.options.snap).round()*this.options.snap}.bind(this))}}}var B=this.element.style;if((!this.options.constraint)||(this.options.constraint=="horizontal")){B.left=D[0]+"px"}if((!this.options.constraint)||(this.options.constraint=="vertical")){B.top=D[1]+"px"}if(B.visibility=="hidden"){B.visibility=""}},stopScrolling:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=null;Draggables._lastScrollPointer=null}},startScrolling:function(A){if(!(A[0]||A[1])){return }this.scrollSpeed=[A[0]*this.options.scrollSpeed,A[1]*this.options.scrollSpeed];this.lastScrolled=new Date();this.scrollInterval=setInterval(this.scroll.bind(this),10)},scroll:function(){var current=new Date();var delta=current-this.lastScrolled;this.lastScrolled=current;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){if(this.scrollSpeed[0]||this.scrollSpeed[1]){var d=delta/1000;this.options.scroll.scrollTo(left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1])}}}else{this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1000;this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1000}Position.prepare();Droppables.show(Draggables._lastPointer,this.element);Draggables.notify("onDrag",this);if(this._isScrollChild){Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer);Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1000;Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1000;if(Draggables._lastScrollPointer[0]<0){Draggables._lastScrollPointer[0]=0}if(Draggables._lastScrollPointer[1]<0){Draggables._lastScrollPointer[1]=0}this.draw(Draggables._lastScrollPointer)}if(this.options.change){this.options.change(this)}},_getWindowScroll:function(w){var T,L,W,H;with(w.document){if(w.document.documentElement&&documentElement.scrollTop){T=documentElement.scrollTop;L=documentElement.scrollLeft}else{if(w.document.body){T=body.scrollTop;L=body.scrollLeft}}if(w.innerWidth){W=w.innerWidth;H=w.innerHeight}else{if(w.document.documentElement&&documentElement.clientWidth){W=documentElement.clientWidth;H=documentElement.clientHeight}else{W=body.offsetWidth;H=body.offsetHeight}}}return{top:T,left:L,width:W,height:H}}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(B,A){this.element=$(B);this.observer=A;this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark();if(this.lastValue!=Sortable.serialize(this.element)){this.observer(this.element)}}});var Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(A){while(A.tagName.toUpperCase()!="BODY"){if(A.id&&Sortable.sortables[A.id]){return A}A=A.parentNode}},options:function(A){A=Sortable._findRootElement($(A));if(!A){return }return Sortable.sortables[A.id]},destroy:function(A){var B=Sortable.options(A);if(B){Draggables.removeObserver(B.element);B.droppables.each(function(C){Droppables.remove(C)});B.draggables.invoke("destroy");delete Sortable.sortables[B.element.id]}},create:function(C){C=$(C);var B=Object.extend({element:C,tag:"li",dropOnEmpty:false,tree:false,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:C,handle:false,only:false,delay:0,hoverclass:null,ghosting:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:false,handles:false,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(C);var A={revert:true,quiet:B.quiet,scroll:B.scroll,scrollSpeed:B.scrollSpeed,scrollSensitivity:B.scrollSensitivity,delay:B.delay,ghosting:B.ghosting,constraint:B.constraint,handle:B.handle};if(B.starteffect){A.starteffect=B.starteffect}if(B.reverteffect){A.reverteffect=B.reverteffect}else{if(B.ghosting){A.reverteffect=function(F){F.style.top=0;F.style.left=0}}}if(B.endeffect){A.endeffect=B.endeffect}if(B.zindex){A.zindex=B.zindex}var D={overlap:B.overlap,containment:B.containment,tree:B.tree,hoverclass:B.hoverclass,onHover:Sortable.onHover};var E={onHover:Sortable.onEmptyHover,overlap:B.overlap,containment:B.containment,hoverclass:B.hoverclass};Element.cleanWhitespace(C);B.draggables=[];B.droppables=[];if(B.dropOnEmpty||B.tree){Droppables.add(C,E);B.droppables.push(C)}(B.elements||this.findElements(C,B)||[]).each(function(H,F){var G=B.handles?$(B.handles[F]):(B.handle?$(H).select("."+B.handle)[0]:H);B.draggables.push(new Draggable(H,Object.extend(A,{handle:G})));Droppables.add(H,D);if(B.tree){H.treeNode=C}B.droppables.push(H)});if(B.tree){(Sortable.findTreeElements(C,B)||[]).each(function(F){Droppables.add(F,E);F.treeNode=C;B.droppables.push(F)})}this.sortables[C.id]=B;Draggables.addObserver(new SortableObserver(C,B.onUpdate))},findElements:function(B,A){return Element.findChildren(B,A.only,A.tree?true:false,A.tag)},findTreeElements:function(B,A){return Element.findChildren(B,A.only,A.tree?true:false,A.treeTag)},onHover:function(E,D,A){if(Element.isParent(D,E)){return }if(A>0.33&&A<0.66&&Sortable.options(D).tree){return }else{if(A>0.5){Sortable.mark(D,"before");if(D.previousSibling!=E){var B=E.parentNode;E.style.visibility="hidden";D.parentNode.insertBefore(E,D);if(D.parentNode!=B){Sortable.options(B).onChange(E)}Sortable.options(D.parentNode).onChange(E)}}else{Sortable.mark(D,"after");var C=D.nextSibling||null;if(C!=E){var B=E.parentNode;E.style.visibility="hidden";D.parentNode.insertBefore(E,C);if(D.parentNode!=B){Sortable.options(B).onChange(E)}Sortable.options(D.parentNode).onChange(E)}}}},onEmptyHover:function(E,G,H){var I=E.parentNode;var A=Sortable.options(G);if(!Element.isParent(G,E)){var F;var C=Sortable.findElements(G,{tag:A.tag,only:A.only});var B=null;if(C){var D=Element.offsetSize(G,A.overlap)*(1-H);for(F=0;F<C.length;F+=1){if(D-Element.offsetSize(C[F],A.overlap)>=0){D-=Element.offsetSize(C[F],A.overlap)}else{if(D-(Element.offsetSize(C[F],A.overlap)/2)>=0){B=F+1<C.length?C[F+1]:null;break}else{B=C[F];break}}}}G.insertBefore(E,B);Sortable.options(I).onChange(E);A.onChange(E)}},unmark:function(){if(Sortable._marker){Sortable._marker.hide()}},mark:function(B,A){var D=Sortable.options(B.parentNode);if(D&&!D.ghosting){return }if(!Sortable._marker){Sortable._marker=($("dropmarker")||Element.extend(document.createElement("DIV"))).hide().addClassName("dropmarker").setStyle({position:"absolute"});document.getElementsByTagName("body").item(0).appendChild(Sortable._marker)}var C=Position.cumulativeOffset(B);Sortable._marker.setStyle({left:C[0]+"px",top:C[1]+"px"});if(A=="after"){if(D.overlap=="horizontal"){Sortable._marker.setStyle({left:(C[0]+B.clientWidth)+"px"})}else{Sortable._marker.setStyle({top:(C[1]+B.clientHeight)+"px"})}}Sortable._marker.show()},_tree:function(E,B,F){var D=Sortable.findElements(E,B)||[];for(var C=0;C<D.length;++C){var A=D[C].id.match(B.format);if(!A){continue}var G={id:encodeURIComponent(A?A[1]:null),element:E,parent:F,children:[],position:F.children.length,container:$(D[C]).down(B.treeTag)};if(G.container){this._tree(G.container,B,G)}F.children.push(G)}return F},tree:function(D){D=$(D);var C=this.options(D);var B=Object.extend({tag:C.tag,treeTag:C.treeTag,only:C.only,name:D.id,format:C.format},arguments[1]||{});var A={id:null,parent:null,children:[],container:D,position:0};return Sortable._tree(D,B,A)},_constructIndex:function(B){var A="";do{if(B.id){A="["+B.position+"]"+A}}while((B=B.parent)!=null);return A},sequence:function(B){B=$(B);var A=Object.extend(this.options(B),arguments[1]||{});return $(this.findElements(B,A)||[]).map(function(C){return C.id.match(A.format)?C.id.match(A.format)[1]:""})},setSequence:function(B,C){B=$(B);var A=Object.extend(this.options(B),arguments[2]||{});var D={};this.findElements(B,A).each(function(E){if(E.id.match(A.format)){D[E.id.match(A.format)[1]]=[E,E.parentNode]}E.parentNode.removeChild(E)});C.each(function(E){var F=D[E];if(F){F[1].appendChild(F[0]);delete D[E]}})},serialize:function(C){C=$(C);var B=Object.extend(Sortable.options(C),arguments[1]||{});var A=encodeURIComponent((arguments[1]&&arguments[1].name)?arguments[1].name:C.id);if(B.tree){return Sortable.tree(C,arguments[1]).children.map(function(D){return[A+Sortable._constructIndex(D)+"[id]="+encodeURIComponent(D.id)].concat(D.children.map(arguments.callee))}).flatten().join("&")}else{return Sortable.sequence(C,arguments[1]).map(function(D){return A+"[]="+encodeURIComponent(D)}).join("&")}}};Element.isParent=function(B,A){if(!B.parentNode||B==A){return false}if(B.parentNode==A){return true}return Element.isParent(B.parentNode,A)};Element.findChildren=function(D,B,A,C){if(!D.hasChildNodes()){return null}C=C.toUpperCase();if(B){B=[B].flatten()}var E=[];$A(D.childNodes).each(function(G){if(G.tagName&&G.tagName.toUpperCase()==C&&(!B||(Element.classNames(G).detect(function(H){return B.include(H)})))){E.push(G)}if(A){var F=Element.findChildren(G,B,A,C);if(F){E.push(F)}}});return(E.length>0?E.flatten():[])};Element.offsetSize=function(A,B){return A["offset"+((B=="vertical"||B=="height")?"Height":"Width")]};var Builder={NODEMAP:{AREA:"map",CAPTION:"table",COL:"table",COLGROUP:"table",LEGEND:"fieldset",OPTGROUP:"select",OPTION:"select",PARAM:"object",TBODY:"table",TD:"table",TFOOT:"table",TH:"table",THEAD:"table",TR:"table"},node:function(A){A=A.toUpperCase();var F=this.NODEMAP[A]||"div";var B=document.createElement(F);try{B.innerHTML="<"+A+"></"+A+">"}catch(E){}var D=B.firstChild||null;if(D&&(D.tagName.toUpperCase()!=A)){D=D.getElementsByTagName(A)[0]}if(!D){D=document.createElement(A)}if(!D){return }if(arguments[1]){if(this._isStringOrNumber(arguments[1])||(arguments[1] instanceof Array)||arguments[1].tagName){this._children(D,arguments[1])}else{var C=this._attributes(arguments[1]);if(C.length){try{B.innerHTML="<"+A+" "+C+"></"+A+">"}catch(E){}D=B.firstChild||null;if(!D){D=document.createElement(A);for(attr in arguments[1]){D[attr=="class"?"className":attr]=arguments[1][attr]}}if(D.tagName.toUpperCase()!=A){D=B.getElementsByTagName(A)[0]}}}}if(arguments[2]){this._children(D,arguments[2])}return D},_text:function(A){return document.createTextNode(A)},ATTR_MAP:{className:"class",htmlFor:"for"},_attributes:function(A){var B=[];for(attribute in A){B.push((attribute in this.ATTR_MAP?this.ATTR_MAP[attribute]:attribute)+'="'+A[attribute].toString().escapeHTML().gsub(/"/,"&quot;")+'"')}return B.join(" ")},_children:function(B,A){if(A.tagName){B.appendChild(A);return }if(typeof A=="object"){A.flatten().each(function(C){if(typeof C=="object"){B.appendChild(C)}else{if(Builder._isStringOrNumber(C)){B.appendChild(Builder._text(C))}}})}else{if(Builder._isStringOrNumber(A)){B.appendChild(Builder._text(A))}}},_isStringOrNumber:function(A){return(typeof A=="string"||typeof A=="number")},build:function(B){var A=this.node("div");$(A).update(B.strip());return A.down()},dump:function(B){if(typeof B!="object"&&typeof B!="function"){B=window}var A=("A ABBR ACRONYM ADDRESS APPLET AREA B BASE BASEFONT BDO BIG BLOCKQUOTE BODY BR BUTTON CAPTION CENTER CITE CODE COL COLGROUP DD DEL DFN DIR DIV DL DT EM FIELDSET FONT FORM FRAME FRAMESET H1 H2 H3 H4 H5 H6 HEAD HR HTML I IFRAME IMG INPUT INS ISINDEX KBD LABEL LEGEND LI LINK MAP MENU META NOFRAMES NOSCRIPT OBJECT OL OPTGROUP OPTION P PARAM PRE Q S SAMP SCRIPT SELECT SMALL SPAN STRIKE STRONG STYLE SUB SUP TABLE TBODY TD TEXTAREA TFOOT TH THEAD TITLE TR TT U UL VAR").split(/\s+/);A.each(function(C){B[C]=function(){return Builder.node.apply(Builder,[C].concat($A(arguments)))}})}};var HiddenInput;(function(){var A={initialize:function(B,C){this.element=$(B);this.auto_complete=C;this.token;Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(B){if(this.token.selected){switch(B.keyCode){case Event.KEY_LEFT:this.token.element.insert({before:this.auto_complete.wrapper});this.token.deselect();this.auto_complete.element.focus();return false;case Event.KEY_RIGHT:this.token.element.insert({after:this.auto_complete.wrapper});this.token.deselect();this.auto_complete.element.focus();return false;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token.handleDelete();this.auto_complete.element.focus();return false}}}};HiddenInput=Class.create(A)})();var Token;(function(){var A={initialize:function(C,B){this.element=$(C);this.hidden_input=B;if(this.hidden_input){this.hidden_input.token=this}this.element.token=this;this.selected=false;Event.observe(document,"click",this.onclick.bindAsEventListener(this))},select:function(){if(this.hidden_input){this.hidden_input.token=this;this.hidden_input.element.activate()}this.selected=true;this.element.addClassName("token_selected")},deselect:function(){if(this.hidden_input){this.hidden_input.token=undefined}this.selected=false;this.element.removeClassName("token_selected")},handleDelete:function(){this.element.remove()},onclick:function(B){if(this.detect(B)&&!this.selected){this.select()}else{this.deselect()}},detect:function(E){var D=E.target?E.target:E.srcElement;var B=D.token;var C=D;while(B==null&&C.parentNode){C=C.parentNode;B=C.token}return B!=null&&B.element==this.element}};Token=Class.create(A)})();(function(){var A={initialize:function(C,E,D,B){this.baseInitialize(C,E,B);this.options.array=D;this.wrapper=$(this.element.parentNode);if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){this.wrapper.addClassName("tokenizer_input_borderless")}this.options.onShow=function(F,G){Position.clone(F.parentNode.parentNode,G,{setHeight:false,setWidth:false,offsetTop:F.parentNode.parentNode.offsetHeight});G.show()};this.options.onHide=function(F,G){G.hide()}},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this))},onBlur:function($super,B){$super();if(this.wrapper.nextSiblings().length>0){this.wrapper.nextSiblings().last().insert({after:this.wrapper})}},set_input_size:function(B){B=B||20;this.element.setStyle({width:B+"px"})},onKeyPress:function(C){var D=20+(this.element.value.length*7);if(D<=340){this.set_input_size(D)}else{this.set_input_size(340)}if(this.active){switch(C.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry();Event.stop(C);case Event.KEY_ESC:this.hide();this.active=false;Event.stop(C);return ;case Event.KEY_LEFT:case Event.KEY_RIGHT:return ;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(C);return ;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(C);return }}else{if(C.keyCode==Event.KEY_TAB||C.keyCode==Event.KEY_RETURN||(Prototype.Browser.WebKit>0&&C.keyCode==0)||C.keyCode==44||C.keyCode==188){var B=this.element.value.strip().sub(",","");if(this.addNewToken(B)){Event.stop(C);this.element.value="";this.set_input_size();return false}}switch(C.keyCode){case Event.KEY_LEFT:case Event.KEY_BACKSPACE:if(this.element.value==""&&typeof this.wrapper.previous().token!="undefined"){this.wrapper.previous().token.select()}return ;case Event.KEY_RIGHT:if(this.element.value==""&&this.wrapper.next()&&typeof this.wrapper.next().token!="undefined"){this.wrapper.next().token.select()}}}this.changed=true;this.hasFocus=true;if(this.observer){clearTimeout(this.observer)}this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},setOptions:function(B){this.options=Object.extend({choices:10,partialSearch:true,partialChars:2,ignoreCase:true,fullSearch:false,selector:function(K){var G=[];var H=[];var J=K.getToken();var F=0;for(var E=0;E<K.options.array.length&&G.length<K.options.choices;E++){var C=K.options.array[E];var D=C[K.options.search_field];var L=K.options.ignoreCase?D.toLowerCase().indexOf(J.toLowerCase()):D.indexOf(J);while(L!=-1){if(L==0&&D.length!=J.length){var I="<strong>"+D.substr(0,J.length)+"</strong>"+D.substr(J.length);G.push("<li value='"+E+"'><div>"+I+"</div><div>"+C.email+"</div></li>");break}else{if(J.length>=K.options.partialChars&&K.options.partialSearch&&L!=-1){if(K.options.fullSearch||/\s/.test(D.substr(L-1,1))){var I=D.substr(0,L)+"<strong>"+D.substr(L,J.length)+"</strong>"+D.substr(L+J.length);H.push("<li value='"+E+"'><div>"+I+"</div><div>"+C.email+"</div></li>");break}}}L=K.options.ignoreCase?D.toLowerCase().indexOf(J.toLowerCase(),L+1):D.indexOf(J,L+1)}}if(H.length){G=G.concat(H.slice(0,K.options.choices-G.length))}return"<ul>"+G.join("")+"</ul>"}},B||{})},addNewToken:function(B){}};Autocompleter.LocalAdvanced=Class.create(Autocompleter.Base,A)})();var TagLightboxController;(function(){var staticMembers={EVENT:{LOADED:"PBTagLightbox:Loaded"}};var publicMembers={objTagDialogController:null,urlBase:"",strParentId:"",strInitImageId:"",functHandleAddTagClick:null,changeWaitingForSuccess:false,handleKeyPressHandler:null,onCloseCallback:null,initialize:function(){this.objTagDialogController=TaggingDialogController.getInstance()},initializeObject:function(strParentId,strInitImageId,imgId){this.objTagDialogController.resetObject();this.objTagDialogController.setLoadEventHandler(document,TagLightboxController.EVENT.LOADED);this.strParentId=strParentId;this.strInitImageId=strInitImageId;this.imgId=imgId;this.attachToUI();this.handleKeyPressHandler=this.onKeyPress.bindAsEventListener(this);Event.observe(this.strParentId,"keydown",this.handleKeyPressHandler);var tokens=$(this.strParentId).select(".token");tokens.each(function(token){var tag=eval("("+token.down("input").value+")");this.addTagToken(tag,token)}.bind(this))},addTagToken:function(tag,token){var cfg={element:token,tag:tag,onHover:this.onTokenHover.bind(this)};var token=new TagToken(cfg);pageTags.addTagToImg(this.imgId,tag);return token},insertTagToken:function(tag){var token=this.addTagToken(tag);var container=$("containerCurrentTags").down(".tokenizer");container.appendChild(token.element)},onTokenHover:function(tag,isOver){tag=PBTag.validate(tag);if(isOver){ImageTag.showTag(tag.boxId,"lightbox")}else{ImageTag.hideTag(tag.boxId,"lightbox")}},attachToUI:function(){var list,elt,i;this.urlBase=document.location.pathname;var elt=$(this.strParentId);if(elt!=null){this.strParentId=elt.id;this.functHandleAddTagClick=this.handleAddTagClick.bindAsEventListener(this);list=Element.select(document,".linkAddTag");for(i=0;i<list.length;i++){Event.observe(list[i],"click",this.functHandleAddTagClick,false)}list=Element.select(elt,"IMG.imageTag");for(i=0;i<list.length;i++){Event.observe(list[i],"click",this.functHandleAddTagClick,false);list[i].style.cursor="crosshair"}if(typeof (pageTags)=="object"){pageTags.initialize();pageTags.addEventCallback("mouseover",this.callbackTagMouseover.bind(this));pageTags.addEventCallback("mouseout",this.callbackTagMouseout.bind(this))}}if(typeof (this.strInitImageId)=="string"&&this.strInitImageId){this.intiateDialog(this.strInitImageId,null)}if((elt=$("linkSaveAndContinue"))!=null){Event.observe(elt,"click",this.handleSaveClose_Closure(elt).bindAsEventListener(this),false)}return true},handleLighboxDeactivate:function(evnt){if(this.strParentId&&this.handleKeyPressHandler){Event.stopObserving(this.strParentId,"keypress",this.handleKeyPressHandler)}},onKeyPress:function(event){switch(event.keyCode){case 220:case 13:Event.stop(event);break}},callbackTagMouseover:function(idImage){var elt;if((elt=$(idImage))!=null){Event.stopObserving(elt,"click",this.functHandleAddTagClick,false)}},callbackTagMouseout:function(idImage){var elt;if((elt=$(idImage))!=null){Event.observe(elt,"click",this.functHandleAddTagClick,false)}},handleAddTagClick:function(evnt){var elt=Event.findElement(evnt,"BUTTON");var objCropperPos=null;if(elt&&Element.hasClassName(elt,"button_disabled")&&this.objTagDialogController.isDialogOpen()){return false}if(!elt||elt===document){elt=Event.findElement(evnt,"IMG");objCropperPos={left:typeof (evnt.layerX)!="undefined"?evnt.layerX:evnt.x,top:typeof (evnt.layerY)!="undefined"?evnt.layerY:evnt.y}}if(elt){var id=elt.id.split("_")[1];this.intiateDialog("imageTag_"+id,objCropperPos)}return false},intiateDialog:function(imageID,objCropperPos){var eltImage;if(typeof (imageID)=="string"&&imageID&&(eltImage=$(imageID))!=null){if(eltImage.complete){voidDialog_Closure(eltImage,objCropperPos)()}else{Event.observe(eltImage,"loaddisabled",voidDialog_Closure(eltImage,objCropperPos).bindAsEventListener(this),false)}}}voidDialog_Closure:function(eltImage,objCropperPos){var _self=this;return function(evnt){var imageID=eltImage.id;var objOffset=getEltOffsetPos(eltImage,$(_self.strParentId));var id=imageID.split("_")[1];Event.stopObserving(eltImage,"click",_self.functHandleAddTagClick,false);objOffset.left+=eltImage.offsetWidth+10;pageTags.disableTagsOnImg(imageID,true);_self.voidDialog(eltImage,objOffset,objCropperPos,_self.callbackTaggingSuccess_Closure(id).bind(_self),_self.callbackTaggingFailure_Closure(id).bind(_self),_self.callbackTaggingCancel_Closure(id).bind(_self),_self.callbackDialogState_Closure(id).bind(_self))}},handleAjaxFailure_Closure:function(eltId){return function(response){this.displayErrorMessage({type:PBMessage.MESSAGE_TYPE.ERROR,title:"An Unknown Error Occured"})}},handleSaveClose_Closure:function(elt){return function(evt){evt.stop();elt.focus();pe=new PeriodicalExecuter(this.handleSaveCloseDone_Closure(elt).bind(this),0.1)}},handleSaveCloseDone_Closure:function(elt){return function(pe){if(this.changeWaitingForSuccess==false){pe.stop();document.location.replace(elt.href)}}},parseErrorMessage:function(strMessage){var list=strMessage.split("<sep>");return list},displayErrorMessage:function(cfg){document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage(cfg)})},resetErrorMessage:function(cellID){var elt;document.fire(PBLightbox.PBMessage.EVENT.CLOSE)},callbackTaggingSuccess_Closure:function(idCell){return function(jsonResponse,tagparams){var tagID=null;var tagBoxId="";var tagText="";var tagUrl="";if(typeof (jsonResponse.tag_id)!="undefined"&&jsonResponse.tag_id){tagID=jsonResponse.tag_id}if(typeof (jsonResponse.boxId)!="undefined"&&jsonResponse.boxId){tagBoxId=jsonResponse.boxId}if(typeof (tagparams.tag)!="undefined"&&tagparams.tag!=""&&tagparams.tag!=null){tagText=(""+tagparams.tag).stripTags().stripScripts().escapeHTML()}if(typeof (tagparams.link)!="undefined"&&tagparams.link!=""&&tagparams.link!=null){tagUrl=(""+tagparams.link).stripTags().stripScripts().escapeHTML()}var tag=new PBTag({tag_id:tagID,tag:tagText,url:tagUrl,p1x:tagparams.p1x,p1y:tagparams.p1y,p2x:tagparams.p2x,p2y:tagparams.p2y,boxId:tagBoxId});this.insertTagToken(tag);pageTags.enableTagsOnImg(this.imgId,true);document.fire(TagToken.EVENT.ADD,{tag:tag,html:jsonResponse.tagHtml});Event.observe($(this.imgId),"click",this.functHandleAddTagClick);Element.removeClassName("linkAddTag_"+idCell,"button_disabled")}},callbackTaggingFailure_Closure:function(idCell){return function(jsonResponse,tagaddparams){var pbResponse=translateAjaxResponse(jsonResponse);var mssg={type:PBMessage.MESSAGE_TYPE.ERROR,title:"Tagging your image failed."};if(pbResponse&&typeof (pbResponse.message)=="string"){mssg.details=pbResponse.message}else{mssg.details="An unknown error occured."}this.displayErrorMessage(mssg);Event.observe($("imageTag_"+idCell),"click",this.functHandleAddTagClick,false);pageTags.enableTagsOnImg("imageTag_"+idCell,true);Element.removeClassName("linkAddTag_"+idCell,"button_disabled")}},callbackTaggingCancel_Closure:function(idCell){return function(tagaddparams){Event.observe($("imageTag_"+idCell),"click",this.functHandleAddTagClick,false);pageTags.enableTagsOnImg("imageTag_"+idCell,true);Element.removeClassName("linkAddTag_"+idCell,"button_disabled")}},callbackDialogState_Closure:function(idCell){return function(bIsOpen){if(bIsOpen){if(!Element.hasClassName("linkAddTag_"+idCell,"button_disabled")){Element.addClassName("linkAddTag_"+idCell,"button_disabled")}}else{if(Element.hasClassName("linkAddTag_"+idCell,"button_disabled")){Element.removeClassName("linkAddTag_"+idCell,"button_disabled")}}}}};Controller.create("TagLightboxController",publicMembers,staticMembers)})();var AutoCompleteTagController;(function(){var A={data:null,fetching:false,tagCache:new Hash(),updateHtml:false,tagContainerId:null,tagListClassName:null,editors:new Hash(),trackingPageName:null,initialize:function(){Event.observe(document,PB.EVENT.PAGE_LOADED,this.fetchData.bindAsEventListener(this));Event.observe(document,AutoCompleteTagController.EVENT.OPEN_ADVANCED,voidAdvancedTagging.bindAsEventListener(this));Event.observe(document,Autocompleter.LocalTags.EVENT.TAG_ADDED,this.addTag.bindAsEventListener(this));Event.observe(document,Autocompleter.LocalTags.EVENT.TAG_REMOVED,this.removeTag.bindAsEventListener(this));Event.observe(document,TagToken.EVENT.ADD,this.trackTagging.curry("add").bind(this));Event.observe(document,TagToken.EVENT.REMOVE,this.trackTagging.curry("remove").bind(this));Event.observe(document,Autocompleter.LocalTags.EVENT.TAG_CREATED,this.onTagCreated.bindAsEventListener(this))},mixIn:function(C){for(var D in C){this[D]=C[D]}}voidAdvancedTagging:function(E){var C=E.memo;var D={contentUrl:"?action=taggingdialog",parameters:C,cache:false,onComplete:this.lightboxLoaded.curry(C).bindAsEventListener(this)};document.fire(PBLightbox.EVENT.ACTIVATE,D);this.onCloseHandler=this.onCloseAdvancedTagging.curry(C.index).bindAsEventListener(this);this.onAdvTaggingAdd=this.onAddAdvancedTagging.curry(C.index).bindAsEventListener(this);this.onAdvTaggingRemove=this.onRemoveAdvancedTagging.curry(C.index).bindAsEventListener(this);Event.observe(document,PBLightbox.EVENT.DEACTIVATED,this.onCloseHandler);Event.observe(document,TagToken.EVENT.ADD,this.onAdvTaggingAdd);Event.observe(document,TagToken.EVENT.REMOVE,this.onAdvTaggingRemove);if(this.trackingPageName){APIRequest.track(this.trackingPageName+"void")}},onTagCreated:function(D){var C=D.memo;this.tagCache.set(C.name,C);document.fire(AutoCompleteTagController.EVENT.NEW_DATA)},onCloseAdvancedTagging:function(C,D){Event.stopObserving(document,PBLightbox.EVENT.DEACTIVATED,this.onCloseHandler);Event.stopObserving(document,TagToken.EVENT.ADD,this.onAdvTaggingAdd);Event.stopObserving(document,TagToken.EVENT.REMOVE,this.onAdvTaggingRemove)},onAddAdvancedTagging:function(D,F){var E=this.getEditor(D);var C=F.memo.tag;E.addTokenToList(C);E.onTagSaved(F.memo)},onRemoveAdvancedTagging:function(D,G){var F=this.getEditor(D);var C=PBTag.validate(G.memo);var E=F.findToken(C);E.removeElement();F.onTagDeleted(G.memo)},lightboxLoaded:function(C,E){var D=TagLightboxController.getInstance();D.initializeObject("containerTagImage_TaggingDialog","imageTag_TaggingDialog","imageTag_TaggingDialog")},fetchData:function(C){if(!this.fetching){new Ajax.Request(document.location.pathname,{method:"post",parameters:{action:"tagsummary"},evalJSON:"force",onSuccess:this.handleFetchedData.bindAsEventListener(this)});this.fetching=true}},handleFetchedData:function(C){if(C.responseJSON.response){var E=C.responseJSON.response;var D=[];if(E.stat=="ok"&&E.items){E.items.each(function(F){D[D.length]=new PBTag(F)})}this.tagCache=new Hash();D.each(function(F){this.tagCache.set(F.name,F)}.bind(this));document.fire(AutoCompleteTagController.EVENT.NEW_DATA)}this.fetching=false},addAC:function(C){var D=new Autocompleter.LocalTags("autocomplete_input_"+C.index,"autocomplete_populate_"+C.index,this.tagCache.values(),{frequency:0.1,search_field:"name",tags:C.tags,index:C.index,mediaUrl:C.mediaUrl,forceSuggestions:false});this.editors.set("aclt_"+C.index,D)},getEditor:function(C){return this.editors.get("aclt_"+C)},removeEditor:function(C){return this.editors.unset("aclt_"+C)},addTag:function(D){var C=D.memo.tag;if(C){this.tagCache.set(C.name,C)}},removeTag:function(C){},trackTagging:function(D){if(this.trackingPageName){var C=this.trackingPageName+"_click_";C+=(PBLightbox.getInstance().panel.active)?"lightbox":"inline";C+="_tag_"+D;APIRequest.track(C)}}};var B={EVENT:{NEW_DATA:"AutoCompleteTagController:NEW_DATA",OPEN_ADVANCED:"AutoCompleteTagController:OPEN_ADVANCED",TAGGING_EDITOR_CLOSED:"AutoCompleteTagController:TAGGING_EDITOR_CLOSED"}};Controller.create("AutoCompleteTagController",A,B)})();(function(){var A={hidden_input:null,input_div:null,display_div:null,mediaUrl:null,bEmpty:true,index:null,tagCache:null,tokenCache:null,initialize:function($super,D,F,E,C){$super(D,F,E,C);this.hidden_input=new HiddenInput("hidden_input_"+C.index,this);this.input_div=$("autocomplete_input_"+C.index);this.display_div=$("autocomplete_display_"+C.index);this.mediaUrl=C.mediaUrl;this.index=C.index;this.tagCache=new Hash();this.tokenCache=new Hash();C.tags=C.tags||[];C.tags.each(function(G){this.addTokenToList(G);this.tagCache.set(G.name,G);this.bEmpty=false}.bind(this));if(AutoCompleteTagController.getInstance().tagCache.values().length>0){this.onDataChange()}Event.observe(document,AutoCompleteTagController.EVENT.NEW_DATA,this.onDataChange.bindAsEventListener(this))},destroy:function(){this.onTagSaved=new function(){};this.onTagDeleted=new function(){};this.tagCache=new Hash();this.tokenCache=new Hash()},onDataChange:function(D){var C=AutoCompleteTagController.getInstance().tagCache;this.options.array=C.values();this.updateOptions()},onBlur:function($super,D){var C=this.element.value.strip().sub(",","");if(!this.active&&this.addNewToken(C)){this.element.value="";this.set_input_size()}$super()},addNewToken:function(E){if(E.length==0){return false}var C=new PBTag({tag:E,mediaUrl:this.mediaUrl});var D=this.addTokenToList(C);D.saveTag();document.fire(Autocompleter.LocalTags.EVENT.TAG_CREATED,C);return true},updateElement:function(F){var D=Element.readAttribute(F,"value");var C=this.options.array[D];C.mediaUrl=this.mediaUrl;var E=this.addTokenToList(C);E.saveTag()},onTagSaved:function(C){this.tagCache.set(C.tag.name,C.tag);document.fire(Autocompleter.LocalTags.EVENT.TAG_ADDED,C)},onTagDeleted:function(D){var C=new PBTag(D);this.bEmpty=(this.tagCache.values().length==1);this.tagCache.unset(C.name);this.tokenCache.unset(C.name);document.fire(Autocompleter.LocalTags.EVENT.TAG_REMOVED,{tag:C});this.updateOptions()},addTokenToList:function(C){this.bEmpty=false;this.input_div.value="";var D={tag:C,hidden_input:this.hidden_input,onDelete:this.onTagDeleted.bind(this),onSave:this.onTagSaved.bind(this),mediaUrl:this.mediaUrl,isFirst:(this.tagCache.values().length==0)};var E=new TagToken(D);if(this.display_div.parentNode==null){this.display_div=$(this.display_div.id)}this.display_div.insert({before:E.element});this.tokenCache.set(C.name,E);this.updateOptions();return E},markPrevious:function(){if(this.index>0){this.index--}else{this.index=this.entryCount-1}this.scrollIntoView(this.getEntry(this.index),false)},markNext:function(){if(this.index<this.entryCount-1){this.index++}else{this.index=0}this.scrollIntoView(this.getEntry(this.index),true)},scrollIntoView:function(D,C){if(!PB.Util.Visibility.inView(D)){var E=Element.getHeight(D);if(C){window.scrollBy(0,E)}else{window.scrollBy(0,-E)}}},findToken:function(C){var D=this.tokenCache.get(C.name);return D},updateOptions:function(){var D=AutoCompleteTagController.getInstance().tagCache.values();if(D.length>0){var C=new Hash();D.each(function(E){C.set(E.name,E)});this.tokenCache.keys().each(function(E){C.unset(E)});this.options.array=C.values()}},onKeyPress:function($super,C){switch(C.keyCode){case 220:Event.stop(C);return ;default:$super(C)}}};var B={EVENT:{TAG_ADDED:"Autocompleter.LocalTags:TAG_ADDED",TAG_CREATED:"Autocompleter.LocalTags:TAG_CREATED",TAG_REMOVED:"Autocompleter.LocalTags:TAG_REMOVED"}};Autocompleter.LocalTags=Class.create(Autocompleter.LocalAdvanced,A);Autocompleter.LocalTags=Object.extend(Autocompleter.LocalTags,B)})();var TaggingDialogController;(function(){var A={minRectWidth:15,minRectHeight:15,nCountr:0,bLocked:true,bOpened:true,bIncludesContact:false,bDialogStaticallyPositioned:false,implementationQueue:null,eltDialog:null,eltTag:null,eltTagEmail:null,eltTagUrl:null,eltLastUpdate:null,tsLastUpdate:0,listContactCache:null,listContactElts:null,strLastTag:"",idPostKeyTimeout:null,idUpdateInterval:null,idOpenDialogInterval:null,listContacts:null,indxCurrentTag:-1,idCurrentSelectedTag:-1,objCropper:null,eltImage:null,rectCoords:{x1:0,y1:0,x2:0,y2:0},rectDims:{width:0,height:0},imageDims:{width:0,height:0},tagaddparams:{},callbackSuccess:null,callbackFailure:null,callbackCancel:null,callbackState:null,nTagCount:0,urlBase:"",functHandleContactListItemClick:null,listContactsTemp:[],loaddisabledEventCfg:null,initialize:function(){this.resetObject()},setLoadEventHandler:function(C,D){if(typeof (D)=="string"&&D&&typeof (C)!="undefined"&&C){this.loaddisabledEventCfg={handler:this.attachToUI.bindAsEventListener(this),loaddisabledEvent:D,loaddisabledElement:C};Event.observe(C,D,this.loaddisabledEventCfg.handler,false)}else{}},resetObject:function(){this.listContactCache=[];this.listContactElts={};this.nCountr=0;this.bLocked=true;this.bOpened=true;this.bIncludesContact=false;this.bDialogStaticallyPositioned=false;this.implementationQueue=null;this.eltDialog=null;this.eltTag=null;this.eltTagEmail=null;this.eltTagUrl=null;this.eltLastUpdate=null;this.tsLastUpdate=0;this.listContactCache=null;this.listContactElts=null;this.strLastTag="";this.idPostKeyTimeout=null;this.idUpdateInterval=null;this.idOpenDialogInterval=null;this.listContacts=null;this.indxCurrentTag=-1;this.idCurrentSelectedTag=-1;this.objCropper=null;this.eltImage=null;this.rectCoords={x1:0,y1:0,x2:0,y2:0};this.rectDims={width:0,height:0};this.imageDims={width:0,height:0};this.tagaddparams={};this.callbackSuccess=null;this.callbackFailure=null;this.callbackCancel=null;this.callbackState=null;this.nTagCount=0;this.urlBase="";this.functHandleContactListItemClick=null;this.listContactsTemp=[]},attachToUI:function(H){var C,F,E,D,G;this.urlBase=document.location.protocol+"//"+document.location.host+document.location.pathname;this.toggleLockedState(true);this.retrieveTagList();this.eltDialog=$("dialogTagging");this.eltLastUpdate=$("timeLastUpdate");this.bDialogStaticallyPositioned=Element.hasClassName(this.eltDialog,"staticDialog");this.functHandleContactListItemClick=this.handleContactListItemClick.bindAsEventListener(this);if((this.eltTag=$("textTag"))!=null){Event.observe(this.eltTag,"keypress",this.handleKeyPress.bindAsEventListener(this),false);Event.observe(this.eltTag,"focus",this.handleTagTextFocus.bindAsEventListener(this),false)}this.eltTagEmail=$("tagEmail");this.eltTagUrl=$("tagURL");if((C=$("linkContact_import"))!=null){Event.observe(C,"click",this.handleContactLinkClick.bindAsEventListener(this),false)}if((C=$("bttnTag"))!=null){Event.observe(C,"click",this.handleSubmitClick.bindAsEventListener(this),false)}if((C=$("bttnTagCancel"))!=null){Event.observe(C,"click",this.handleCancelClick.bindAsEventListener(this),false)}if((C=$("linkTaggingDialogClose"))!=null){Event.observe(C,"click",this.handleCancelClick.bindAsEventListener(this),false)}Event.observe(document,ContactController.EVENT.ACTIVATED,this.handleContactActivated.bindAsEventListener(this));if(this.loaddisabledEventCfg){Event.stopObserving(this.loaddisabledEventCfg.loaddisabledElement,this.loaddisabledEventCfg.loaddisabledEvent,this.loaddisabledEventCfg.handler)}return true},retrieveTagList:function(){var D={};D.action="tagsummary";D=$H(D).toQueryString();try{new Ajax.Request(this.urlBase,{method:"post",parameters:D,onSuccess:this.handleAjaxRetrieveTagList.bind(this),onComplete:this.handleAjaxRetrieveTagListComplete.bind(this)})}catch(C){}},handleAjaxRetrieveTagList:function(C){C=translateAjaxResponse(C);if(typeof (C)!="undefined"&&typeof (C.stat)=="string"&&C.stat=="ok"&&typeof (C.items)!="undefined"&&C.items){this.listContactsTemp=C.items;this.hashTagList();this.buildTagList();this.toggleTagList(this.nTagCount>0);this.toggleImportContactPanels(this.bIncludesContact)}else{var D={type:PBMessage.MESSAGE_TYPE.ERROR,title:"An Unknown Error Occured"};if(typeof (C)!="undefined"&&typeof (C.stat)=="string"&&C.stat=="fail"&&typeof (C.message)=="string"){D.title=C.message}this.displayErrorMessage(D)}this.toggleLockedState(false)},handleAjaxRetrieveTagListComplete:function(C){this.bLocked=false},generateJSONTagItem:function(F,C,E,D,G){return{key:F.toString(),tag:(C?C:E),email:E,url:D,contact_address_id:G}},hashTagList:function(){this.listContacts=[];var C=[];for(var D=0;D<this.listContactsTemp.length;D++){this.bIncludesContact=this.bIncludesContact||this.listContactsTemp[D].email!="";C[D.toString()]=this.generateJSONTagItem(D.toString(),this.listContactsTemp[D].tag,this.listContactsTemp[D].email,this.listContactsTemp[D].url,this.listContactsTemp[D].contact_address_id);this.nTagCount++}this.listContacts=C},buildTagList:function(){var D=$("listTags");if(D){D.innerHTML="";this.listContactCache=[];this.listContactElts={};for(var C=0;C<this.listContacts.length;C++){this.listContactCache.push(this.listContacts[C].key);this.appendTagLI(C,this.listContacts[C])}}},appendTagLI:function(G,E){var F;if((F=$("listTags"))!=null){var J=E.tag?E.tag:E.email;var C=E.email?E.email:E.tag;var D={id:"tagItem_"+G,title:C};if(J==E.email){D.className="emailTag"}var H=Builder.node("li",D);Event.observe(H,"click",this.functHandleContactListItemClick,false);var I=Builder.node("a",{href:"javascript:void(0);"},J);H.appendChild(I);F.appendChild(H);this.listContactElts[G]=H}},removeTagLI:function(D){var E=$("tagItem_"+D);if(E){var C=E.parentNode;if(C){var F=C.removeChild(E)}}},checkForUpdate:function(){if(this.eltLastUpdate){var C=parseInt(this.eltLastUpdate.value);if(!isNaN(C)&&C>this.tsLastUpdate){clearInterval(this.idUpdateInterval);this.idUpdateInterval=null;this.retrieveTagList()}}},isDialogOpen:function(){return this.bOpened}voidDialog:function(G,F,C,H,D,I,E){this.implementationQueue={eltImage:G,objPos:F,objCropperPos:C,callbackSuccess:H,callbackFailure:D,callbackCancel:I,callbackState:E};if(!this.bLocked){voidDialog_Utility(G,F,C,H,D,I,E)}else{if(this.idOpenDialogInterval){clearInterval(this.idOpenDialogInterval);this.idOpenDialogInterval=null}this.idOpenDialogInterval=setInterval(voidDialogDelay_Interval.bind(this),100)}}voidDialogDelay_Interval:function(){if(!this.bLocked&&this.implementationQueue){clearInterval(this.idOpenDialogInterval);this.idOpenDialogInterval=null;voidDialog_Utility(this.implementationQueue.eltImage,this.implementationQueue.objPos,this.implementationQueue.objCropperPos,this.implementationQueue.callbackSuccess,this.implementationQueue.callbackFailure,this.implementationQueue.callbackCancel,this.implementationQueue.callbackState)}}voidDialog_Utility:function(G,L,J,M,K,H,D){if(!this.bLocked){if(this.bOpened){this.closeDialog();this.resetDialog()}this.eltImage=G;this.imageDims.width=this.eltImage.width;this.imageDims.height=this.eltImage.height;this.imageDims.avg=Math.floor((this.imageDims.width+this.imageDims.height)/2);if(typeof (M)=="function"){this.callbackSuccess=M}if(typeof (K)=="function"){this.callbackFailure=K}if(typeof (H)=="function"){this.callbackCancel=H}if(typeof (D)=="function"){this.callbackState=D}if(!this.bDialogStaticallyPositioned&&L){this.setPosition(L)}this.bOpened=true;this.toggleButtonsState();if(this.callbackState){this.callbackState(this.bOpened)}var F=this.imageDims.width/2;var E=this.imageDims.height/2;if(J){F=J.left;E=J.top}var I=(this.imageDims.width<this.minRectWidth?this.imageDims.width:this.minRectWidth);var C=(this.imageDims.height<this.minRectHeight?this.imageDims.height:this.minRectHeight);cropSize=Math.floor(this.imageDims.avg/6);this.objCropper=new Cropper.Img(G,{onEndCrop:this.updateRect.bind(this),minWidth:I,minHeight:C,displayOnInit:true,captureKeys:false,onloaddisabledCoords:{x1:Math.floor(F-cropSize),y1:Math.floor(E-cropSize),x2:Math.floor(F+cropSize),y2:Math.floor(E+cropSize)}})}},closeDialog:function(){if(!this.bLocked){if(this.objCropper){this.objCropper.remove();this.objCropper=null}this.bOpened=false;this.toggleButtonsState();if(this.implementationQueue.callbackState){this.implementationQueue.callbackState(this.bOpened)}}},handleContactLinkClick:function(E){var C=Event.findElement(E,"A");if(C&&C.tagName=="A"&&typeof (C.id)!="undefined"){var D=C.id.split("_")[1];if(D){document.fire(ContactController.EVENT.ACTIVATE,{initialHeight:510,config:{selectOn:false}})}}},handleContactActivated:function(C){Event.observe(document,ContactController.EVENT.ONBACK,this.handleContactOnBack.bindAsEventListener(this));Event.observe(document,ContactController.EVENT.ONCANCEL,this.handleContactOnCancel.bindAsEventListener(this))},handleContactOnBack:function(C){this.retrieveTagList();Event.stopObserving(document,ContactController.EVENT.ONBACK);Event.stopObserving(document,ContactController.EVENT.ONCANCEL)},handleContactOnCancel:function(C){Event.stopObserving(document,ContactController.EVENT.ONBACK);Event.stopObserving(document,ContactController.EVENT.ONCANCEL)},handleKeyPress:function(F){var C=true;var D=Event.element(F);var E="";if(this.idPostKeyTimeout){clearTimeout(this.idPostKeyTimeout)}switch(F.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:if(this.indxCurrentTag>-1){this.populateAllTagInputs(this.listContactCache[this.indxCurrentTag])}else{if(D.value!==""){this.showTagDataPanel("","")}}return C;case Event.KEY_ESC:case Event.KEY_LEFT:case Event.KEY_RIGHT:case Event.KEY_HOME:case Event.KEY_END:case Event.KEY_PAGEUP:case Event.KEY_PAGEDOWN:return C;case Event.KEY_UP:this.clearCurrentTagElt();this.incrementSelectPointer(-1);this.selectListTagElt();return C;break;case Event.KEY_DOWN:this.clearCurrentTagElt();this.incrementSelectPointer(+1);this.selectListTagElt();return C;break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:default:this.clearCurrentTagElt();this.indxCurrentTag=-1;E=String.fromCharCode(F.charCode)}this.idPostKeyTimeout=setTimeout(this.handlePostKeyPress_Closure(D).bind(this),100);return C},handlePostKeyPress_Closure:function(C){return function(){if(C){var D=C.value.toLowerCase();if(D!=this.strLastTag){this.listContactCache=[];if(this.listContacts&&typeof (this.listContacts.each)=="function"){this.listContacts.each(this.checkContactListEntry_Closure(D).bind(this))}this.listContactCache=this.listContactCache.compact();if(this.indxCurrentTag>=this.listContactCache.length){this.indxCurrentTag=-1}if((!D||this.listContactCache.length)&&Element.visible("panelTagData")){this.idCurrentSelectedTag=-1;this.hideTagDataPanel()}else{if(this.listContactCache.length==0){this.showTagDataPanel("","")}}this.strLastTag=D}}}},handleContactListItemClick:function(E){var D=Event.findElement(E,"LI");if(D&&typeof (D.id)!="undefined"){var C=D.id.split("_")[1];this.idCurrentSelectedTag=parseInt(C);this.populateAllTagInputs(parseInt(C));if(!this.bLocked&&!this.bOpened){voidDialog_Utility(this.implementationQueue.eltImage,this.implementationQueue.objPos,null,this.implementationQueue.callbackSuccess,this.implementationQueue.callbackFailure,this.implementationQueue.callbackCancel,this.implementationQueue.callbackState)}}return false},handleTagTextFocus:function(C){if(!this.bLocked&&!this.bOpened){voidDialog_Utility(this.implementationQueue.eltImage,this.implementationQueue.objPos,null,this.implementationQueue.callbackSuccess,this.implementationQueue.callbackFailure,this.implementationQueue.callbackCancel,this.implementationQueue.callbackState)}},handleSubmitClick:function(H){if(!this.bLocked&&this.bOpened){if(this.eltTag.value){this.toggleLockedState(true);var G={};G.action="mediatagadd";var F=this.eltImage.src;F=unescape(F);G.media=F;G.cellid=this.eltImage.id.split("_")[1];G.p1x=this.rectCoords.x1/this.eltImage.width;G.p1y=this.rectCoords.y1/this.eltImage.height;G.p2x=this.rectCoords.x2/this.eltImage.width;G.p2y=this.rectCoords.y2/this.eltImage.height;G.tag=this.eltTag.value;var D=this.getTagObject(this.idCurrentSelectedTag);if(D&&D.contact_address_id&&D.email==this.eltTagEmail.value&&D.email==this.eltTagEmail.value){G.contact=this.listContacts[this.idCurrentSelectedTag].contact_address_id}else{if(this.eltTagEmail.value){G.contact=this.eltTagEmail.value}}if(this.eltTagUrl.value){var E=this.eltTagUrl.value.strip();var C=/^http[s]*:\/\//;if(!E.match(C)){E="httpdisabled://"+E}G.link=E}this.tagaddparams=G;G=$H(G).toQueryString();new Ajax.Request(this.urlBase,{method:"post",parameters:G,onSuccess:this.handleAjaxSuccess.bind(this),onFailure:this.handleAjaxFailure.bind(this),onComplete:this.handleAjaxComplete.bind(this)})}else{this.displayErrorMessage({type:PBMessage.MESSAGE_TYPE.ERROR,title:"No Tag Entered",details:"Please enter a name or a tag below."})}}return true},handleCancelClick:function(D){if(!this.bLocked&&this.bOpened){var C="";if(this.callbackCancel){this.callbackCancel(this.tagaddparams)}this.resetDialog();this.closeDialog()}return true},handleAjaxSuccess:function(C){var E=translateAjaxResponse(C);if(E.stat=="ok"){var D=E.tag_id;this.addTag(this.eltTag.value,this.eltTagEmail.value,this.eltTagUrl.value,E.contact_address_id);this.toggleTagList(this.nTagCount>0);this.toggleImportContactPanels(this.bIncludesContact);if(this.callbackSuccess){this.callbackSuccess(E,this.tagaddparams)}}else{if(this.callbackFailure){this.callbackFailure(C,this.tagaddparams)}}},handleAjaxFailure:function(C){if(this.callbackFailure){this.callbackFailure(C,this.tagaddparams)}},handleAjaxComplete:function(C){var D=translateAjaxResponse(C);this.toggleLockedState(false);this.resetDialog();this.closeDialog()},checkContactListEntry_Closure:function(C){return function(D){if(!C||D.tag.toLowerCase().indexOf(C)==0){Element.show(this.listContactElts[D.key]);if(!this.listContactCache.find(this.findIndexContactCache_Closure(D.key).bind(this))){this.listContactCache.push(D.key)}}else{Element.hide(this.listContactElts[D.key]);if(this.listContactCache.find(this.findIndexContactCache_Closure(D.key).bind(this))){this.listContactCache[D.key]=null}}}},findIndexContactCache_Closure:function(C){return function(E,D){return(E===C)}},updateRect:function(D,C){this.rectCoords.x1=D.x1;this.rectCoords.y1=D.y1;this.rectCoords.x2=D.x2;this.rectCoords.y2=D.y2;this.rectDims.width=C.width;this.rectDims.height=C.height},toggleButtonsState:function(){if(this.bOpened){if(Element.hasClassName("bttnTag","disabled")){Element.removeClassName("bttnTag","disabled")}if(Element.hasClassName("bttnTagCancel","disabled")){Element.removeClassName("bttnTagCancel","disabled")}}else{if(!Element.hasClassName("bttnTag","disabled")){Element.addClassName("bttnTag","disabled")}if(!Element.hasClassName("bttnTagCancel","disabled")){Element.addClassName("bttnTagCancel","disabled")}}},setPosition:function(C){if(this.eltDialog){this.eltDialog.style.left="";this.eltDialog.style.top="";this.eltDialog.style.right="";this.eltDialog.style.bottom="";if(C){for(var D in C){switch(D){case"left":case"top":case"right":case"bottom":this.eltDialog.style[D]=C[D]+"px"}}}}},resetDialog:function(){if(!this.bLocked){this.eltTag.value="";this.hideTagDataPanel();this.clearCurrentTagElt();this.callbackSuccess=null;this.callbackFailure=null;this.callbackCancel=null;this.callbackState=null;if(this.listContacts&&typeof (this.listContacts.each)=="function"){this.listContacts.each(this.checkContactListEntry_Closure(null).bind(this))}this.listContactCache=this.listContactCache.compact();this.indxCurrentTag=-1;var C;for(C in this.rectCoords){this.rectCoords[C]=0}for(C in this.rectDims){this.rectDims[C]=0}for(C in this.imageDims){this.imageDims[C]=0}this.resetErrorMessage()}},getTagObject:function(D){var C=null;if(typeof (D)!="undefined"&&D!==null){C=this.listContacts[D]}return C},clearCurrentTagElt:function(){if(this.listContactCache&&0<=this.indxCurrentTag&&this.indxCurrentTag<this.listContactCache.length){var C=this.listContactCache[this.indxCurrentTag];if(typeof (C)!="undefined"&&Element.hasClassName(this.listContactElts[C],"selected")){Element.removeClassName(this.listContactElts[C],"selected");this.listContactElts[0].scrollIntoView(false)}}},selectListTagElt:function(){var C;if(this.listContactCache&&0<=this.indxCurrentTag&&this.indxCurrentTag<this.listContactCache.length){C=this.listContactCache[this.indxCurrentTag];if(typeof (C)!="undefined"){if(!Element.hasClassName(this.listContactElts[C],"selected")){Element.addClassName(this.listContactElts[C],"selected");this.listContactElts[C].scrollIntoView(false)}}}},incrementSelectPointer:function(C){this.indxCurrentTag+=C;if(this.indxCurrentTag<-1){this.indxCurrentTag=-1}else{if(this.indxCurrentTag>=this.listContactCache.length){this.indxCurrentTag=this.listContactCache.length-1}}},populateAllTagInputs:function(C){var D=this.getTagObject(parseInt(C));if(D&&this.eltTag){this.eltTag.value=D.tag}this.showTagDataPanel(D.email,D.url)},toggleTagList:function(C){var E,D;if((E=$("pTaggingDialogNoTagList"))!=null&&(D=$("listTags"))!=null){if(C){Element.hide(E);Element.show(D)}else{Element.hide(D);Element.show(E)}}},toggleImportContactPanels:function(E){var C,D;if((C=$("containerImport"))!=null&&(D=$("groupImportLinks"))!=null){if(E){Element.hide(C);Element.show(D)}else{Element.hide(D);Element.show(C)}}},displayErrorMessage:function(C){document.fire(PBLightbox.PBMessage.EVENT.NOTIFY,{message:new PBMessage(C)})},resetErrorMessage:function(){var C;document.fire(PBLightbox.PBMessage.EVENT.CLOSE)},showTagDataPanel:function(D,C){this.populateTagDataInputs(D,C);Element.show("panelTagData");Element.hide("panelContactList")},hideTagDataPanel:function(){this.populateTagDataInputs("","");Element.hide("panelTagData");Element.show("panelContactList")},toggleLockedState:function(C){this.bLocked=C;var D=$("panelTaggingProgress");var E=$("shutterTaggingProgress");if(D&&E){this.shutterIE6Hack(C,E);if(C){Element.show(E);Element.show(D)}else{Element.hide(E);Element.hide(D)}}},shutterIE6Hack:function(C,D){if(photobucket.browser.isIE6&&this.eltDialog&&D){if(C){D.style.height=(this.eltDialog.offsetHeight)+"px"}else{D.style.height=""}}},populateTagDataInputs:function(E,D){var C;if(E!=null&&(C=$("tagEmail"))!=null){C.value=E}if(D!=null&&(C=$("tagURL"))!=null){C.value=D}},addTag:function(C,E,D,G){for(var F=0;F<this.listContacts.length;F++){thistag=this.listContacts[F];if(thistag.tag==C){if(E==""||E==thistag.email){return }else{if(E!=""&&thistag.email==""){this.removeTagLI(F)}}}}this.listContacts[this.nTagCount]=this.generateJSONTagItem(this.nTagCount.toString(),C,E,D,G);this.listContactCache.push(this.listContacts[this.nTagCount].key);this.appendTagLI(this.nTagCount,this.listContacts[this.nTagCount]);this.bIncludesContact=this.bIncludesContact||E!="";this.nTagCount++}};var B={};Controller.create("TaggingDialogController",A,B)})();var PBTag=Class.create({name:"",tag:"",email:"",url:"",contact:false,id:false,mediaUrl:null,p1x:0,p1y:0,p2y:1,p2x:1,boxId:"",initialize:function(A){A=A||{};for(var B in A){this[B]=A[B]}if(this.tag){this.name=this.tag}else{if(this.name){this.tag=this.name}}if(this.contact_address_id){this.contact=this.contact_address_id}else{if(this.contact){this.contact_address_id=this.contact}}if(this.tag_id){this.id=this.tag_id}pbType=PBTag.TYPE},toJSON:function(){var A={id:this.id,tag:this.name,url:this.url,p1x:this.p1x,p1y:this.p1y,p2x:this.p2x,p2y:this.p2y,boxId:this.boxId};return Object.toJSON(A)},toPageTagConfig:function(){var A={tag_id:this.id,url:this.url,tag:this.name,p1x:this.p1x,p1y:this.p1y,p2x:this.p2x,p2y:this.p2y,boxId:this.boxId};return A}});PBTag=Object.extend(PBTag,{TYPE:"PBTag",validate:function(A){if(A.pbType!=PBTag.TYPE){A=new PBTag(A)}return A}});(function(){var A={hidden_input:null,input_div:null,display_div:null,mediaUrl:null,albumUrl:null,bEmpty:true,index:null,tagCache:null,tokenCache:null,tagContainerId:"listCurrentTags",initialize:function($super,E,H,G,D){$super(E,H,G,D);this.hidden_input=new HiddenInput("hidden_input_"+D.index,this);this.input_div=$("autocomplete_input_"+D.index);this.display_div=$("autocomplete_display_"+D.index);this.mediaUrl=D.mediaUrl;this.index=D.index;this.albumUrl=D.albumUrl;this.tagCache=new Hash();this.tokenCache=new Hash();this.editor=$("tageditor_"+D.index);this.tagListContainer=this.editor.down(".listCurrentTags");this.tokenizer=this.editor.down(".inlineTagEditor");this.input=this.tokenizer.down(".autocomplete_input");D.tags=D.tags||[];D.tags.each(function(I){this.addTokenToList(I);this.tagCache.set(I.name,I);this.bEmpty=false}.bind(this));if(TagEditorController.getInstance().tagCache.values().length>0){this.onDataChange()}var C=this.editor.down(".linkAddTag");if(C){C.observe("click",this.tagImageHandler.curry(true).bind(this))}var F=this.editor.down(".okEditTag");if(F){F.observe("click",this.tagImageHandler.curry(false).bind(this))}Event.observe(document,TagEditorController.EVENT.NEW_DATA,this.onDataChange.bindAsEventListener(this));Event.observe(document,TagEditorController.EVENT.TAG_EMPTY,this.removeHasTags.bindAsEventListener(this));Event.observe(document,TagEditorController.EVENT.TAG_ADDED,this.addHasTags.bindAsEventListener(this))},destroy:function(){this.onTagSaved=new function(){};this.onTagDeleted=new function(){};this.tagCache=new Hash();this.tokenCache=new Hash()},onDataChange:function(D){var C=TagEditorController.getInstance().tagCache;this.options.array=C.values();this.updateOptions()},onBlur:function($super,D){var C=this.element.value.strip().sub(",","");if(!this.active&&this.addNewToken(C)){this.element.value="";this.set_input_size()}$super()},addNewToken:function(E){if(E.length==0){return false}var C=new PBTag({tag:E,mediaUrl:this.mediaUrl});var D=this.addTokenToList(C);D.saveTag();document.fire(Autocompleter.LocalTags.EVENT.TAG_CREATED,C);return true},updateElement:function(F){var D=Element.readAttribute(F,"value");var C=this.options.array[D];C.mediaUrl=this.mediaUrl;var E=this.addTokenToList(C);E.saveTag()},onTagSaved:function(D){this.tagCache.set(D.tag.name,D.tag);var E=D.html;if(E){var C=this.tagListContainer.down(".tagListContainer");C.innerHTML=C.innerHTML.strip()+E.strip()}document.fire(Autocompleter.LocalTags.EVENT.TAG_ADDED,D);document.fire("editor:changed")},onTagDeleted:function(D){var C=new PBTag(D);this.bEmpty=(this.tagCache.values().length==1);this.tagCache.unset(C.name);this.tokenCache.unset(C.name);var E=$("tag_"+C.id);Element.remove(E);document.fire(Autocompleter.LocalTags.EVENT.TAG_REMOVED,{tag:C});document.fire("editor:changed");this.updateOptions()},addTokenToList:function(C){this.bEmpty=false;this.input_div.value="";var D={tag:C,hidden_input:this.hidden_input,onDelete:this.onTagDeleted.bind(this),onSave:this.onTagSaved.bind(this),mediaUrl:this.mediaUrl,albumUrl:this.albumUrl,isFirst:(this.tagCache.values().length==0)};var E=new TagToken(D);if(this.display_div.parentNode==null){this.display_div=$(this.display_div.id)}this.display_div.insert({before:E.element});this.tokenCache.set(C.name,E);this.updateOptions();return E},markPrevious:function(){if(this.index>0){this.index--}else{this.index=this.entryCount-1}this.scrollIntoView(this.getEntry(this.index),false)},markNext:function(){if(this.index<this.entryCount-1){this.index++}else{this.index=0}this.scrollIntoView(this.getEntry(this.index),true)},scrollIntoView:function(D,C){if(!PB.Util.Visibility.inView(D)){var E=Element.getHeight(D);if(C){window.scrollBy(0,E)}else{window.scrollBy(0,-E)}}},findToken:function(C){var D=this.tokenCache.get(C.name);return D},updateOptions:function(){var D=TagEditorController.getInstance().tagCache.values();if(D.length>0){var C=new Hash();D.each(function(E){C.set(E.name,E)});this.tokenCache.keys().each(function(E){C.unset(E)});this.options.array=C.values()}},onKeyPress:function($super,C){switch(C.keyCode){case 220:Event.stop(C);return ;default:$super(C)}},tagImageHandler:function(C){if(C){tr("fullview_click_tag");this.tagListContainer.hide();this.tokenizer.show();this.input.focus()}else{this.tokenizer.hide();this.tagListContainer.show()}},addHasTags:function(){var C=this.editor.down(".linkAddTag");if(C){C.addClassName("hasTags")}},removeHasTags:function(){var C=this.editor.down(".linkAddTag");if(C){C.removeClassName("hasTags")}}};var B={EVENT:{TAG_ADDED:"Autocompleter.LocalTags:TAG_ADDED",TAG_CREATED:"Autocompleter.LocalTags:TAG_CREATED",TAG_REMOVED:"Autocompleter.LocalTags:TAG_REMOVED"}};Autocompleter.LocalTags=Class.create(Autocompleter.LocalAdvanced,A);Autocompleter.LocalTags=Object.extend(Autocompleter.LocalTags,B)})();var TagEditorController;(function(){var A={data:null,fetching:false,tagCache:new Hash(),tagContainerId:null,tagListClassName:null,editors:new Hash(),trackingPageName:null,tags:new Hash(),initialize:function(){Event.observe(document,PB.EVENT.PAGE_LOADED,this.fetchData.bindAsEventListener(this));Event.observe(document,TagEditorController.EVENT.OPEN_ADVANCED,voidAdvancedTagging.bindAsEventListener(this));Event.observe(document,Autocompleter.LocalTags.EVENT.TAG_ADDED,this.addTag.bindAsEventListener(this));Event.observe(document,Autocompleter.LocalTags.EVENT.TAG_REMOVED,this.removeTag.bindAsEventListener(this));Event.observe(document,TagToken.EVENT.ADD,this.trackTagging.curry("add").bind(this));Event.observe(document,TagToken.EVENT.REMOVE,this.trackTagging.curry("remove").bind(this));Event.observe(document,Autocompleter.LocalTags.EVENT.TAG_CREATED,this.onTagCreated.bindAsEventListener(this))},mixIn:function(C){for(var D in C){this[D]=C[D]}}voidAdvancedTagging:function(E){var C=E.memo;var D={contentUrl:"?action=taggingdialog",parameters:C,cache:false,onComplete:this.lightboxLoaded.curry(C).bindAsEventListener(this)};document.fire(PBLightbox.EVENT.ACTIVATE,D);this.onCloseHandler=this.onCloseAdvancedTagging.curry(C.index).bindAsEventListener(this);this.onAdvTaggingAdd=this.onAddAdvancedTagging.curry(C.index).bindAsEventListener(this);this.onAdvTaggingRemove=this.onRemoveAdvancedTagging.curry(C.index).bindAsEventListener(this);Event.observe(document,PBLightbox.EVENT.DEACTIVATED,this.onCloseHandler);Event.observe(document,TagToken.EVENT.ADD,this.onAdvTaggingAdd);Event.observe(document,TagToken.EVENT.REMOVE,this.onAdvTaggingRemove);if(this.trackingPageName){APIRequest.track(this.trackingPageName+"void")}},onTagCreated:function(D){var C=D.memo;this.tagCache.set(C.name,C);document.fire(TagEditorController.EVENT.NEW_DATA)},onCloseAdvancedTagging:function(C,D){Event.stopObserving(document,PBLightbox.EVENT.DEACTIVATED,this.onCloseHandler);Event.stopObserving(document,TagToken.EVENT.ADD,this.onAdvTaggingAdd);Event.stopObserving(document,TagToken.EVENT.REMOVE,this.onAdvTaggingRemove)},onAddAdvancedTagging:function(D,F){var E=this.getEditor(D);var C=F.memo.tag;E.addTokenToList(C);E.onTagSaved(F.memo)},onRemoveAdvancedTagging:function(D,G){var F=this.getEditor(D);var C=PBTag.validate(G.memo);var E=F.findToken(C);E.removeElement();F.onTagDeleted(G.memo)},lightboxLoaded:function(C,E){var D=TagLightboxController.getInstance();D.initializeObject("containerTagImage_TaggingDialog","imageTag_TaggingDialog","imageTag_TaggingDialog")},fetchData:function(C){if(!this.fetching&&this.albumUrl){new Ajax.Request(this.albumUrl,{method:"post",parameters:{action:"tagsummary"},evalJSON:"force",onSuccess:this.handleFetchedData.bindAsEventListener(this)});this.fetching=true}},handleFetchedData:function(C){if(C.responseJSON.response){var E=C.responseJSON.response;var D=[];if(E.stat=="ok"&&E.items){E.items.each(function(F){D[D.length]=new PBTag(F)})}this.tagCache=new Hash();D.each(function(F){this.tagCache.set(F.name,F)}.bind(this));document.fire(TagEditorController.EVENT.NEW_DATA)}this.fetching=false},addEditor:function(C){var D=new Autocompleter.LocalTags("autocomplete_input_"+C.index,"autocomplete_populate_"+C.index,this.tagCache.values(),{frequency:0.1,search_field:"name",tags:C.tags,index:C.index,mediaUrl:C.mediaUrl,albumUrl:C.albumUrl,forceSuggestions:false});this.editors.set("aclt_"+C.index,D);this.tags=new Hash();C.tags.each(function(E){this.tags.set(E.name,E)}.bind(this))},getEditor:function(C){return this.editors.get("aclt_"+C)},removeEditor:function(C){return this.editors.unset("aclt_"+C)},addTag:function(D){var C=D.memo.tag;if(C){this.tagCache.set(C.name,C);this.tags.set(C.name,C)}document.fire(TagEditorController.EVENT.TAG_ADDED)},removeTag:function(D){var C=D.memo.tag;if(C){this.tagCache.unset(C.name,C);this.tags.unset(C.name,C)}if(jq.isEmptyObject(this.tags._object)){document.fire(TagEditorController.EVENT.TAG_EMPTY)}},trackTagging:function(D){if(this.trackingPageName){var C=this.trackingPageName+"_click_";C+=(PBLightbox.getInstance().panel.active)?"lightbox":"inline";C+="_tag_"+D;APIRequest.track(C)}}};var B={EVENT:{NEW_DATA:"TagEditorController:NEW_DATA",OPEN_ADVANCED:"TagEditorController:OPEN_ADVANCED",TAGGING_EDITOR_CLOSED:"TagEditorController:TAGGING_EDITOR_CLOSED",TAG_EMPTY:"TagEditorController:TAG_EMPTY",TAG_ADDED:"TagEditorController:TAG_ADDED"}};Controller.create("TagEditorController",A,B)})();var TagToken;(function(){var A={isFirst:false,tag:null,initialize:function($super,C){for(var E in C){this[E]=C[E]}this.tag=PBTag.validate(this.tag);var D=C.element||TagToken.getTokenHtml(this.tag);$super(D,this.hidden_input);this.close=this.element.down(".x");if(this.close){this.removeTag=this.deleteTag.bindAsEventListener(this);Event.observe(this.close,"click",this.removeTag)}Event.observe(this.element,"mouseover",this.hover.curry(true).bindAsEventListener(this));Event.observe(this.element,"mouseout",this.hover.curry(false).bindAsEventListener(this))},hover:function(C){if(this.onHover){this.onHover(this.tag,C)}},saveTag:function(){var C={};C.action="mediatagadd";C.media=this.tag.mediaUrl;C.tag=this.tag.name;C.p1x=this.tag.p1x;C.p1y=this.tag.p1y;C.p2x=this.tag.p2x;C.p2y=this.tag.p2y;if(this.isFirst){C.isFirst=1}if(this.tag.contact){C.contact=this.tag.contact}new Ajax.Request(this.albumUrl,{method:"post",parameters:C,evalJSON:"force",onSuccess:function(E){var F=E.responseJSON.response;if(F.stat=="ok"){this.tag.id=F.tag_id;this.tag.boxId=F.boxId;var D={tag:this.tag,html:F.tagHtml};if(this.onSave){this.onSave(D)}document.fire(TagToken.EVENT.ADD,D)}else{document.fire(PBMessage.EVENT.NOTIFY,{id:"fullviewMessagePanel",gotoHash:true,message:new PBMessage({type:PBMessage.MESSAGE_TYPE.ERROR,title:"There was an error tagging your photo.",details:F.message})});this.removeElement();document.fire(TagToken.EVENT.REMOVE,this.tag)}}.bind(this)})},deleteTag:function(F){if(!this.tag){return }var D=jq("#formFullView");var C=D.attr("action");if(!C){return }this.removeElement();var E={};E.action="mediatagdelete";E.tagid=this.tag.id;new Ajax.Request(C,{method:"post",parameters:E,evalJSON:"force",onSuccess:function(G){var H=G.responseJSON.response;if(H.stat=="ok"){if(this.onDelete){this.onDelete(this.tag)}document.fire(TagToken.EVENT.REMOVE,this.tag)}}.bind(this)})},removeElement:function(){Event.stopObserving(this.close,"click",this.removeTag);Element.remove(this.element)},handleDelete:function(){this.deleteTag()}};var B={getTokenHtml:function(C){C=PBTag.validate(C);var E=[];E[E.length]=Builder.node("input",{type:"hidden",name:"tag_id",value:C.toJSON()});E[E.length]=C.name;E[E.length]=Builder.node("span",{"class":"x",onmouseout:"this.className='x'",onmouseover:"this.className='x_hover'"}," ");var D=Builder.node("a",{"class":"token",href:"javascript:void(0)",tabindex:"-1"},Builder.node("span",Builder.node("span",Builder.node("span",Builder.node("span",{},E)))));return D},EVENT:{ADD:"TagToken:ADD",REMOVE:"TagToken:REMOVE"}};TagToken=Class.create(Token,A);TagToken=Object.extend(TagToken,B)})();var CorePaginationController;(function(){var A={assetUrl:"/pbassets/",previousCssId:"#prevButton",nextCssId:"#nextButton",pageArrowId:".pagArrow",pageNumberCssId:".pagenumber",bindKeys:true,windowObj:null,preFetchedPage:null,hasFetched:false,fetchPrevious:false,mediaFilter:null,newest:null,tag:null,setId:null,filter:"",filterLimit:"",sortby:"",hasUnBinded:false,initialized:false,customMrecAdUrl:false,customHeaderAdUrl:false,defaultMrecAd:"",defaultHeaderAd:"",navTakeover:false,adRefreshTimerExpired:false,adTimer:null,adCount:0,adRefresh:{},isSearch:false,skipHistory:false,canWrite:false,searchTerm:null,contexttype:null,contexturl:null,objectsperpage:null,currentpage:null,totalpages:null,pagesperfetch:null,cache:null,cacheUpdate:{},initialize:function(){this.windowObj=(photobucket.browser.isIE)?jq(document):jq(window);this.headerAdContainer=jq("#bannerAd");this.mrecAdContainer=jq("#containerSqAd");this.initialized=true},nextPageHandler:function(C){this.updateContent("next")},previousPageHandler:function(C){this.updateContent("previous")},pageChangeHandler:function(D){var C=D.memo.page;if(C==this.currentpage){return }if(C==this.currentpage+1){this.updateContent("next");return }if(C==this.currentpage-1){this.updateContent("previous");return }},resetPage:function(C){this.skipHistory=true;this.pageChangeHandler({memo:{page:this.originalOffset}});this.skipHistory=false},appendExtraParams:function(){if(this.mediaFilter){return"&mediafilter="+this.mediaFilter}if(this.newest){return"&newest=1"}if(this.tag){return"&currenttag="+this.tag}if(this.filter){var C="&filter="+this.filter;if(this.filterLimit){C+="&filterLimit="+this.filterLimit}return C}if(this.sortby){return"&sortby="+this.sortby}if(this.setId){return"&setId="+this.setId}return""},notifyall:function(){this.buildUpdateObject();var D={cacheUpdate:this.cacheUpdate,currentpage:this.currentpage,totalpages:this.totalpages};if(this.isSearch){var E=this.cacheUpdate["1"].searchUrl+this.appendExtraParams();D.searchTerm=this.searchTerm}else{var E=this.cacheUpdate["1"].browseUrl+this.appendExtraParams()}if(!this.skipHistory&&_pb.history){_pb.history.add({o:this.currentpage,current:E})}var F=jq.Event(CorePaginationController.EVENT.UPDATE);F.memo=D;jq(document).trigger(F);document.fire(CorePaginationController.EVENT.UPDATE,D);this.adCount+=1;var C=this.cacheUpdate[1];if((C.headerAd&&C.mrecAd)||this.customMrecAdUrl){this.refreshAds(this.cacheUpdate[1])}else{if(this.adRefreshTimerExpired||(this.adCount==this.adRefresh.count)){this.refreshAds(this.cacheUpdate[1])}}},loaddisabledCache:function(F){for(var D in F){var E=F[D]["1"];if(E&&E.type=="image"){var C=new Image();C.src=E.src+((typeof (E.cacheBust)!="undefined")?"?t="+E.cacheBust:"")}}},mixIn:function(C){for(var D in C){this[D]=C[D]}if(C.cache){this.loaddisabledCache(C.cache)}this.cacheThresholdMin=this.cachestart;this.cacheThresholdMax=this.cacheend;this.originalOffset=this.currentpage;this.configureAdRefreshTimer()},buildUpdateObject:function(){this.cacheUpdate=this.cache[this.currentpage]},bindHandlers:function(){this.unBindHandlers();var C=this;jq(this.previousCssId).each(function(D){jq(this).bind("click",function(){if(!jq(this).hasClass("disabled")){C.updateContent("previous")}})});jq(this.nextCssId).each(function(D){jq(this).bind("click",function(){if(!jq(this).hasClass("disabled")){C.updateContent("next")}})});if(this.bindKeys){this.bindArrowKeys()}this.hasUnBinded=false},unBindHandlers:function(){var C=this.previousCssId+","+this.nextCssId;jq(C).each(function(D){jq(this).unbind("click")});if(this.bindKeys){this.unBindArrowKeys()}this.hasUnBinded=true},disableLinks:function(){jq(this.nextCssId).each(function(C){jq(this).attr("href","javascript:void(0)")});jq(this.previousCssId).each(function(C){jq(this).attr("href","javascript:void(0)")})},bindArrowKeys:function(){var C=this;this.windowObj.keyup(function(F){var E=(F.target.tagName=="INPUT"||F.target.tagName=="TEXTAREA"||F.target.tagName=="SELECT");var D=F.keyCode;if(D==37&&!E){if(C.currentpage<=2000){C.updateContent("previous")}}else{if(D==39&&!E){if(C.currentpage<2000){C.updateContent("next")}}}})},unBindArrowKeys:function(){this.windowObj.unbind("keyup")},enableLoader:function(){var D=jq("#containerMain").height();var C=jq("#containerMainLoader");C.css("height",D);C.show()},disableLoader:function(){var C=jq("#containerMainLoader");C.hide()},updateContent:function(E){var G=this.currentpage;if(E=="previous"&&this.currentpage>1){this.currentpage--}if(E=="next"&&this.currentpage<this.totalpages){this.currentpage++}var D=(this.currentpage<this.cacheThresholdMin||this.currentpage>this.cacheThresholdMax);if(E=="previous"&&D){this.enableLoader();this.unBindHandlers();this.cacheExpired=true}else{if(E=="next"&&D){this.enableLoader();this.unBindHandlers();this.cacheExpired=true}else{this.notifyall()}}var C=(this.cacheThresholdMin==1&&this.cacheThresholdMax==this.totalpages);if(!C&&!this.hasFetched){var H=this.cacheThresholdMin+3;var F=this.cacheThresholdMax-3;if(E=="next"&&this.currentpage==F&&this.cacheThresholdMax!=this.totalpages){this.preFetchedPage=this.cacheThresholdMax;this.updateCache(this.preFetchedPage);this.hasFetched=true}else{if(E=="previous"&&this.currentpage==H&&this.cacheThresholdMin!=1){this.preFetchedPage=this.cacheThresholdMin-1;this.fetchPrevious=true;this.updateCache(this.preFetchedPage);this.hasFetched=true}}}},updateCache:function(F){var D="/pbassets/index";var E={contexturl:this.contexturl,contexttype:this.contexttype+"_update",fetchprevious:this.fetchPrevious?1:0,offset:this.preFetchedPage,mediaFilter:this.mediaFilter?this.mediaFilter:"",newest:this.newest?this.newest:"",tag:this.tag?this.tag:"",canWrite:this.canWrite,filter:this.filter,filterLimit:this.filterLimit,sortby:this.sortby,setId:this.setId?this.setId:""};var C=this;jq.post(D,E,function(I){var G=C.cache;var H=I.response.cacheupdate;jq.extend(G,H);C.setCacheThresholds();C.disableLoader();if(C.cacheExpired){C.notifyall();C.cacheExpired=false}C.hasFetched=false;C.loaddisabledCache(H);if(C.hasUnBinded){C.bindHandlers()}},"json")},setCacheThresholds:function(){var C=this.cache;for(var D=this.preFetchedPage;D>=1;D--){if(D==1&&C[D]){this.cacheThresholdMin=1;break}else{if(C[D]){continue}this.cacheThresholdMin=D+1;break}}for(var D=this.preFetchedPage;D<=this.totalpages;D++){if(D==this.totalpages){this.cacheThresholdMax=(C[D])?this.totalpages:this.totalpages-1;break}else{if(C[D]){continue}this.cacheThresholdMax=D-1;break}}},configureAdRefreshTimer:function(){var C=this;var D=function(){C.adRefreshTimerExpired=true};this.adTimer=window.setInterval(D,this.adRefresh.time)},refreshAds:function(J){var G=Math.floor(Math.random()*9999999999)+111111;var N=this.mrecAdContainer.find("iframe");var K=this.headerAdContainer.find("iframe");if(N.length>0&&this.mrecAdContainer){if(J.mrecAd){var M=J.mrecAd}var D=N.attr("src");var E=this.regenAdUrl(D,G,M,"mrec",J.type);N=N.get(0);var L=(N.contentWindow||N.contentDocument);L.location.replace(E)}if(K.length>0&&this.headerAdContainer){if(J.headerAd){var C=J.headerAd}if(this.navTakeover){C=null}var D=K.attr("src");var E=this.regenAdUrl(D,G,C,"header",J.type);K=K.get(0);var I=(K.contentWindow||K.contentDocument);I.location.replace(E)}var H=jq("#rightModules .whatsnewRefresh");if(H.length>0){var F=jq("#whatsnew_area");if(F.length>0){var E="/whatsnewrefresh?area="+F.val()}else{var E="/whatsnewrefresh"}jq.get(E,function(O){jq(".whatsnewRefresh").html(O)})}this.adCount=0;this.adRefreshTimerExpired=false;window.clearInterval(this.adTimer);this.configureAdRefreshTimer()},regenAdUrl:function(D,E,F,I,K){if(F){if(I=="mrec"){this.customMrecAdUrl=true}else{if(I=="header"){this.customHeaderAdUrl=true}}return F}else{if(this.customMrecAdUrl&&I=="mrec"&&this.defaultMrecAd!=""){D=this.defaultMrecAd;this.customMrecAdUrl=false}else{if(this.customHeaderAdUrl&&I=="header"&&this.defaultHeaderAd!=""){if(!this.navTakeover){D=this.defaultHeaderAd}this.customHeaderAdUrl=false}}}var C=D.split("?");var L;if(K){if(K=="image"){K="image"}else{K="video"}L="fv_"+K}if(C.length==2){var J=C[0];var H=C[1].toQueryParams();var G=Math.floor(Math.random()*899999)+100000;H.redir=H.redir.replace(/random=\d+\//,"random="+G+"/");H.redir=H.redir.replace(/pageid=\d+\//,"pageid="+E+"/");if(L!=null){H.redir=H.redir.replace(/ptype=.+?\//,"ptype="+L+"/")}D=J+"?"+$H(H).toQueryString()}else{if(C.length==1){var J=C[0];var G=Math.floor(Math.random()*899999)+100000;D=J.replace(/random=\d+\//,"random="+G+"/");if(J.search(/pageid=/i)!=-1){D=D.replace(/pageid=\d+?\//,"pageid="+E+"/")}if(L!=null){D=D.replace(/ptype=.+?\//,"ptype="+L+"/")}}}return D}};var B={EVENT:{UPDATE:"CorePaginationController:update",UNBIND:"CorePaginationController:unbind",LOAD_CACHE:"CorePaginationController:loaddisabledcache"}};Controller.create("CorePaginationController",A,B)})();var PreviousNext=function(B,A){this.elt=B;this.currentPage=parseInt(B.attr("currentpage"));this.totalPages=parseInt(B.attr("totalpages"));this.bindToKeys=parseInt(B.attr("bindToKeys"));this.nextElt=B.find(".nextAjax");this.prevElt=B.find(".prevAjax");var D=B.attr("target");this.target=D;var C=this;this.nextElt.click(function(E){if(!C.nextElt.hasClass("disabled")){A.next(D)}E.preventDefault();return false});this.prevElt.click(function(E){if(!C.prevElt.hasClass("disabled")){A.prev(D)}E.preventDefault();return false});this.next=function(){this.currentPage++;this.updateStatus()};this.prev=function(){this.currentPage--;this.updateStatus()};this.updateStatus=function(E){if(this.currentPage==1){if(!this.prevElt.hasClass("disabled")){this.prevElt.addClass("disabled");this.prevElt.removeClass("blue")}}else{if(!this.prevElt.hasClass("blue")){this.prevElt.removeClass("disabled");this.prevElt.addClass("blue")}}if(this.currentPage==this.totalPages){if(!this.nextElt.hasClass("disabled")){this.nextElt.addClass("disabled");this.nextElt.removeClass("blue")}}else{if(!this.nextElt.hasClass("blue")){this.nextElt.removeClass("disabled");this.nextElt.addClass("blue")}}};this.bindKeyHandlers=function(){paginator.windowObj=(photobucket.browser.isIE)?jq(document):jq(window);paginator.windowObj.keyup(function(G){var F=(G.target.tagName=="INPUT"||G.target.tagName=="TEXTAREA"||G.target.tagName=="SELECT");var E=G.keyCode;if(E==37&&!F){if(paginator.currentPage!=1){A.goTo(paginator.currentPage-1,D)}}else{if(E==39&&!F){if(paginator.currentPage!=paginator.totalPages){A.goTo(paginator.currentPage+1,D)}}}})};this.unbindKeyHandlers=function(){paginator.windowObj.unbind("keyup")};if(this.bindToKeys=="1"){this.bindKeyHandlers();Event.observe(document,PBLightbox.EVENT.ACTIVATE,function(){paginator.unbindKeyHandlers()});Event.observe(document,PBLightbox.EVENT.DEACTIVATED,function(){paginator.bindKeyHandlers()})}};var PrevNextController;(function(){var A={controllList:null,targets:null,initialize:function(){},next:function(E){var C=this.targets[E];for(var D=0,B=C.length;D<B;++D){C[D].next()}$(document).fire(PageEvent.NEXT,{type:E})},prev:function(E){var C=this.targets[E];for(var D=0,B=C.length;D<B;++D){C[D].prev()}$(document).fire(PageEvent.PREVIOUS,{type:E})}};staticMembers={};Controller.create("PrevNextController",A,staticMembers)})();(function(){jq(document).ready(function(){if(typeof PaginationController!="undefined"){Event.observe(document,PaginationController.EVENT.ADREFRESH,function(){var B=jq("#whatsnew_area");if(B.length>0){var A="/whatsnewrefresh?area="+B.val()}else{var A="/whatsnewrefresh"}jq.get(A,function(C){jq(".whatsnewRefresh").html(C)})})}})})();var ZeroClipboard={version:"1.0.7",clients:{},moviePath:"ZeroClipboard.swf",nextId:1,setMoviePath:function(A){this.moviePath=A},dispatch:function(D,B,C){var A=this.clients[D];if(A){A.receiveEvent(B,C)}},register:function(B,A){this.clients[B]=A},Client:function(A){this.handlers={};this.id=ZeroClipboard.nextId++;this.movieId="ZeroClipboardMovie_"+this.id;ZeroClipboard.register(this.id,this);if(A){this.glue(A)}}};ZeroClipboard.Client.prototype={id:0,ready:false,movie:null,clipText:"",handCursorEnabled:true,cssEffects:false,handlers:null,appendElem:null,isThumb:false,div:null,glue:function(F,D,G){if(this.div){this.div.innerHTML=""}if(typeof (F)=="string"){this.domElement=document.getElementById(F);if(!this.domElement){return }}else{this.domElement=F}var H=99;if(this.domElement.style.zIndex){H=parseInt(this.domElement.style.zIndex,10)+1}if(typeof (D)=="string"){this.appendElem=document.getElementById(D)}else{this.appendElem=D}this.clipText=G;var C="";if(this.isThumb){var B=160;var A=23}else{var B="100%";var A="100%"}var E=jq(this.appendElem).find(".ccplaceholder");this.div=E[0];this.div.innerHTML=this.getHTML(B,A,G)},getHTML:function(D,A,E){var C="";var B="id="+this.id+"&text="+escape(escape(E));if(photobucket.browser.isIE){var F="httpdisabled://";C+='<objectdisabled classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="'+F+'downloaddisabled.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+D+'" height="'+A+'" id="'+this.movieId+'" align="middle"><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+ZeroClipboard.moviePath+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+B+'"/><param name="wmode" value="transparent"/></object>'}else{C+='<embeddisabled id="'+this.movieId+'" src="'+ZeroClipboard.moviePath+'" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+D+'" height="'+A+'" name="'+this.movieId+'" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="httpdisabled://www.macromedia.com/go/getflashplayer" flashvars="'+B+'" wmode="transparent" />'}return C},setText:function(A){},setHandCursor:function(A){this.handCursorEnabled=A;if(this.ready){this.movie.setHandCursor(A)}},addEventListener:function(A,B){A=A.toString().toLowerCase().replace(/^on/,"");if(!this.handlers[A]){this.handlers[A]=[]}this.handlers[A].push(B)},receiveEvent:function(D,E){D=D.toString().toLowerCase().replace(/^on/,"");switch(D){case"loaddisabled":this.movie=document.getElementById(this.movieId);if(!this.movie){var C=this;setTimeout(function(){C.receiveEvent("loaddisabled",null)},1);return }if(!this.ready&&navigator.userAgent.match(/Firefox/)&&navigator.userAgent.match(/Windows/)){var C=this;setTimeout(function(){C.receiveEvent("loaddisabled",null)},100);this.ready=true;return }this.ready=true;break}if(this.handlers[D]){for(var B=0,A=this.handlers[D].length;B<A;B++){var F=this.handlers[D][B];if(typeof (F)=="function"){F(this,E)}else{if((typeof (F)=="object")&&(F.length==2)){F[0][F[1]](this,E)}else{if(typeof (F)=="string"){window[F](this,E)}}}}}},setIsThumb:function(){this.isThumb=true}};ZeroClipboard.setMoviePath("httpdisabled://pic.pbsrc.com/flash/ZeroClipboardFV2.swf");var CopyCodeController;(function(){var A={clients:{},createZeroClipboard:function(H,G){var C=deconcept.SWFObjectUtil.getPlayerVersion();if(G){jq("#"+H).click(function(){jq(this).select()})}else{if(C.major>=9){var F="clip"+H;var D;if(this.clients[H]){D=this.clients[H]}else{D=new ZeroClipboard.Client();this.clients[H]=D}var E=jq("#"+H).val();D.glue("copycode_"+H,"zeroclipboard_"+H,E);D.addEventListener("onComplete",function(J,I){jq("#"+H).val("Copied").css("backgroundColor","#FFFF66").fadeTo("normal",0.4,function(){jq(this).fadeTo("normal",1,function(){jq(this).css("backgroundColor","#FFFFFF").val(E)})})})}else{jq("#"+H).click(function(){jq(this).select()})}}},hasClient:function(C){if(this.clients[C]){return true}return false}};var B={};Controller.create("CopyCodeController",A,B)})();